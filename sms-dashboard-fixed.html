<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#1e3a8a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="CodeLife SMS">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="description" content="CodeLife SMS - Professional SMS Management Platform with Voice Calls & WebRTC">
    <meta name="keywords" content="SMS, messaging, business, communication, voice calls, WebRTC, phone validation">
    
    <!-- iOS/iPadOS PWA Optimizations -->
    <meta name="format-detection" content="telephone=no">
    <meta name="msapplication-tap-highlight" content="no">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover, maximum-scale=1.0">
    
    <!-- iOS Status Bar -->
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <!-- iOS Splash Screens -->
    <link rel="apple-touch-startup-image" media="screen and (device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3)" href="/splash-1290x2796.png">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3)" href="/splash-1179x2556.png">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3)" href="/splash-1284x2778.png">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3)" href="/splash-1170x2532.png">
    <link rel="apple-touch-startup-image" media="screen and (device-height: 812px) and (-webkit-device-pixel-ratio: 3)" href="/splash-1125x2436.png">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2)" href="/splash-828x1792.png">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3)" href="/splash-1242x2688.png">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3)" href="/splash-1125x2436.png">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2)" href="/splash-750x1334.png">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2)" href="/splash-640x1136.png">
    
    <!-- iPad Splash Screens -->
    <link rel="apple-touch-startup-image" media="screen and (device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2)" href="/splash-2048x2732.png">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2)" href="/splash-1668x2388.png">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2)" href="/splash-1668x2224.png">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2)" href="/splash-1536x2048.png">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 1)" href="/splash-768x1024.png">
    
    <title>CodeLife SMS</title>
    <meta name="default-backend-base-url" content="https://f61659d2cb49.ngrok-free.app">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- Apple Touch Icon (installed app icon) -->
    <link rel="apple-touch-icon" href="/apple-touch-icon-180x180.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="167x167" href="/icon-167x167.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-180x180.png">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/icon-192x192.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@telnyx/webrtc@2.0.0/dist/telnyx-webrtc.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            margin: 0;
            padding: 0;
            color: #333;
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 250px;
            background: #1e3a8a;
            color: white;
            padding: 20px 0;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
            transition: transform 0.3s ease;
        }

        .sidebar-header {
            text-align: center;
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .logo {
            width: 60px;
            height: 60px;
            border-radius: 15px;
            margin: 0 auto 10px;
            display: block;
        }

        .sidebar-header h1 {
            font-size: 24px;
            margin: 10px 0 5px 0;
            color: white;
        }

        .app-subtitle {
            font-size: 14px;
            opacity: 0.8;
            color: #cbd5e1;
        }

        .nav-item {
            padding: 15px 20px;
            cursor: pointer;
            transition: background 0.3s ease;
            border-radius: 8px;
            margin: 5px 10px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .nav-item.active {
            background: rgba(255, 255, 255, 0.2);
        }

        .nav-item i {
            width: 20px;
            text-align: center;
        }

        .main-content {
            margin-left: 250px;
            flex: 1;
            padding: 20px;
            background: #f5f5f5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .content-section {
            display: none;
            background: white;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .content-section.active {
            display: block;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .card h3 {
            margin-bottom: 15px;
            color: #1e3a8a;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn {
            background: #1e3a8a;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            transition: background 0.3s ease;
        }

        .btn:hover {
            background: #1e40af;
        }

        .btn.secondary {
            background: #6b7280;
        }

        .btn.danger {
            background: #dc2626;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 5px;
            font-size: 14px;
        }

        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .status.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }

        .status.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        .status.info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }

        table th, table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        table th {
            background: #f9fafb;
            font-weight: 600;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 10px;
            width: 80%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        #messagesInterface {
            display: flex;
            height: 500px;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            overflow: hidden;
        }

        #conversationsList {
            width: 300px;
            border-right: 1px solid #e5e7eb;
            overflow-y: auto;
            background: #f9fafb;
        }

        .conversation-item {
            padding: 15px;
            border-bottom: 1px solid #e5e7eb;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .conversation-item:hover {
            background: #f3f4f6;
        }

        .conversation-item.active {
            background: #dbeafe;
            border-left: 4px solid #3b82f6;
        }

        #chatArea {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        #chatHeader {
            padding: 15px;
            background: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
            font-weight: 600;
        }

        #chatMessages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
        }

        /* Removed conflicting conversation-message styles - using iMessage styles below */

        #messageInputArea {
            padding: 15px;
            border-top: 1px solid #e5e7eb;
            display: none;
        }

        #quickMessageInput {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 20px;
            resize: none;
        }

        #sendQuickMessage {
            margin-top: 10px;
            padding: 8px 16px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
        }

        /* Mobile Navigation Toggle */
        .mobile-nav-toggle {
            display: none;
            position: fixed;
            top: 15px;
            left: 15px;
            z-index: 1001;
            background: #1e3a8a;
            color: white;
            border: none;
            padding: 12px 14px;
            border-radius: 12px;
            font-size: 18px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transition: all 0.2s ease;
        }
        
        .mobile-nav-toggle:hover {
            background: #1e40af;
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                width: 280px;
            }
            
            .sidebar.mobile-open {
                transform: translateX(0);
            }
            
            .mobile-nav-toggle {
                display: block;
            }
            
            .main-content {
                margin-left: 0;
                padding: 20px 15px;
                padding-top: 80px;
            }
            
            .container {
                padding: 10px;
            }
            
            .content-section {
                padding: 20px;
            }
            
            /* Mobile-friendly buttons */
            .btn {
                padding: 12px 20px;
                font-size: 16px;
                margin: 5px;
                min-height: 44px;
            }
            
            /* Mobile-friendly inputs */
            input, select, textarea {
                font-size: 16px;
                padding: 12px;
                min-height: 44px;
                -webkit-appearance: none;
                border-radius: 8px;
                border: 1px solid #d1d5db;
            }
            
            /* Mobile-friendly file inputs */
            input[type="file"] {
                padding: 8px;
                border: 2px dashed #d1d5db;
                border-radius: 8px;
                background: #f9fafb;
                cursor: pointer;
            }
            
            /* Touch-friendly buttons */
            .btn, button {
                min-height: 44px;
                min-width: 44px;
                touch-action: manipulation;
            }
            
            /* Mobile-friendly cards */
            .card {
                margin-bottom: 15px;
                border-radius: 12px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            }
            
            /* Mobile-friendly modals */
            .modal {
                padding: 20px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .modal-content {
                width: 95%;
                max-width: none;
                margin: 10px;
                border-radius: 12px;
                max-height: 90vh;
                overflow-y: auto;
            }
            
            /* Mobile-friendly conversation */
            .conversation-message {
                max-width: 85%;
                margin-bottom: 8px;
                padding: 12px 16px;
                border-radius: 18px;
                word-wrap: break-word;
            }
            
            /* Pull to refresh indicator */
            .pull-refresh {
                text-align: center;
                padding: 20px;
                color: #6b7280;
                display: none;
            }
        }

        /* iOS Safe Area Support */
        @supports (padding: max(0px)) {
            .main-content {
                padding-left: max(20px, env(safe-area-inset-left));
                padding-right: max(20px, env(safe-area-inset-right));
                padding-bottom: max(20px, env(safe-area-inset-bottom));
            }
            
            .mobile-nav-toggle {
                top: max(20px, env(safe-area-inset-top) + 10px);
                left: max(20px, env(safe-area-inset-left) + 10px);
            }
        }

        /* Desktop Layout - Original Style */
        .main-content {
            margin-left: 250px;
            flex: 1;
            padding: 30px;
            background: #f5f5f5;
            overflow-y: auto;
        }

        .content-section {
            display: none;
            padding: 20px;
        }

        .content-section.active {
            display: block;
        }

        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .card h3 {
            margin: 0 0 20px 0;
            font-size: 20px;
            font-weight: 600;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .card h3 i {
            color: #3b82f6;
            font-size: 18px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
            margin: 5px;
            transition: background-color 0.3s;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-warning {
            background: #f59e0b;
            color: white;
        }

        .btn-warning:hover {
            background: #d97706;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .status {
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
        }

        .status.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }

        .status.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        .status.warning {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fde68a;
        }

        .status.info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #bfdbfe;
        }

        /* Grid Layouts */
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 24px;
        }

        .grid-4 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 24px;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: white;
            padding: 24px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid #e5e7eb;
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
        }

        .stat-number {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .stat-label {
            color: #6b7280;
            font-size: 14px;
            font-weight: 500;
        }

        /* Message Lists */
        .message-list {
            background: white;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            overflow: hidden;
        }

        .message-item {
            padding: 16px 20px;
            border-bottom: 1px solid #f3f4f6;
            display: flex;
            align-items: center;
            gap: 16px;
            transition: background-color 0.2s;
        }

        .message-item:hover {
            background: #f9fafb;
        }

        .message-item:last-child {
            border-bottom: none;
        }

        .message-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: #3b82f6;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 18px;
        }

        .message-content {
            flex: 1;
        }

        .message-name {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 4px;
        }

        .message-text {
            color: #6b7280;
            font-size: 14px;
            line-height: 1.4;
        }

        .message-time {
            color: #9ca3af;
            font-size: 12px;
            margin-top: 4px;
        }

        .sidebar-header {
            padding: 0 20px 20px 20px;
            border-bottom: 1px solid #3b82f6;
            margin-bottom: 20px;
            text-align: center;
        }

        .logo-container {
            margin-bottom: 15px;
        }

        .logo {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #3b82f6;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .sidebar-header h1 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 600;
        }

        .sidebar-header .app-subtitle {
            margin-top: 5px;
            font-size: 0.9rem;
            opacity: 0.8;
            color: #93c5fd;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            color: white;
            text-decoration: none;
            transition: all 0.3s ease;
            margin: 2px 0;
            border-radius: 8px;
            margin: 2px 10px;
        }

        .nav-item:hover {
            background: #3b82f6;
        }

        .nav-item.active {
            background: #3b82f6;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }

        .nav-item i {
            margin-right: 12px;
            width: 20px;
            text-align: center;
        }

        .main-content {
            margin-left: 250px;
            flex: 1;
            padding: 30px;
            background: white;
            min-height: 100vh;
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        .card {
            background: white;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .card h3 {
            color: #1e3a8a;
            margin-bottom: 20px;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 15px;
            font-size: 1.25rem;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #374151;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .btn:hover {
            background: #2563eb;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .btn-success {
            background: #10b981;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-warning {
            background: #f59e0b;
        }

        .btn-warning:hover {
            background: #d97706;
        }

        .btn-danger {
            background: #ef4444;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: 600;
        }

        .status.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }

        .status.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        .status.info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #bfdbfe;
        }

        .message-item {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .message-item:hover {
            background: #f9fafb;
        }

        .message-phone {
            font-weight: 600;
            color: #374151;
            margin-bottom: 5px;
        }

        .message-preview {
            color: #6b7280;
            margin-bottom: 5px;
        }

        .message-time {
            font-size: 12px;
            color: #9ca3af;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e5e7eb;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: #667eea;
            width: 0%;
            transition: width 0.3s;
        }

        .file-upload {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.3s;
        }

        .file-upload:hover {
            border-color: #667eea;
        }

        .file-upload input[type="file"] {
            display: none;
        }

        /* iOS/iPadOS PWA Optimizations */
        @supports (-webkit-touch-callout: none) {
            /* iOS-specific styles */
            body {
                -webkit-font-smoothing: antialiased;
                -moz-osx-font-smoothing: grayscale;
                -webkit-tap-highlight-color: transparent;
                -webkit-touch-callout: none;
                -webkit-user-select: none;
                user-select: none;
            }
            
            /* Prevent zoom on input focus */
            input, textarea, select {
                font-size: 16px !important;
                -webkit-appearance: none;
                border-radius: 0;
            }
            
            /* iOS button optimizations */
            button {
                -webkit-appearance: none;
                -webkit-tap-highlight-color: transparent;
            }
            
            /* iOS scroll optimizations */
            .sidebar, #conversationsList, #chatMessages {
                -webkit-overflow-scrolling: touch;
                scroll-behavior: smooth;
            }
        }
        
        /* iPad-specific optimizations */
        @media (min-width: 768px) and (max-width: 1024px) {
            .sidebar {
                width: 280px;
            }
            
            .main-content {
                margin-left: 280px;
            }
            
            .card {
                margin-bottom: 20px;
                border-radius: 12px;
            }
            
            .btn {
                padding: 12px 20px;
                font-size: 16px;
            }
        }
        
        /* iPhone landscape optimizations */
        @media (max-width: 896px) and (orientation: landscape) {
            .sidebar {
                width: 200px;
            }
            
            .main-content {
                margin-left: 200px;
            }
            
            .sidebar-header h1 {
                font-size: 18px;
            }
            
            .nav-item {
                padding: 10px 15px;
                font-size: 14px;
            }
        }
        
        /* Mobile-specific dashboard improvements */
        @media (max-width: 768px) {
                    /* Mobile layout - hide sidebar, show content full width */
        .sidebar {
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            z-index: 1001;
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: 280px;
        }
        
        .sidebar.mobile-open {
            transform: translateX(0);
        }
            
            .main-content {
                margin-left: 0 !important;
                width: 100% !important;
                padding: 10px;
                padding-top: 0 !important; /* Let search sit directly under fixed top bar */
            }
            
            /* Show ONLY the active section on mobile */
            .content-section {
                display: none !important;
                width: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
            }
            
            .content-section.active {
                display: block !important;
            }
            
            /* iOS-like chat styling for mobile */
            body, .main-content { background: #ffffff !important; font-family: Arial, Helvetica, sans-serif !important; }
            #messagesInterface { background: transparent !important; border: none !important; border-radius: 0 !important; display: block !important; }
            #incoming { background: #ffffff !important; }
            #messagesContainer { background: #ffffff !important; }
            #chatMessages { padding: 14px !important; text-align: left !important; }
            #chatMessages .conversation-message { display: flex !important; margin: 6px 0 !important; }
            #chatMessages .conversation-message .message-content { max-width: 80% !important; padding: 9px 12px !important; border-radius: 18px !important; line-height: 1.35 !important; }
            #chatMessages .conversation-message.incoming { justify-content: flex-start !important; }
            #chatMessages .conversation-message.incoming .message-content { background: #e9ecef !important; color: #111827 !important; border-radius: 18px 18px 18px 4px !important; }
            #chatMessages .conversation-message.outgoing { justify-content: flex-end !important; }
            #chatMessages .conversation-message.outgoing .message-content { background: #007aff !important; color: #ffffff !important; border-radius: 18px 18px 4px 18px !important; }
            /* iOS spacing between bubbles */
            #chatMessages .conversation-message .message-content { margin: 2px 0 !important; box-shadow: none !important; }
            #chatMessages .message-time { display: block !important; font-size: 11px !important; color: #9ca3af !important; margin-top: 4px !important; }
            #messageInputArea { display: block !important; background: #ffffff !important; border-top: 1px solid #e5e7eb !important; }
            #quickMessageInput { background: #f2f2f7 !important; color: #111827 !important; border-radius: 18px !important; }
            
            /* Clean header and toolbar */
            #incoming .card { background: transparent !important; box-shadow: none !important; padding: 0 !important; border-radius: 0 !important; }
            #incoming h3 { display: none !important; }
            /* Top app bar */
            #mobileTopBar { position: fixed; top: 0; left: 0; right: 0; z-index: 30; height: 52px; background: #ffffff; display: flex; align-items: center; justify-content: center; color: #111827; font-weight: 600; font-size: 18px; border-bottom: 1px solid #e5e7eb; }
            .ios-top-bar { padding: 0 12px; }
            .ios-title { text-align: center; flex: 1; font-weight: 700; }
            .ios-left, .ios-right { display: flex; gap: 12px; align-items: center; }
            .ios-left { justify-content: flex-start; }
            .ios-right { justify-content: flex-end; }
            .ios-icon-btn { background: transparent; border: none; color: #111827; width: 36px; height: 36px; border-radius: 18px; display: inline-flex; align-items: center; justify-content: center; }
            .ios-icon-btn i { font-size: 18px; }

            /* Search bar */
            #iosSearchBar { padding: 8px 12px; background: #ffffff; border-bottom: none; margin-top: 0 !important; position: static !important; top: auto !important; z-index: auto !important; }
            #conversationsList, #iosSearchBar, #messagesInterface { margin-top: 0 !important; }
            #iosSearchBar .search-wrap { display: flex; align-items: center; gap: 8px; background: #f2f2f7; border-radius: 12px; padding: 8px 10px; }
            #iosSearchBar i { color: #9ca3af; }
            #iosSearchBar input { flex: 1; border: none; outline: none; background: transparent; color: #111827; font-size: 14px; }

            /* Bottom nav */
            #mobileBottomNav { position: fixed; left: 0; right: 0; bottom: 0; height: 56px; background: #ffffff; border-top: 1px solid #e5e7eb; display: flex; align-items: center; justify-content: space-around; z-index: 20; }
            #mobileBottomNav .bn-item { display: flex; flex-direction: column; align-items: center; gap: 3px; color: #6b7280; font-size: 11px; }
            #mobileBottomNav .bn-item i { font-size: 18px; }
            #mobileBottomNav .bn-item.active { color: #007aff; }

            /* Allow normal body scroll */
            body { overflow-y: auto !important; height: auto !important; }
            
            /* Single scroll container under fixed bars */
            #incoming { padding-top: 52px !important; padding-bottom: 56px !important; min-height: 100dvh !important; overflow-y: auto !important; -webkit-overflow-scrolling: touch !important; }
            #messagesInterface { 
                height: auto !important; 
                border: none !important; 
                border-radius: 0 !important; 
                background: #ffffff !important;
                overflow: visible !important;
                position: static !important;
                contain: none !important;
            }
            #chatHeader { top: 52px !important; }
            /* Remove any absolute overlays that could block the list */
            .card[style*='position: absolute'], .card[style*='fixed'] { position: static !important; }
            #mobileHeaderLogo { display: none !important; }

            /* Disable any resize handles / swipe UI */
            .resize-handle, .resize-handle-vertical, .resize-handle-horizontal, .resize-handle-corner { display: none !important; }
            #messagesToolbar { display: none !important; }
            
            /* Default: show list, hide chat - WITH ISOLATED SCROLL */
            #conversationsList { 
                display: block !important; 
                background: #ffffff !important; 
                width: 100% !important; 
                border-right: none !important; 
                position: relative !important;
                overflow: visible !important;
                z-index: 1 !important;
                padding: 0 !important;
                transform: none !important;
                will-change: auto !important;
                contain: none !important;
            }
            #chatArea { 
                display: none !important; 
                width: 100% !important; 
                position: relative !important;
                z-index: 1 !important;
                overflow-y: auto !important;
                -webkit-overflow-scrolling: touch !important;
            }
            /* When in chat view */
            #messagesInterface.show-chat #conversationsList { display: none !important; }
            #messagesInterface.show-chat #chatArea { display: flex !important; flex-direction: column !important; height: calc(100dvh - 52px - 56px) !important; }
            /* Flex scroll area */
            #messagesInterface.show-chat #messagesContainer { flex: 1 !important; overflow-y: auto !important; -webkit-overflow-scrolling: touch !important; position: static !important; padding: 10px 12px !important; background: #ffffff !important; }
            #chatHeader { position: static !important; height: auto !important; z-index: auto !important; background: #ffffff !important; border-bottom: 1px solid #e5e7eb !important; }
            #messageInputArea { position: static !important; z-index: auto !important; }
            /* Ensure no stray containers cover messages */
            #incomingMessagesList, #sentMessagesList, #messagesToolbar, .resize-handle, .resize-handle-corner { display: none !important; }
            #chatHeader * { color: #111827 !important; }
            #mobileBackButton { display: none; background: transparent; border: none; color: #111827; font-size: 22px; width: 44px; height: 44px; border-radius: 22px; align-items: center; justify-content: center; }
            #messagesInterface.show-chat #mobileBackButton { display: inline-flex; }

            /* Kill any card overlays in vertical mode */
            .messages-interface-resizable { border: none !important; border-radius: 0 !important; background: transparent !important; }
            #incoming .card { background: transparent !important; border: none !important; box-shadow: none !important; border-radius: 0 !important; }
            
            /* Hide legacy message containers that may render large empty white blocks */
            #incomingMessagesList, #sentMessagesList, #modalMessagesContainer { display: none !important; height: 0 !important; overflow: hidden !important; }
            
            /* Mobile navigation toggle */
            .mobile-nav-toggle {
                display: block !important;
                position: fixed;
                top: 15px;
                left: 15px;
                z-index: 1002;
                background: #1e3a8a;
                border: none;
                color: white;
                padding: 12px;
                border-radius: 8px;
                font-size: 20px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.2);
                cursor: pointer;
                min-width: 44px;
                min-height: 44px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            /* Dashboard card improvements */
            #dashboard .card {
                margin-bottom: 20px;
                border-radius: 12px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            }
            
            #dashboard .card h3 {
                font-size: 18px;
                margin-bottom: 15px;
                padding-bottom: 8px;
                border-bottom: 2px solid #f1f5f9;
            }
            
            /* System status improvements */
            #systemStatus {
                padding: 12px;
                border-radius: 8px;
                margin-bottom: 12px;
                font-size: 14px;
            }
            
            /* Business hours status improvements */
            #business-hours-status {
                padding: 12px;
                border-radius: 8px;
                margin: 12px 0;
                font-size: 13px;
                line-height: 1.5;
            }
            
            /* URL display improvements */
            #dashboard .card div[style*="margin-top: 15px"] {
                background: #f8fafc;
                padding: 10px 12px;
                border-radius: 6px;
                font-size: 12px;
                line-height: 1.4;
                border: 1px solid #e2e8f0;
                word-break: break-all;
            }
            
            /* Phone numbers section improvements */
            #phoneNumbersList {
                max-height: 250px;
                overflow-y: auto;
            }
            
            /* Form improvements */
            .form-group {
                margin-bottom: 15px;
            }
            
            .form-group label {
                display: block;
                margin-bottom: 5px;
                font-weight: 600;
                font-size: 14px;
            }
            
            .form-group input,
            .form-group select,
            .form-group textarea {
                width: 100%;
                padding: 10px;
                border: 1px solid #d1d5db;
                border-radius: 6px;
                font-size: 16px;
                background: white;
            }
            
            /* Button improvements */
            .btn {
                padding: 12px 20px;
                font-size: 14px;
                border-radius: 6px;
                margin: 5px 0;
                width: 100%;
                text-align: center;
            }
            
            .btn-group {
                display: flex;
                flex-direction: column;
                gap: 8px;
                margin: 15px 0;
            }
            
            .btn-group .btn {
                flex: none;
                width: 100%;
            }
            
            /* Status message improvements */
            .status {
                padding: 12px;
                border-radius: 6px;
                margin: 10px 0;
                font-size: 14px;
            }
            
            .status small {
                display: block;
                margin-top: 6px;
                font-size: 12px;
                opacity: 0.8;
            }
            
            /* Card improvements */
            .card {
                padding: 15px;
                margin-bottom: 15px;
                border-radius: 10px;
                box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            }
            
            /* Messages interface mobile */
            #messagesInterface {
                height: 400px;
                flex-direction: column;
            }
            
            #conversationsList {
                width: 100%;
                height: 150px;
                border-right: none;
                border-bottom: 1px solid #e5e7eb;
            }
            
            #chatArea {
                flex: 1;
                height: 250px;
            }
            
            /* File upload improvements */
            .file-upload {
                padding: 20px;
                border: 2px dashed #d1d5db;
                border-radius: 8px;
                text-align: center;
                background: #f9fafb;
                margin: 10px 0;
            }
            
            /* Progress bar improvements */
            .progress-bar {
                height: 8px;
                background: #e5e7eb;
                border-radius: 4px;
                overflow: hidden;
                margin: 10px 0;
            }
            
            .progress-fill {
                height: 100%;
                background: #3b82f6;
                transition: width 0.3s ease;
            }
            
            /* Mobile-friendly spacing */
            .mobile-margin {
                margin: 10px 0;
            }
            
            .mobile-padding {
                padding: 10px;
            }
            
            /* Hide desktop-specific elements on mobile */
            .desktop-only {
                display: none !important;
            }
            
            /* Mobile sidebar backdrop */
            .sidebar-backdrop {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                z-index: 1000;
            }
            
            .sidebar-backdrop.active {
                display: block;
            }
        }

        /* FORCE iMessage-style conversation message styles with maximum specificity */
        #chatMessages .conversation-message,
        .conversation-message {
            margin-bottom: 6px !important;
            display: flex !important;
            padding: 0 4px !important;
            position: relative !important;
            max-width: none !important;
            border-radius: 0 !important;
            background: transparent !important;
            color: inherit !important;
            align-self: unset !important;
            margin-left: unset !important;
        }

        #chatMessages .conversation-message.incoming,
        .conversation-message.incoming {
            justify-content: flex-start !important;
            background: transparent !important;
            align-self: unset !important;
        }

        #chatMessages .conversation-message.outgoing,
        .conversation-message.outgoing {
            justify-content: flex-end !important;
            background: transparent !important;
            align-self: unset !important;
            margin-left: unset !important;
        }

        #chatMessages .message-content,
        .message-content {
            max-width: var(--message-max-width, 70%) !important;
            min-width: var(--message-min-width, fit-content) !important;
            width: var(--message-width, fit-content) !important;
            padding: var(--message-padding, 3px 7px) !important;
            border-radius: var(--message-border-radius, 15px) !important;
            position: relative !important;
            font-size: var(--message-font-size, 12px) !important;
            line-height: var(--message-line-height, 1.3) !important;
            word-wrap: break-word !important;
            font-weight: var(--message-font-weight, 400) !important;
            letter-spacing: var(--message-letter-spacing, 0) !important;
            margin: 0 !important;
            display: inline-block !important;
            color: #ffffff !important;
        }

        #chatMessages .conversation-message.incoming .message-content,
        .conversation-message.incoming .message-content {
            background: #3a3a3c !important;
            color: #ffffff !important;
            border-bottom-left-radius: 3px !important;
            margin-left: 2px !important;
        }

        #chatMessages .conversation-message.outgoing .message-content,
        .conversation-message.outgoing .message-content {
            background: #007aff !important;
            color: #ffffff !important;
            border-bottom-right-radius: 3px !important;
            margin-right: 2px !important;
        }

        #chatMessages .message-text,
        .message-text {
            margin-bottom: 0 !important;
            word-wrap: break-word !important;
            white-space: pre-wrap !important;
            color: #ffffff !important;
        }

        #chatMessages .message-time,
        .message-time {
            font-size: 7px !important;
            opacity: 0.6 !important;
            margin-top: 1px !important;
            text-align: right !important;
            font-weight: 400 !important;
        }

        #chatMessages .conversation-message.incoming .message-time,
        .conversation-message.incoming .message-time {
            text-align: left !important;
        }

        /* Authentic iMessage bubble tails with higher specificity */
        #chatMessages .conversation-message.incoming .message-content::before,
        .conversation-message.incoming .message-content::before {
            content: '' !important;
            position: absolute !important;
            left: -4px !important;
            bottom: 0 !important;
            width: 0 !important;
            height: 0 !important;
            border: 4px solid transparent !important;
            border-right-color: #3a3a3c !important;
            border-left: 0 !important;
            border-bottom: 0 !important;
        }

        #chatMessages .conversation-message.outgoing .message-content::after,
        .conversation-message.outgoing .message-content::after {
            content: '' !important;
            position: absolute !important;
            right: -4px !important;
            bottom: 0 !important;
            width: 0 !important;
            height: 0 !important;
            border: 4px solid transparent !important;
            border-left-color: #007aff !important;
            border-right: 0 !important;
            border-bottom: 0 !important;
        }

        /* Group consecutive messages with higher specificity */
        #chatMessages .conversation-message.incoming + .conversation-message.incoming .message-content,
        .conversation-message.incoming + .conversation-message.incoming .message-content {
            border-bottom-left-radius: 3px !important;
        }

        #chatMessages .conversation-message.incoming + .conversation-message.incoming .message-content::before,
        .conversation-message.incoming + .conversation-message.incoming .message-content::before {
            display: block !important;
        }

        #chatMessages .conversation-message.outgoing + .conversation-message.outgoing .message-content,
        .conversation-message.outgoing + .conversation-message.outgoing .message-content {
            border-bottom-right-radius: 3px !important;
        }

        #chatMessages .conversation-message.outgoing + .conversation-message.outgoing .message-content::after,
        .conversation-message.outgoing + .conversation-message.outgoing .message-content::after {
            display: block !important;
        }

        /* Timestamp styling for grouped messages with higher specificity */
        #chatMessages .conversation-message.incoming + .conversation-message.incoming .message-time,
        .conversation-message.incoming + .conversation-message.incoming .message-time {
            display: block !important;
        }

        #chatMessages .conversation-message.outgoing + .conversation-message.outgoing .message-time,
        .conversation-message.outgoing + .conversation-message.outgoing .message-time {
            display: block !important;
        }

        .conversation-item {
            padding: 10px 16px;
            height: 70px;
            border-bottom: 1px solid #e5e7eb;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
            background: #ffffff;
        }

        .conversation-item:hover {
            background-color: #f2f2f7;
        }

        .conversation-item.active {
            background-color: #e6f0ff;
            color: #111827;
        }

        .conversation-item .contact-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #f59e0b;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
            flex-shrink: 0;
        }

        .conversation-item .contact-info {
            flex: 1;
            min-width: 0;
        }

        .conversation-item .contact-name {
            font-weight: 600;
            color: #111827;
            margin-bottom: 2px;
            font-size: 15px;
        }

        .conversation-item .contact-phone {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 4px;
        }

        .conversation-item .last-message {
            font-size: 13px;
            color: #6b7280;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

.conversation-item.active .contact-name,
        .conversation-item.active .contact-phone,
        .conversation-item.active .last-message {
            color: #111827;
        }

        .unread-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #007aff;
            display: inline-block;
            flex-shrink: 0;
        }

        /* Resize Handle Styles */
        .resize-handle {
            position: absolute;
            background: transparent;
            z-index: 10;
        }

        .resize-handle-vertical {
            width: 6px;
            height: 100%;
            right: 0;
            top: 0;
            cursor: col-resize;
            background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.1) 50%, transparent 100%);
            transition: background 0.2s ease;
        }

        .resize-handle-vertical:hover {
            background: linear-gradient(90deg, transparent 0%, rgba(0,122,255,0.3) 50%, transparent 100%);
        }

        .resize-handle-horizontal {
            width: 100%;
            height: 6px;
            left: 0;
            bottom: 0;
            cursor: row-resize;
            background: linear-gradient(180deg, transparent 0%, rgba(255,255,255,0.1) 50%, transparent 100%);
            transition: background 0.2s ease;
        }

        .resize-handle-horizontal:hover {
            background: linear-gradient(180deg, transparent 0%, rgba(0,122,255,0.3) 50%, transparent 100%);
        }

        .resize-handle-corner {
            width: 12px;
            height: 12px;
            right: 0;
            bottom: 0;
            cursor: nw-resize;
            background: radial-gradient(circle at center, rgba(0,122,255,0.2) 0%, transparent 70%);
            transition: background 0.2s ease;
        }

        .resize-handle-corner:hover {
            background: radial-gradient(circle at center, rgba(0,122,255,0.4) 0%, transparent 70%);
        }

        .resizable {
            position: relative;
            min-width: 300px;
            min-height: 400px;
        }

        .resizable.resizing {
            user-select: none;
        }

        .resizable.resizing * {
            pointer-events: none;
        }

        /* Chat interface specific resize styles */
        .messages-interface-resizable {
            position: relative;
            resize: both;
            overflow: hidden;
            min-width: 600px;
            min-height: 400px;
            max-width: 95vw;
            max-height: 80vh;
        }

        .conversations-list-resizable {
            position: relative;
            min-width: 250px;
            max-width: 500px;
        }
        /* Desktop iMessage-like styling */
        @media (min-width: 769px) {
            #messagesInterface { border: 1px solid #e5e7eb; border-radius: 12px; }
            #conversationsList { background: #f2f2f7; border-right: 1px solid #e5e7eb; }
            #iosListHeader { display: flex; align-items: center; justify-content: space-between; padding: 14px 12px; background: #f2f2f7; border-bottom: 1px solid #e5e7eb; }
            #iosListHeader .title { font-size: 28px; font-weight: 700; color: #111827; }
            #iosListHeader .left, #iosListHeader .right { font-size: 14px; color: #007aff; }
            #iosSearchBar { padding: 10px 12px; background: #f2f2f7; border-bottom: 1px solid #e5e7eb; }
            #iosSearchBar .search-wrap { background: #ffffff; border-radius: 10px; padding: 8px 10px; }
            .conversation-item { background: #ffffff; }
            .conversation-item.active { background: #e5e5ea; }
            #chatHeader { background: #ffffff; border-bottom: 1px solid #e5e7eb; }
            #messageInputArea { background: #ffffff; border-top: 1px solid #e5e7eb; }
        }
    </style>
</head>

    <body>
        <!-- Mobile Navigation Toggle -->
        <button class="mobile-nav-toggle" onclick="toggleMobileNav()">
            <i class="fas fa-bars"></i>
        </button>
        
        <!-- Mobile Centered Header Logo -->
        <div id="mobileHeaderLogo" style="display:none; position:fixed; top:16px; left:0; right:0; z-index:1002; text-align:center; pointer-events:none;">
            <img src="IMG_0179.PNG" alt="CodeLife SMS" style="height:28px; width:28px; border-radius:6px; vertical-align:middle;">
            <span style="margin-left:8px; color:#fff; font-weight:600; font-size:16px; vertical-align:middle;">CodeLife SMS</span>
        </div>
        
        <!-- Mobile Overlay Menu (independent of desktop sidebar) -->
        <div id="mobileMenu" style="display:none; position:fixed; inset:0; z-index:1005;">
            <div id="mobileMenuBackdrop" style="position:absolute; inset:0; background:rgba(0,0,0,0.5);"></div>
            <div style="position:absolute; top:0; right:0; width:78%; max-width:320px; height:100%; background:#1e3a8a; color:#fff; padding:18px 12px; overflow:auto; box-shadow:-2px 0 10px rgba(0,0,0,0.2);">
                <div style="display:flex; align-items:center; justify-content:space-between; padding:6px 6px 12px 6px;">
                    <div style="display:flex; align-items:center; gap:8px;">
                        <img src="IMG_0179.PNG" alt="CodeLife SMS Logo" style="width:32px; height:32px; border-radius:8px;" />
                        <strong>CodeLife SMS</strong>
                    </div>
                    <button id="mobileMenuClose" style="background:transparent; border:none; color:#fff; font-size:20px;">✕</button>
                </div>
                <a href="#" class="nav-item" data-section="dashboard" onclick="showSection('dashboard', event)" style="display:flex; align-items:center; gap:10px; padding:12px 10px; border-radius:8px;"> <i class="fas fa-tachometer-alt"></i> Dashboard</a>
                <a href="#" class="nav-item" data-section="send-sms" onclick="showSection('send-sms', event)" style="display:flex; align-items:center; gap:10px; padding:12px 10px; border-radius:8px;"> <i class="fas fa-paper-plane"></i> Send SMS</a>
                <a href="#" class="nav-item" data-section="bulk-sms" onclick="showSection('bulk-sms', event)" style="display:flex; align-items:center; gap:10px; padding:12px 10px; border-radius:8px;"> <i class="fas fa-users"></i> Bulk SMS</a>
                <a href="#" class="nav-item" data-section="incoming" onclick="showSection('incoming', event)" style="display:flex; align-items:center; gap:10px; padding:12px 10px; border-radius:8px;"> <i class="fas fa-inbox"></i> Messages</a>
                <a href="#" class="nav-item" data-section="phone-validation" onclick="showSection('phone-validation', event)" style="display:flex; align-items:center; gap:10px; padding:12px 10px; border-radius:8px;"> <i class="fas fa-search"></i> Phone Validation</a>
                <a href="#" class="nav-item" data-section="voice-calls" onclick="showSection('voice-calls', event)" style="display:flex; align-items:center; gap:10px; padding:12px 10px; border-radius:8px;"> <i class="fas fa-phone"></i> Voice Calls</a>
                <a href="#" class="nav-item" data-section="webrtc-calls" onclick="showSection('webrtc-calls', event)" style="display:flex; align-items:center; gap:10px; padding:12px 10px; border-radius:8px;"> <i class="fas fa-headset"></i> WebRTC Calls</a>
                <a href="#" class="nav-item" data-section="settings" onclick="showSection('settings', event)" style="display:flex; align-items:center; gap:10px; padding:12px 10px; border-radius:8px;"> <i class="fas fa-cog"></i> API Settings</a>
                <a href="#" class="nav-item" data-section="bubble-settings" onclick="showSection('bubble-settings', event)" style="display:flex; align-items:center; gap:10px; padding:12px 10px; border-radius:8px;"> <i class="fas fa-expand-arrows-alt"></i> Bubble Settings</a>
                <div style="height:12px;"></div>
            </div>
        </div>
        
        <div class="sidebar">
        <div class="sidebar-header">
            <div class="logo-container">
                <img src="IMG_0179.PNG" alt="CodeLife SMS Logo" class="logo">
            </div>
            <h1>CodeLife SMS</h1>
            <p class="app-subtitle">Your SMS Management Platform</p>
        </div>

        <a href="#" class="nav-item active" onclick="showSection('dashboard', event)">
            <i class="fas fa-tachometer-alt"></i> Dashboard
        </a>
        <a href="#" class="nav-item" onclick="showSection('send-sms', event)">
            <i class="fas fa-paper-plane"></i> Send SMS
        </a>
        <a href="#" class="nav-item" onclick="showSection('bulk-sms', event)">
            <i class="fas fa-users"></i> Bulk SMS
        </a>
        <a href="#" class="nav-item" onclick="showSection('incoming', event)">
            <i class="fas fa-inbox"></i> Messages
        </a>
        <a href="#" class="nav-item" onclick="showSection('phone-validation', event)">
            <i class="fas fa-search"></i> Phone Validation
        </a>
        <a href="#" class="nav-item" onclick="showSection('voice-calls', event)">
            <i class="fas fa-phone"></i> Voice Calls
        </a>
        <a href="#" class="nav-item" onclick="showSection('webrtc-calls', event)">
            <i class="fas fa-headset"></i> WebRTC Calls
        </a>
        <a href="#" class="nav-item" onclick="showSection('settings', event)">
            <i class="fas fa-cog"></i> API Settings
        </a>
        <a href="#" class="nav-item" onclick="showSection('bubble-settings', event)">
            <i class="fas fa-expand-arrows-alt"></i> Bubble Settings
        </a>
    </div>

    <!-- Mobile Navigation Toggle -->
    <button class="mobile-nav-toggle" onclick="toggleMobileNav()" style="display: none;">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Mobile Sidebar Backdrop -->
    <div class="sidebar-backdrop" onclick="closeMobileNav()"></div>

    <div class="main-content">

        <!-- Dashboard Section -->
        <div id="dashboard" class="content-section active">
            <div class="card">
                <h3><i class="fas fa-chart-line"></i> System Status</h3>
                <div id="systemStatus" class="status info">
                    🔄 Checking system status...
                </div>
                <div id="business-hours-status" style="margin-top: 15px; padding: 10px; border-radius: 6px; background: #f8fafc; border: 1px solid #e2e8f0;"></div>
                <div style="margin-top: 15px;">
                    <strong>Backend URL:</strong> <span id="backendUrl"></span><br>
                    <strong>Webhook URL:</strong> <span id="webhookUrl"></span>
                </div>
                <script>
                    (function() {
                        const origin = window.location.origin;
                        const backendUrlEl = document.getElementById('backendUrl');
                        const webhookUrlEl = document.getElementById('webhookUrl');
                        if (backendUrlEl) backendUrlEl.textContent = origin + '/';
                        if (webhookUrlEl) webhookUrlEl.textContent = origin + '/webhook/sms';
                    })();
                </script>
            </div>

            <div class="card">
                <h3><i class="fas fa-phone"></i> Phone Numbers</h3>
                <div id="phoneNumbersList">
                    <div class="status info">Configure API key to view phone numbers</div>
                </div>
            </div>

            <!-- CSV Replies Summary -->
            <div class="card" id="csvRepliesCard" style="display: none;">
                <h3><i class="fas fa-users"></i> CSV Contact Replies</h3>
                <div id="csvRepliesList">
                    <div class="status info">No CSV contacts have replied yet</div>
                </div>
            </div>
        </div>

        <!-- Send SMS Section -->
        <div id="send-sms" class="content-section">
            <div class="card">
                <h3><i class="fas fa-paper-plane"></i> Send Message</h3>
                <div class="form-group">
                    <label>From Number:</label>
                    <select id="fromNumber">
                        <option value="">Select a number...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>To Number:</label>
                    <input type="text" id="toNumber" placeholder="+1234567890">
                </div>
                <div class="form-group">
                    <label>Message:</label>
                    <textarea id="message" rows="4" placeholder="Enter your message..."></textarea>
                    <div style="text-align: right; margin-top: 5px; color: #6b7280;">
                        <span id="charCount">0</span> characters
                    </div>
                </div>

                <!-- File Upload Section -->
                <div class="form-group">
                    <label>Attach File (Optional):</label>
                    <input type="file" id="fileUpload" accept="image/*,.pdf,.doc,.docx,.txt" style="margin-top: 5px;">
                    <div style="font-size: 12px; color: #6b7280; margin-top: 5px;">
                        Supported: Images, PDF, Word docs, Text files (Max 5MB)
                    </div>
                </div>

                <div style="margin-top: 20px;">
                    <div id="send-sms-business-hours-warning" style="display: none; margin-bottom: 15px; padding: 10px; border-radius: 6px; background: #fef2f2; border: 1px solid #fecaca; color: #dc2626;"></div>
                    <button class="btn btn-success" onclick="sendSingleSMS()">
                        <i class="fas fa-paper-plane"></i> Send SMS
                    </button>
                    <button class="btn btn-primary" onclick="sendMMS()" id="sendMMSButton" style="display: none;">
                        <i class="fas fa-image"></i> Send MMS
                    </button>
                    <button class="btn btn-info" onclick="makeCall()">
                        <i class="fas fa-phone"></i> Make Call
                    </button>
                </div>
                <div id="sendStatus"></div>
            </div>
        </div>

        <!-- Bulk SMS Section -->
        <div id="bulk-sms" class="content-section">
            <div class="card">
                <h3><i class="fas fa-users"></i> Bulk SMS via CSV</h3>

                <!-- CSV Files Upload -->
                <div class="form-group">
                    <label>Upload CSV Files:</label>
                    <div class="file-upload" onclick="document.getElementById('csvFile').click()">
                        <i class="fas fa-cloud-upload-alt"
                            style="font-size: 2rem; color: #667eea; margin-bottom: 10px;"></i>
                        <div>Click to upload CSV file</div>
                        <div style="font-size: 12px; color: #6b7280; margin-top: 5px;">
                            You can upload multiple CSV files. Should contain: phone, name, message (or similar columns)
                        </div>
                    </div>
                    <input type="file" id="csvFile" accept=".csv" onchange="handleCSVUpload(this)">
                </div>

                <!-- CSV Files List -->
                <div id="csvFilesList" style="margin: 15px 0;">
                    <label>Uploaded CSV Files:</label>
                    <div id="csvFilesContainer" style="margin-top: 10px;">
                        <div class="status info">No CSV files uploaded yet</div>
                    </div>
                </div>

                <!-- CSV Preview -->
                <div id="csvPreview" style="display: none;">
                    <h4>CSV Preview (Combined):</h4>
                    <div id="csvData"
                        style="max-height: 200px; overflow-y: auto; border: 1px solid #e5e7eb; padding: 10px; border-radius: 5px;">
                    </div>
                </div>

                <div class="form-group">
                    <label>Message Template:</label>
                    <textarea id="messageTemplate" rows="3" placeholder="Hello {name}, {message}"
                        oninput="updateMessagePreview()"></textarea>
                    <div id="csvColumns" style="margin-top: 10px; display: none;">
                        <label style="font-size: 12px; color: #6b7280; margin-bottom: 5px;">CSV Columns (click to
                            insert):</label>
                        <div id="columnButtons" style="display: flex; flex-wrap: wrap; gap: 5px;"></div>
                    </div>
                    <div id="messagePreview" style="margin-top: 10px; display: none;">
                        <label style="font-size: 12px; color: #6b7280; margin-bottom: 5px;">Preview (first row):</label>
                        <div id="previewText"
                            style="padding: 10px; background: #f3f4f6; border-radius: 5px; font-size: 14px; border-left: 3px solid #667eea;">
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Delay between messages (seconds):</label>
                    <input type="number" id="messageDelay" value="2" min="1" max="300" step="1">
                    <small style="color: #6b7280; font-size: 12px;">Set any delay from 1 to 300 seconds (5 minutes
                        max)</small>
                </div>

                <div id="bulk-sms-business-hours-warning" style="display: none; margin-bottom: 15px; padding: 10px; border-radius: 6px; background: #fef2f2; border: 1px solid #fecaca; color: #dc2626;"></div>
                <button class="btn btn-success" onclick="sendBulkSMS()" id="sendBulkBtn" disabled>
                    <i class="fas fa-paper-plane"></i> Send Bulk SMS
                </button>

                <div id="bulkProgress" style="display: none;">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressBar"></div>
                    </div>
                    <div id="progressText" style="text-align: center; margin-top: 5px;"></div>
                </div>
            </div>
        </div>

        <!-- Messages Section -->
        <div id="incoming" class="content-section">
            <div id="mobileTopBar" class="mobile-only ios-top-bar" style="display:none;">
                <div class="ios-left">
                    <button class="ios-icon-btn" onclick="toggleMobileNav()">☰</button>
                </div>
                <div class="ios-title">CodeLife SMS</div>
                <div class="ios-right">
                    <button class="ios-icon-btn"><i class="fas fa-search"></i></button>
                    <button class="ios-icon-btn"><i class="fas fa-edit"></i></button>
                </div>
            </div>
            <div class="card">
                <h3><i class="fas fa-comments"></i> Messages</h3>
                <div id="messagesToolbar" style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-secondary" onclick="showSection('dashboard')">
                        <i class="fas fa-arrow-left"></i> Back to App
                    </button>
                    <button class="btn" onclick="loadAllMessages()">
                        <i class="fas fa-sync"></i> Refresh
                    </button>
                    <button class="btn btn-success" onclick="startAutoRefresh()">
                        <i class="fas fa-play"></i> Auto Refresh
                    </button>
                    <button class="btn btn-warning" onclick="stopAutoRefresh()">
                        <i class="fas fa-stop"></i> Stop Auto
                    </button>
                    <button class="btn btn-danger" onclick="deleteAllMessages()">
                        <i class="fas fa-trash"></i> Clear All
                    </button>
                </div>
                
                <!-- Messages Interface -->
                <div id="messagesInterface" class="messages-interface-resizable" style="display: flex; height: 600px; border: none; border-radius: 0; overflow: hidden; background: #ffffff; font-family: Arial, Helvetica, sans-serif;">
                    <!-- Conversations List -->
                    <div id="conversationsList" class="conversations-list-resizable" style="width: 340px; border-right: 1px solid #e5e7eb; background: #f2f2f7; overflow-y: auto;">
                        <!-- iOS List Header (desktop) -->
                        <div id="iosListHeader" aria-label="Messages list header">
                            <div class="left" style="color:#007aff; font-weight:600; cursor:default;">Edit</div>
                            <div class="title">Messages</div>
                            <div class="right" title="New message" style="color:#007aff;">
                                <i class="fas fa-edit"></i>
                            </div>
                        </div>

                        <!-- iOS Search Bar -->
                        <div id="iosSearchBar">
                            <div class="search-wrap">
                                <i class="fas fa-search"></i>
                                <input type="text" placeholder="Search" />
                                <button onclick="refreshConversations()" style="background: transparent; border: none; color: #007aff; cursor: pointer; font-size: 14px; padding: 4px; margin-left: 8px;" title="Refresh conversations">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                                <button onclick="forceReloadMessagesFromServer()" style="background: transparent; border: none; color: #007aff; cursor: pointer; font-size: 14px; padding: 4px; margin-left: 4px;" title="Sync from web version">
                                    <i class="fas fa-download"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Conversations Container -->
                        <div id="conversationsContainer">
                            <div style="padding: 20px; text-align: center; color: #8e8e93;">
                                <i class="fas fa-comments" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                                No conversations yet
                            </div>
                        </div>
                        
                        <!-- Incoming Messages List -->
                        <div id="incomingMessagesList" style="display: none;">
                            <!-- Messages will be loaded here -->
                        </div>
                        
                        <!-- Sent Messages List -->
                        <div id="sentMessagesList" style="display: none;">
                            <!-- Sent messages will be loaded here -->
                        </div>
                    </div>
                    
                    <!-- Chat Area -->
                    <div id="chatArea" style="flex: 1; display: flex; flex-direction: column; height: calc(100dvh - 52px - 56px); background: #ffffff;">
                        <!-- Chat Header -->
                        <div id="chatHeader" style="padding: 12px 12px; border-bottom: 1px solid #e5e7eb; background: #ffffff; display: flex; align-items: center; gap: 8px;">
                            <button id="mobileBackButton" onclick="showChatListMobile()">‹</button>
                            <div id="chatHeaderContent" style="text-align: center; color: #111827; flex: 1; font-weight:600;">
                                CodeLife SMS
                            </div>
                            <div style="width:32px;"></div>
                        </div>
                        
                        <!-- Messages Container -->
                        <div id="messagesContainer" style="flex: 1; padding: 0; overflow-y: auto; -webkit-overflow-scrolling: touch; background: #ffffff;">
                            <div id="chatMessages" style="text-align: center; color: #8e8e93; padding: 20px;">
                                <i class="fas fa-comment-dots" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                                Messages will appear here
                            </div>
                        </div>
                        
                        <!-- Message Input -->
                        <div id="messageInputArea" style="padding: 10px 12px; border-top: 1px solid #e5e7eb; background: #ffffff; display: none;">
                            <div style="display: flex; gap: 10px; align-items: flex-end;">
                                <button style="width: 32px; height: 32px; background: transparent; border: none; color: #007aff; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-plus-circle" style="font-size: 20px;"></i>
                                </button>
                                <div style="flex: 1; position: relative;">
                                    <textarea id="quickMessageInput" placeholder="iMessage" rows="1" style="width: 100%; padding: 12px 40px 12px 15px; background: #f2f2f7; border: none; border-radius: 20px; color: #111827; font-family: inherit; font-size: 16px; resize: none; outline: none; min-height: 44px; max-height: 120px;"></textarea>
                                </div>
                                <button style="width: 32px; height: 32px; background: transparent; border: none; color: #007aff; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-microphone" style="font-size: 18px;"></i>
                                </button>
                                <button id="sendQuickMessage" onclick="sendQuickMessage()" style="width: 32px; height: 32px; background: transparent; border: none; color: #007aff; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-paper-plane" style="font-size: 16px;"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <!-- Corner Resize Handle for entire interface -->
                    <div class="resize-handle resize-handle-corner" onmousedown="/* disabled for static UI */ null"></div>
                </div>
            </div>
        </div>

        <!-- Phone Validation Section -->
        <div id="phone-validation" class="content-section">
            <div class="card">
                <h3><i class="fas fa-search"></i> Phone Number Validation</h3>
                            <p style="color: #6b7280; margin-bottom: 20px;">
                Check if phone numbers are VoIP, mobile, or landline using Twilio (recommended) or Telnyx Number Lookup API
            </p>
                
                <!-- API Selection -->
                <div style="margin-bottom: 20px;">
                    <label style="font-weight: 600; color: #374151; margin-bottom: 8px; display: block;">Select API:</label>
                    <div style="display: flex; gap: 15px; align-items: center;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                            <input type="radio" name="validationApi" value="twilio" checked style="margin: 0;">
                <span style="color: #059669; font-weight: 600;">Twilio</span>
                            <small style="color: #6b7280;">(Recommended - More reliable)</small>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="radio" name="validationApi" value="telnyx" style="margin: 0;">
                            <span style="color: #3b82f6; font-weight: 600;">Telnyx</span>
                            <small style="color: #6b7280;">(Requires API key)</small>
                        </label>
                    </div>
                </div>

                <!-- Twilio Credentials Configuration -->
                <div id="twilioCredentialsSection" style="margin-bottom: 20px;">
                    <label style="font-weight: 600; color: #374151; margin-bottom: 8px; display: block;">Twilio Account SID:</label>
                    <input type="password" id="twilioAccountSid" placeholder="Enter your Twilio Account SID" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; margin-bottom: 10px;">
                    
                    <label style="font-weight: 600; color: #374151; margin-bottom: 8px; display: block;">Twilio Auth Token:</label>
                    <input type="password" id="twilioAuthToken" placeholder="Enter your Twilio Auth Token" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;">
                    <small style="color: #6b7280; font-size: 12px; margin-top: 5px; display: block;">
                        Get your credentials from your <a href="https://console.twilio.com/" target="_blank" style="color: #3b82f6;">Twilio Console</a>
                    </small>
                </div>
                
                <!-- Single Number Validation -->
                <div style="margin-bottom: 30px;">
                    <h4 style="color: #374151; margin-bottom: 15px;">
                        <i class="fas fa-phone"></i> Single Number Validation
                    </h4>
                    <div class="form-group">
                        <label>Phone Number:</label>
                        <input type="text" id="singlePhoneNumber" placeholder="+1234567890" style="width: 100%;">
                    </div>
                    <button class="btn btn-primary" onclick="validateSingleNumber()">
                        <i class="fas fa-search"></i> Validate Number
                    </button>
                    <div id="singleValidationResult" style="margin-top: 15px;"></div>
                </div>

                <!-- Bulk Number Validation -->
                <div style="margin-bottom: 30px;">
                    <h4 style="color: #374151; margin-bottom: 15px;">
                        <i class="fas fa-list"></i> Bulk Number Validation
                    </h4>
                    <div class="form-group">
                        <label>Upload CSV with Phone Numbers:</label>
                        <div class="file-upload" onclick="document.getElementById('validationCsvFile').click()">
                            <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; color: #667eea; margin-bottom: 10px;"></i>
                            <div>Click to upload CSV file</div>
                            <div style="font-size: 12px; color: #6b7280; margin-top: 5px;">
                                CSV should contain a column with phone numbers
                            </div>
                        </div>
                        <input type="file" id="validationCsvFile" accept=".csv" onchange="handleValidationCsvUpload(this)">
                    </div>
                    <div id="validationCsvFilesList" style="margin: 15px 0;">
                        <label>Uploaded CSV Files:</label>
                        <div id="validationCsvFilesContainer" style="margin-top: 10px;">
                            <div class="status info">No CSV files uploaded yet</div>
                        </div>
                    </div>
                    <button class="btn btn-success" onclick="validateBulkNumbers()" id="validateBulkBtn" disabled>
                        <i class="fas fa-search"></i> Validate All Numbers
                    </button>
                    <div id="bulkValidationProgress" style="display: none; margin-top: 15px;">
                        <div class="progress-bar">
                            <div class="progress-fill" id="bulkValidationProgressBar"></div>
                        </div>
                        <div id="bulkValidationProgressText" style="text-align: center; margin-top: 5px;"></div>
                    </div>
                    <div id="bulkValidationResult" style="margin-top: 15px;"></div>
                </div>
            </div>
        </div>

        <!-- Voice Calls Section -->
        <div id="voice-calls" class="content-section">
            <div class="card">
                <h3><i class="fas fa-phone"></i> Voice Calls</h3>
                <p style="color: #6b7280; margin-bottom: 20px;">
                    Make outbound voice calls using Telnyx Voice API. Play pre-recorded audio messages to recipients.
                </p>

                <!-- Single Call Section -->
                <div style="margin-bottom: 30px;">
                    <h4 style="color: #374151; margin-bottom: 15px;">
                        <i class="fas fa-phone"></i> Single Call
                    </h4>
                    
                    <div class="form-group">
                        <label>From Number (Caller ID):</label>
                        <select id="callFromNumber" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;">
                            <option value="">Select your Telnyx number...</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>To Number (Destination):</label>
                        <input type="text" id="callToNumber" placeholder="+1234567890" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;">
                    </div>
                    
                    <div class="form-group">
                        <label>Audio Message URL (Optional):</label>
                        <input type="url" id="audioMessageUrl" placeholder="https://example.com/audio-message.mp3" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;">
                        <small style="color: #6b7280; font-size: 12px; margin-top: 5px; display: block;">
                            Optional: Enter the URL of your pre-recorded audio file (MP3, WAV, etc.) to play when the call is answered. Leave empty for a regular phone call.
                        </small>
                    </div>
                    
                    <button class="btn btn-primary" onclick="makeSingleCall()" id="makeCallBtn">
                        <i class="fas fa-phone"></i> Make Call
                    </button>
                    
                    <div id="singleCallResult" style="margin-top: 15px;"></div>
                </div>

                <!-- Bulk Calls Section -->
                <div style="margin-bottom: 30px;">
                    <h4 style="color: #374151; margin-bottom: 15px;">
                        <i class="fas fa-users"></i> Bulk Calls
                    </h4>
                    
                    <div class="form-group">
                        <label>Upload CSV with Phone Numbers:</label>
                        <div class="file-upload" onclick="document.getElementById('bulkCallsCsvFile').click()">
                            <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; color: #667eea; margin-bottom: 10px;"></i>
                            <div>Click to upload CSV file</div>
                            <div style="font-size: 12px; color: #6b7280; margin-top: 5px;">
                                CSV should contain a column with phone numbers
                            </div>
                        </div>
                        <input type="file" id="bulkCallsCsvFile" accept=".csv" onchange="handleBulkCallsCsvUpload(this)">
                    </div>
                    
                    <div id="bulkCallsCsvFilesList" style="margin: 15px 0;">
                        <label>Uploaded CSV Files:</label>
                        <div id="bulkCallsCsvFilesContainer" style="margin-top: 10px;">
                            <div class="status info">No CSV files uploaded yet</div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Delay Between Calls (seconds):</label>
                        <input type="number" id="callDelay" value="5" min="1" max="60" style="width: 100px; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;">
                        <small style="color: #6b7280; font-size: 12px; margin-left: 10px;">
                            Minimum 1 second to avoid rate limits
                        </small>
                    </div>
                    
                    <button class="btn btn-success" onclick="makeBulkCalls()" id="makeBulkCallsBtn" disabled>
                        <i class="fas fa-phone"></i> Start Bulk Calls
                    </button>
                    
                    <div id="bulkCallsProgress" style="display: none; margin-top: 15px;">
                        <div class="progress-bar">
                            <div class="progress-fill" id="bulkCallsProgressBar"></div>
                        </div>
                        <div id="bulkCallsProgressText" style="text-align: center; margin-top: 5px;"></div>
                    </div>
                    
                    <div id="bulkCallsResult" style="margin-top: 15px;"></div>
                </div>

                <!-- Call History Section -->
                <div>
                    <h4 style="color: #374151; margin-bottom: 15px;">
                        <i class="fas fa-history"></i> Call History
                    </h4>
                    
                    <div id="callHistoryContainer">
                        <div class="status info">No calls made yet</div>
                    </div>
                    
                    <button class="btn btn-secondary" onclick="clearCallHistory()" style="margin-top: 10px;">
                        <i class="fas fa-trash"></i> Clear History
                    </button>
                </div>
            </div>
        </div>

        <!-- WebRTC Calls Section -->
        <div id="webrtc-calls" class="content-section">
            <div class="card">
                <h3><i class="fas fa-headset"></i> WebRTC Calls</h3>
                <p style="color: #6b7280; margin-bottom: 20px;">
                    Receive and answer calls directly in your browser using Telnyx WebRTC SDK.
                </p>

                <!-- Connection Status -->
                <div style="margin-bottom: 30px;">
                    <h4 style="color: #374151; margin-bottom: 15px;">
                        <i class="fas fa-wifi"></i> Connection Status
                    </h4>
                    
                    <div id="webrtcStatus" class="status info">
                        <i class="fas fa-circle" style="color: #6b7280;"></i> Disconnected
                    </div>
                    
                    <div style="margin-top: 15px;">
                        <button class="btn btn-primary" onclick="connectWebRTC()" id="connectBtn">
                            <i class="fas fa-plug"></i> Connect to Telnyx
                        </button>
                        <button class="btn btn-secondary" onclick="disconnectWebRTC()" id="disconnectBtn" disabled>
                            <i class="fas fa-times"></i> Disconnect
                        </button>
                    </div>
                </div>

                <!-- Incoming Call Interface -->
                <div id="incomingCallInterface" style="display: none; margin-bottom: 30px;">
                    <h4 style="color: #374151; margin-bottom: 15px;">
                        <i class="fas fa-phone"></i> Incoming Call
                    </h4>
                    
                    <div id="incomingCallInfo" style="padding: 20px; background: #f3f4f6; border-radius: 8px; text-align: center;">
                        <div id="callerNumber" style="font-size: 24px; font-weight: bold; margin-bottom: 10px;">Unknown</div>
                        <div id="callStatus" style="color: #6b7280; margin-bottom: 20px;">Incoming call...</div>
                        
                        <div style="display: flex; gap: 15px; justify-content: center;">
                            <button class="btn btn-success" onclick="answerCall()" id="answerBtn">
                                <i class="fas fa-phone"></i> Answer
                            </button>
                            <button class="btn btn-danger" onclick="rejectCall()" id="rejectBtn">
                                <i class="fas fa-phone-slash"></i> Reject
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Active Call Interface -->
                <div id="activeCallInterface" style="display: none; margin-bottom: 30px;">
                    <h4 style="color: #374151; margin-bottom: 15px;">
                        <i class="fas fa-phone"></i> Active Call
                    </h4>
                    
                    <div id="activeCallInfo" style="padding: 20px; background: #f0fdf4; border-radius: 8px; text-align: center;">
                        <div id="activeCallerNumber" style="font-size: 24px; font-weight: bold; margin-bottom: 10px;">Unknown</div>
                        <div id="callDuration" style="color: #059669; margin-bottom: 20px;">00:00</div>
                        
                        <div style="display: flex; gap: 15px; justify-content: center;">
                            <button class="btn btn-danger" onclick="endCall()" id="endCallBtn">
                                <i class="fas fa-phone-slash"></i> End Call
                            </button>
                            <button class="btn btn-secondary" onclick="toggleMute()" id="muteBtn">
                                <i class="fas fa-microphone"></i> Mute
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Audio Controls -->
                <div style="margin-bottom: 30px;">
                    <h4 style="color: #374151; margin-bottom: 15px;">
                        <i class="fas fa-volume-up"></i> Audio Controls
                    </h4>
                    
                    <div class="form-group">
                        <label>Speaker Volume:</label>
                        <input type="range" id="speakerVolume" min="0" max="100" value="50" style="width: 100%;">
                        <div style="display: flex; justify-content: space-between; font-size: 12px; color: #6b7280;">
                            <span>0%</span>
                            <span id="speakerVolumeValue">50%</span>
                            <span>100%</span>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Microphone Volume:</label>
                        <input type="range" id="micVolume" min="0" max="100" value="50" style="width: 100%;">
                        <div style="display: flex; justify-content: space-between; font-size: 12px; color: #6b7280;">
                            <span>0%</span>
                            <span id="micVolumeValue">50%</span>
                            <span>100%</span>
                        </div>
                    </div>
                </div>

                <!-- Call Log -->
                <div>
                    <h4 style="color: #374151; margin-bottom: 15px;">
                        <i class="fas fa-history"></i> Call Log
                    </h4>
                    
                    <div id="webrtcCallLog" style="max-height: 300px; overflow-y: auto;">
                        <div class="status info">No calls yet</div>
                    </div>
                    
                    <button class="btn btn-secondary" onclick="clearWebRTCCallLog()" style="margin-top: 10px;">
                        <i class="fas fa-trash"></i> Clear Log
                    </button>
                </div>
            </div>
        </div>

        <!-- API Settings Section -->
        <div id="settings" class="content-section">
            <div class="card">
                <h3><i class="fas fa-cog"></i> API Configuration</h3>
                <div class="form-group">
                    <label>Telnyx API Key:</label>
                    <input type="password" id="apiKey" placeholder="Enter your Telnyx API key">
                </div>
                <div class="form-group">
                    <label>Webhook URL:</label>
                    <input type="url" id="webhookUrl" value="https://codelife-sms-app-48d5c9e059b8.herokuapp.com/webhook/sms" placeholder="Enter your webhook URL">
                </div>
                <button class="btn" onclick="testAPIConnection()">
                    <i class="fas fa-plug"></i> Test Connection
                </button>
                <button class="btn btn-info" onclick="testWebhookUrl()">
                    <i class="fas fa-link"></i> Test Webhook
                </button>
                <button class="btn btn-warning" onclick="copyWebhookUrl()">
                    <i class="fas fa-copy"></i> Copy Webhook URL
                </button>
                <button class="btn btn-success" onclick="saveSettings()">
                    <i class="fas fa-save"></i> Save Settings
                </button>
                <button class="btn btn-warning" onclick="clearSettings()">
                    <i class="fas fa-trash"></i> Clear Settings
                </button>
                <button class="btn btn-danger" onclick="clearContactDatabase()">
                    <i class="fas fa-user-times"></i> Clear Contact Database
                </button>
                <div id="apiStatus"></div>
            </div>
        </div>

        <!-- Bubble Settings Section -->
        <div id="bubble-settings" class="content-section">
            <div class="card">
                <h3><i class="fas fa-expand-arrows-alt"></i> Message Bubble Settings</h3>
                <p style="color: #6b7280; margin-bottom: 20px;">Customize the appearance of your message bubbles. Changes apply immediately.</p>
                
                <div class="form-group">
                    <label>Maximum Width (%):</label>
                    <input type="range" id="maxWidthSlider" min="10" max="80" value="70" oninput="updateBubbleSettings()">
<span id="maxWidthValue">70%</span>
                </div>
                
                <div class="form-group">
                    <label>Font Size (px):</label>
                    <input type="range" id="fontSizeSlider" min="10" max="20" value="12" oninput="updateBubbleSettings()">
                    <span id="fontSizeValue">12px</span>
                </div>
                
                <div class="form-group">
                    <label>Padding (px):</label>
                    <input type="range" id="paddingSlider" min="2" max="15" value="5" oninput="updateBubbleSettings()">
                    <span id="paddingValue">5px</span>
                </div>
                
                <div class="form-group">
                    <label>Border Radius (px):</label>
                    <input type="range" id="borderRadiusSlider" min="5" max="25" value="15" oninput="updateBubbleSettings()">
                    <span id="borderRadiusValue">15px</span>
                </div>
                
                <div class="form-group">
                    <label>Line Height:</label>
                    <input type="range" id="lineHeightSlider" min="1.0" max="2.0" step="0.1" value="1.3" oninput="updateBubbleSettings()">
                    <span id="lineHeightValue">1.3</span>
                </div>
                
                <div class="form-group">
                    <label>Message Spacing (px):</label>
                    <input type="range" id="spacingSlider" min="2" max="15" value="6" oninput="updateBubbleSettings()">
                    <span id="spacingValue">6px</span>
                </div>
                
                <div style="margin-top: 20px;">
                    <button class="btn btn-warning" onclick="resetBubbleSettings()">
                        <i class="fas fa-undo"></i> Reset to Default
                    </button>
                    <button class="btn btn-info" onclick="saveBubbleSettings()">
                        <i class="fas fa-save"></i> Save Settings
                    </button>
                </div>
                
                <div style="margin-top: 20px; padding: 15px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
                    <h4 style="margin-top: 0; color: #374151;">Preview:</h4>
                    <div id="bubblePreview" style="max-width: 300px;">
                        <div class="conversation-message incoming" style="margin-bottom: 6px;">
                            <div class="message-content" style="max-width: 70%; min-width: fit-content; width: fit-content; padding: 3px 7px; border-radius: 15px; font-size: 12px; line-height: 1.3; color: #ffffff; background: #3a3a3c;">
                                <div class="message-text">Hello! This is a preview message.</div>
                                <div class="message-time">Dec 15 2:30 PM</div>
                            </div>
                        </div>
                        <div class="conversation-message outgoing" style="margin-bottom: 6px; justify-content: flex-end;">
                            <div class="message-content" style="max-width: 70%; min-width: fit-content; width: fit-content; padding: 3px 7px; border-radius: 15px; font-size: 12px; line-height: 1.3; color: #ffffff; background: #007aff;">
                                <div class="message-text">Hi there! How are you?</div>
                                <div class="message-time">Dec 15 2:31 PM</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- Large Conversation Modal -->
    <div id="conversationModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 800px; height: 80%; background: #1c1c1e; border-radius: 12px; display: flex; flex-direction: column; overflow: hidden;">
            <!-- Modal Header -->
            <div id="modalHeader" style="padding: 20px; border-bottom: 1px solid #2c2c2e; background: #1c1c1e; display: flex; align-items: center; justify-content: space-between;">
                <div style="display: flex; align-items: center; gap: 15px; flex: 1;">
                    <div id="modalContactAvatar" style="width: 40px; height: 40px; border-radius: 50%; background: #007aff; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 16px;"></div>
                    <div>
                        <div id="modalContactName" style="font-weight: 600; color: #ffffff; font-size: 18px;"></div>
                        <div id="modalContactPhone" style="font-size: 14px; color: #8e8e93;"></div>
                    </div>
                </div>
                <div style="display: flex; gap: 15px; align-items: center;">
                    <button onclick="makeCallFromModal()" style="width: 40px; height: 40px; background: transparent; border: none; color: #007aff; cursor: pointer; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: background 0.2s;">
                        <i class="fas fa-video" style="font-size: 18px;"></i>
                    </button>
                    <button onclick="makeCallFromModal()" style="width: 40px; height: 40px; background: transparent; border: none; color: #007aff; cursor: pointer; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: background 0.2s;">
                        <i class="fas fa-phone" style="font-size: 18px;"></i>
                    </button>
                    <button onclick="closeConversationModal()" style="width: 40px; height: 40px; background: transparent; border: none; color: #8e8e93; cursor: pointer; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: background 0.2s;">
                        <i class="fas fa-times" style="font-size: 18px;"></i>
                    </button>
                </div>
            </div>
            
            <!-- Modal Messages Container -->
            <div id="modalMessagesContainer" style="flex: 1; padding: 0; overflow-y: auto; background: #000000;">
                <div id="modalChatMessages" style="padding: 20px;">
                    <!-- Messages will be loaded here -->
                </div>
            </div>
            
            <!-- Modal Message Input -->
            <div style="padding: 20px; border-top: 1px solid #2c2c2e; background: #1c1c1e;">
                <div style="display: flex; gap: 15px; align-items: flex-end;">
                    <button style="width: 40px; height: 40px; background: transparent; border: none; color: #007aff; cursor: pointer; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: background 0.2s;">
                        <i class="fas fa-plus-circle" style="font-size: 24px;"></i>
                    </button>
                    <div style="flex: 1; position: relative;">
                        <textarea id="modalMessageInput" placeholder="iMessage" rows="1" style="width: 100%; padding: 15px 50px 15px 20px; background: #2c2c2e; border: none; border-radius: 25px; color: #ffffff; font-family: inherit; font-size: 16px; resize: none; outline: none; min-height: 50px; max-height: 120px;"></textarea>
                    </div>
                    <button style="width: 40px; height: 40px; background: transparent; border: none; color: #007aff; cursor: pointer; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: background 0.2s;">
                        <i class="fas fa-microphone" style="font-size: 20px;"></i>
                    </button>
                    <button onclick="sendModalMessage()" style="width: 40px; height: 40px; background: transparent; border: none; color: #007aff; cursor: pointer; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: background 0.2s;">
                        <i class="fas fa-paper-plane" style="font-size: 18px;"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let phoneNumbers = [];
        let csvFiles = []; // Array to store multiple CSV files
        let csvData = []; // Combined data from all CSV files
        let contactDatabase = []; // Persistent contact database
        let isSendingBulk = false;
        let autoRefreshInterval = null;
        let apiKey = '';
        let isBackendConnected = false;
        let currentConversation = null; // Current selected conversation
        let allMessages = []; // Combined incoming and sent messages
        let incomingMessages = [];
        let sentMessages = [];
        // Per-conversation read state: { "+1xxxxxxxxxx": timestamp_ms }
        let conversationReadState = {};

        // Business hours configuration
        const BUSINESS_HOURS = {
            start: 9, // 9 AM
            end: 17,  // 5 PM
            timezone: 'America/New_York' // EST
        };

        // Resize functionality variables
        let isResizing = false;
        let resizeType = '';
        let startX = 0;
        let startY = 0;
        let startWidth = 0;
        let startHeight = 0;
        let startListWidth = 0;

        // Resize functions
        function startResize(event, type) {
            isResizing = true;
            resizeType = type;
            startX = event.clientX;
            startY = event.clientY;
            
            const messagesInterface = document.getElementById('messagesInterface');
            const conversationsList = document.getElementById('conversationsList');
            
            startWidth = messagesInterface.offsetWidth;
            startHeight = messagesInterface.offsetHeight;
            startListWidth = conversationsList.offsetWidth;
            
            messagesInterface.classList.add('resizing');
            
            document.addEventListener('mousemove', handleResize);
            document.addEventListener('mouseup', stopResize);
            
            event.preventDefault();
        }

        function handleResize(event) {
            if (!isResizing) return;
            
            const messagesInterface = document.getElementById('messagesInterface');
            const conversationsList = document.getElementById('conversationsList');
            
            const deltaX = event.clientX - startX;
            const deltaY = event.clientY - startY;
            
            if (resizeType === 'vertical') {
                // Resize conversations list width
                const newWidth = Math.max(250, Math.min(500, startListWidth + deltaX));
                conversationsList.style.width = newWidth + 'px';
            } else if (resizeType === 'corner') {
                // Resize entire interface
                const newWidth = Math.max(600, startWidth + deltaX);
                const newHeight = Math.max(400, startHeight + deltaY);
                
                messagesInterface.style.width = newWidth + 'px';
                messagesInterface.style.height = newHeight + 'px';
            }
        }

        function stopResize() {
            if (!isResizing) return;
            
            isResizing = false;
            resizeType = '';
            
            const messagesInterface = document.getElementById('messagesInterface');
            messagesInterface.classList.remove('resizing');
            
            document.removeEventListener('mousemove', handleResize);
            document.removeEventListener('mouseup', stopResize);
            
            // Save resize preferences to localStorage
            saveResizePreferences();
        }

        function saveResizePreferences() {
            const messagesInterface = document.getElementById('messagesInterface');
            const conversationsList = document.getElementById('conversationsList');
            
            const preferences = {
                interfaceWidth: messagesInterface.offsetWidth,
                interfaceHeight: messagesInterface.offsetHeight,
                listWidth: conversationsList.offsetWidth
            };
            
            localStorage.setItem('chatResizePreferences', JSON.stringify(preferences));
        }

        function loadResizePreferences() {
            const preferences = localStorage.getItem('chatResizePreferences');
            if (preferences) {
                try {
                    const prefs = JSON.parse(preferences);
                    const messagesInterface = document.getElementById('messagesInterface');
                    const conversationsList = document.getElementById('conversationsList');
                    
                    if (prefs.interfaceWidth) {
                        messagesInterface.style.width = prefs.interfaceWidth + 'px';
                    }
                    if (prefs.interfaceHeight) {
                        messagesInterface.style.height = prefs.interfaceHeight + 'px';
                    }
                    if (prefs.listWidth) {
                        conversationsList.style.width = prefs.listWidth + 'px';
                    }
                } catch (e) {
                    console.log('Could not load resize preferences:', e);
                }
            }
        }

        // Check if current time is within business hours
        function isBusinessHours() {
            const now = new Date();
            const estTime = new Date(now.toLocaleString("en-US", {timeZone: BUSINESS_HOURS.timezone}));
            const currentHour = estTime.getHours();
            return currentHour >= BUSINESS_HOURS.start && currentHour < BUSINESS_HOURS.end;
        }

        // Get next business day start time
        function getNextBusinessDay() {
            const now = new Date();
            const estTime = new Date(now.toLocaleString("en-US", {timeZone: BUSINESS_HOURS.timezone}));
            const tomorrow = new Date(estTime);
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(BUSINESS_HOURS.start, 0, 0, 0);
            return tomorrow;
        }

        // Format time for display
        function formatTime(date) {
            return date.toLocaleString("en-US", {
                timeZone: BUSINESS_HOURS.timezone,
                weekday: 'long',
                month: 'long',
                day: 'numeric',
                hour: 'numeric',
                minute: '2-digit',
                timeZoneName: 'short'
            });
        }

        // Show section (event optional for mobile overlay)
        function showSection(sectionId, evt) {
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });

            // Remove active class from all nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });

            // Show selected section
            document.getElementById(sectionId).classList.add('active');

            // Add active class to clicked nav item
            var srcEl = (evt && evt.target) ? evt.target : null;
            if (srcEl && typeof srcEl.closest === 'function') {
                var clicked = srcEl.closest('.nav-item');
                if (clicked) clicked.classList.add('active');
            } else {
                // Fallback: find nav by data attribute
                var candidate = document.querySelector('.nav-item[data-section="' + sectionId + '"]');
                if (candidate) candidate.classList.add('active');
            }

            // Update stats when dashboard is shown
            if (sectionId === 'dashboard') {
                updateStats();
            }

            // Ensure conversations list is loaded when Messages section is shown
            if (sectionId === 'incoming' || sectionId === 'messages') {
                ensureConversationsLoaded();
            }
        }

        // Mobile Navigation Toggle (overlay)
        function toggleMobileNav() {
            const menu = document.getElementById('mobileMenu');
            if (!menu) return;
            menu.style.display = (menu.style.display === 'none' || menu.style.display === '') ? 'block' : 'none';
        }

        function closeMobileNav() {
            const menu = document.getElementById('mobileMenu');
            if (menu) menu.style.display = 'none';
        }

        // Mobile overlay interactions
        document.addEventListener('DOMContentLoaded', function() {
            const backdrop = document.getElementById('mobileMenuBackdrop');
            const closeBtn = document.getElementById('mobileMenuClose');
            const headerLogo = document.getElementById('mobileHeaderLogo');
            if (headerLogo) {
                if (window.innerWidth <= 768) headerLogo.style.display = 'block';
                window.addEventListener('resize', function(){
                    headerLogo.style.display = (window.innerWidth <= 768) ? 'block' : 'none';
                });
            }
            // Show top bar title only on mobile
            const topBar = document.getElementById('mobileTopBar');
            if (topBar) {
                topBar.textContent = 'CodeLife SMS';
                const setBar = () => topBar.style.display = (window.innerWidth <= 768) ? 'flex' : 'none';
                setBar();
                window.addEventListener('resize', setBar);
            }
            if (backdrop) backdrop.addEventListener('click', closeMobileNav);
            if (closeBtn) closeBtn.addEventListener('click', closeMobileNav);
            document.querySelectorAll('#mobileMenu a.nav-item').forEach(function(item) {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const sectionId = this.getAttribute('data-section');
                    if (sectionId) {
                        if (typeof forceShowSection === 'function') {
                            forceShowSection(sectionId);
                        } else if (typeof showSection === 'function') {
                            showSection(sectionId, e);
                        }
                    }
                    closeMobileNav();
                });
            });
        });

        // Close mobile nav when clicking on nav items
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', function() {
                setTimeout(() => {
                    closeMobileNav();
                }, 300);
            });
        });

        // Handle mobile orientation changes
        window.addEventListener('orientationchange', function() {
            setTimeout(() => {
                // Reset inline display overrides and keep the active section visible
                document.querySelectorAll('.content-section').forEach(function(section){
                    if (!section.classList.contains('active')) {
                        section.style.display = '';
                    } else {
                        section.style.display = 'block';
                    }
                });
            }, 100);
        });

        // Prevent zoom on input focus for iOS
        if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
            const inputs = document.querySelectorAll('input, textarea, select');
            inputs.forEach(input => {
                input.addEventListener('focus', function() {
                    this.style.fontSize = '16px';
                });
                input.addEventListener('blur', function() {
                    this.style.fontSize = '';
                });
            });
            
            // Force load settings on iOS devices
            console.log('iOS device detected, forcing settings load...');
            setTimeout(() => {
                loadSettings();
                testAPIConnection();
            }, 1000);
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function () {
            // Auto-set backend from ?backend= URL param (persist to localStorage)
            try {
                const params = new URLSearchParams(window.location.search);
                const backendFromQuery = params.get('backend');
                if (backendFromQuery && /^https?:\/\//i.test(backendFromQuery)) {
                    localStorage.setItem('backendBaseUrl', backendFromQuery.replace(/\/$/, ''));
                    console.log('🔧 Backend base set from URL param:', backendFromQuery);
                }
            } catch (e) { /* no-op */ }

            // If no saved backend, try meta tag or global default, then persist
            try {
                if (!localStorage.getItem('backendBaseUrl')) {
                    const metaEl = document.querySelector('meta[name="default-backend-base-url"]');
                    const metaUrl = metaEl && typeof metaEl.content === 'string' ? metaEl.content.trim() : '';
                    const globalDefault = (typeof window !== 'undefined' && window.DEFAULT_BACKEND_BASE_URL && /^https?:\/\//i.test(window.DEFAULT_BACKEND_BASE_URL)) ? window.DEFAULT_BACKEND_BASE_URL.trim() : '';
                    const candidate = metaUrl && /^https?:\/\//i.test(metaUrl) ? metaUrl : (globalDefault || '');
                    if (candidate) {
                        localStorage.setItem('backendBaseUrl', candidate.replace(/\/$/, ''));
                        console.log('🔧 Backend base set from default configuration:', candidate);
                    }
                }
            } catch (_) { /* no-op */ }
            // Load read state
            loadConversationReadState();
            // Force load API settings on mobile
            if (window.innerWidth <= 768) {
                loadSettings();
                setTimeout(() => {
                    testAPIConnection();
                }, 1000);
            }
            // Load saved settings
            const savedApiKey = localStorage.getItem('telnyxApiKey');
            const savedWebhookUrl = localStorage.getItem('webhookUrl');
            const savedBackendBaseUrl = localStorage.getItem('backendBaseUrl');
            const savedPhoneNumbers = localStorage.getItem('telnyxPhoneNumbers');
            const savedContactDatabase = localStorage.getItem('contactDatabase');
            const savedTwilioAccountSid = localStorage.getItem('twilioAccountSid');
        const savedTwilioAuthToken = localStorage.getItem('twilioAuthToken');

            if (savedApiKey) {
                document.getElementById('apiKey').value = savedApiKey;
                apiKey = savedApiKey;
            }
            const backendBaseEl = document.getElementById('backendBaseUrlInput');
            if (backendBaseEl) {
                const effectiveBackend = localStorage.getItem('backendBaseUrl') || savedBackendBaseUrl || window.location.origin;
                backendBaseEl.value = effectiveBackend;
                // Persist on change so it survives reloads even if user forgets to Save
                backendBaseEl.addEventListener('change', () => {
                    const val = backendBaseEl.value.trim();
                    if (val) localStorage.setItem('backendBaseUrl', val.replace(/\/$/, ''));
                    updateSystemStatus();
                });
            }
            const webhookInputEl = document.getElementById('webhookUrlInput');
            if (webhookInputEl) {
                if (savedWebhookUrl) {
                    webhookInputEl.value = savedWebhookUrl;
                } else {
                    webhookInputEl.value = window.location.origin + '/webhook/sms';
                }
            }
                    if (savedTwilioAccountSid) {
            document.getElementById('twilioAccountSid').value = savedTwilioAccountSid;
        }
        if (savedTwilioAuthToken) {
            document.getElementById('twilioAuthToken').value = savedTwilioAuthToken;
        }

            // Load saved phone numbers if available
            if (savedPhoneNumbers) {
                try {
                    phoneNumbers = JSON.parse(savedPhoneNumbers);
                    updatePhoneNumberSelects();
                    document.getElementById('apiStatus').innerHTML = '<div class="status success">✅ Settings loaded from storage</div>';
                } catch (error) {
                    console.error('Error loading saved phone numbers:', error);
                }
            }

            // Load persistent contact database
            if (savedContactDatabase) {
                try {
                    contactDatabase = JSON.parse(savedContactDatabase);
                    console.log(`Loaded ${contactDatabase.length} contacts from persistent database`);
                } catch (error) {
                    console.error('Error loading contact database:', error);
                    contactDatabase = [];
                }
            }

            // Set up event listeners
            document.getElementById('message').addEventListener('input', updateCharCount);
            const webhookInput = document.getElementById('webhookUrlInput');
            if (webhookInput) webhookInput.addEventListener('input', updateSystemStatus);
            document.getElementById('abstractApiKey').addEventListener('input', function() {
                localStorage.setItem('abstractApiKey', this.value);
            });

            // Test backend connection
            updateSystemStatus();
            // Also surface the backend URL under System Status immediately
            const backendSpan = document.getElementById('backendUrl');
            if (backendSpan) backendSpan.textContent = getBackendBaseUrl() + '/';

            // Load initial stats
            updateStats();

            // Update business hours status
            updateBusinessHoursStatus();

            // Auto-test API connection if we have a saved key
            if (savedApiKey) {
                setTimeout(() => {
                    testAPIConnection();
                }, 1000);
            }

            // Update business hours status every minute
            setInterval(updateBusinessHoursStatus, 60000);

            // Check if running in PWA mode
            function isPWA() {
                return window.matchMedia('(display-mode: standalone)').matches || 
                       window.navigator.standalone === true ||
                       document.referrer.includes('android-app://');
            }

            // Auto-sync for PWA if no messages found
            async function autoSyncForPWA() {
                if (isPWA()) {
                    console.log('📱 PWA detected, checking for messages...');
                    const incomingMessages = loadIncomingMessagesFromStorage();
                    const sentMessages = loadSentMessagesFromStorage();
                    
                    if (incomingMessages.length === 0 && sentMessages.length === 0) {
                        console.log('📱 No messages found in PWA, auto-syncing from server...');
                        await forceReloadMessagesFromServer();
                    }
                }
            }

            // Force reload all messages from server and update storage
            async function forceReloadMessagesFromServer() {
                try {
                const response = await fetch(`${getBackendBaseUrl()}/messages`);
                    const data = await response.json();
                    if (data.success) {
                        incomingMessages = data.messages || [];
                        sentMessages = loadSentMessagesFromStorage();
                        allMessages = [...incomingMessages, ...sentMessages];
                        saveMessagesToStorage();
                        loadConversationsList();
                        console.log('🔄 Forced reload of messages from server');
                    } else {
                        console.error('Error reloading messages from server:', data.error);
                    }
                } catch (error) {
                    console.error('Error reloading messages from server:', error);
                }
            }

            // Auto-sync for PWA on page load
            autoSyncForPWA();

            // Load messages on page load
            setTimeout(() => {
                loadAllMessages();
                // Force apply iMessage styles after loading messages
                setTimeout(() => {
                    forceIMessageStyles();
                    // Ensure conversations are loaded for mobile
                    if (window.innerWidth <= 768) {
                        ensureConversationsLoaded();
                    }
                    // Auto-sync for PWA
                    autoSyncForPWA();
                }, 500);
            }, 2000);
        });

        // Update character count
        function updateCharCount() {
            const message = document.getElementById('message').value;
            document.getElementById('charCount').textContent = message.length;
        }

        // Test API connection
        function getBackendBaseUrl() {
            // Prefer URL param (already persisted on load), else localStorage, else origin
            return (localStorage.getItem('backendBaseUrl') || window.location.origin).replace(/\/$/, '');
        }

        // Update system status
        function updateSystemStatus() {
            const statusDiv = document.getElementById('systemStatus');
            const webhookUrlStored = localStorage.getItem('webhookUrl') || (window.location.origin + '/webhook/sms');
            const backendBase = getBackendBaseUrl();
            statusDiv.innerHTML = `
                <div class="status success">✅ System connected and ready</div>
                <div style="margin-top: 15px;">
                    <strong>Backend URL:</strong> ${backendBase}/<br>
                    <strong>Webhook URL:</strong> ${webhookUrlStored}
                </div>
            `;
            const displayEl = document.getElementById('webhookUrlDisplay');
            if (displayEl) displayEl.textContent = webhookUrlStored;
        }

        // Show business hours status
        function updateBusinessHoursStatus() {
            const statusElement = document.getElementById('business-hours-status');
            const sendSmsWarning = document.getElementById('send-sms-business-hours-warning');
            const bulkSmsWarning = document.getElementById('bulk-sms-business-hours-warning');
            
            if (!statusElement) return;

            if (isBusinessHours()) {
                statusElement.innerHTML = `
                    <div style="color: #059669; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-clock" style="color: #059669;"></i>
                        ✅ SMS Sending Active (Business Hours: 9AM-5PM EST)
                    </div>
                `;
                statusElement.style.display = 'block';
                
                // Hide section warnings
                if (sendSmsWarning) sendSmsWarning.style.display = 'none';
                if (bulkSmsWarning) bulkSmsWarning.style.display = 'none';
            } else {
                const nextBusinessDay = getNextBusinessDay();
                statusElement.innerHTML = `
                    <div style="color: #dc2626; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-clock" style="color: #dc2626;"></i>
                        ⏰ SMS Sending Paused (Outside Business Hours)
                        <br><small style="color: #6b7280; font-weight: normal;">
                            Next business day starts: ${formatTime(nextBusinessDay)}
                        </small>
                    </div>
                `;
                statusElement.style.display = 'block';
                
                // Show section warnings
                const warningMessage = `⏰ SMS sending is only available during business hours (9AM-5PM EST). Next business day starts: ${formatTime(nextBusinessDay)}`;
                if (sendSmsWarning) {
                    sendSmsWarning.innerHTML = `<i class="fas fa-clock"></i> ${warningMessage}`;
                    sendSmsWarning.style.display = 'block';
                }
                if (bulkSmsWarning) {
                    bulkSmsWarning.innerHTML = `<i class="fas fa-clock"></i> ${warningMessage}`;
                    bulkSmsWarning.style.display = 'block';
                }
            }
        }

        // Update stats with real data
        async function updateStats() {
            try {
                // Get incoming messages count
                const messagesResponse = await fetch(`${getBackendBaseUrl()}/messages`);
                const messagesData = await messagesResponse.json();
                const incomingCount = messagesData.messages?.length || 0;

                // Get today's date for sent messages tracking
                const today = new Date().toDateString();
                const sentToday = parseInt(localStorage.getItem(`sentMessages_${today}`) || '0');

                // Calculate total (incoming + sent)
                const totalCount = incomingCount + sentToday;

                // Calculate CSV replies
                let csvRepliesCount = 0;
                let csvRepliesList = [];

                if (messagesData.success && messagesData.messages && (csvData.length > 0 || contactDatabase.length > 0)) {
                    messagesData.messages.forEach(msg => {
                        const contactInfo = findContactByPhone(msg.from);
                        if (contactInfo.name) {
                            csvRepliesCount++;
                            csvRepliesList.push({
                                name: contactInfo.name,
                                phone: msg.from,
                                message: msg.text,
                                timestamp: msg.timestamp
                            });
                        }
                    });
                }

                // Update the display
                document.getElementById('totalMessages').textContent = totalCount;
                document.getElementById('sentMessages').textContent = sentToday;
                document.getElementById('incomingMessages').textContent = incomingCount;
                document.getElementById('csvReplies').textContent = csvRepliesCount;

                // Update CSV replies summary
                updateCSVRepliesSummary(csvRepliesList);

            } catch (error) {
                console.error('Error updating stats:', error);
                // Keep current values if there's an error
            }
        }

        // Read-state helpers
        function loadConversationReadState() {
            try {
                const raw = localStorage.getItem('conversationReadState');
                conversationReadState = raw ? JSON.parse(raw) : {};
            } catch (_) {
                conversationReadState = {};
            }
        }
        function saveConversationReadState() {
            try { localStorage.setItem('conversationReadState', JSON.stringify(conversationReadState)); } catch(_) {}
        }
        function markConversationRead(phone) {
            if (!phone) return;
            conversationReadState[phone] = Date.now();
            saveConversationReadState();
            // Remove unread dot in UI immediately if present
            const item = document.querySelector(`.conversation-item[data-phone="${CSS.escape(phone)}"] .unread-dot`);
            if (item) item.remove();
        }

        // Update CSV replies summary
        function updateCSVRepliesSummary(repliesList) {
            const card = document.getElementById('csvRepliesCard');
            const list = document.getElementById('csvRepliesList');

            if (repliesList.length === 0) {
                card.style.display = 'none';
                return;
            }

            card.style.display = 'block';

            let html = '';
            repliesList.forEach(reply => {
                const time = new Date(reply.timestamp);
                const timeAgo = getTimeAgo(time);

                html += `
                    <div style="padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 8px; background: #f9fafb;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #374151;">${reply.name}</div>
                                <div style="font-size: 12px; color: #6b7280; margin-bottom: 5px;">${reply.phone}</div>
                                <div style="color: #6b7280; font-size: 14px;">${reply.message}</div>
                            </div>
                            <div style="font-size: 12px; color: #9ca3af; margin-left: 10px;">${timeAgo}</div>
                        </div>
                    </div>
                `;
            });

            list.innerHTML = html;
        }

        // Helper function to get time ago
        function getTimeAgo(date) {
            const now = new Date();
            const diffInSeconds = Math.floor((now - date) / 1000);

            if (diffInSeconds < 60) return `${diffInSeconds} seconds ago`;
            if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)} minutes ago`;
            if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)} hours ago`;
            return `${Math.floor(diffInSeconds / 86400)} days ago`;
        }

        // Find contact information by phone number
        function findContactByPhone(phoneNumber) {
            // Normalize the phone number for comparison
            const normalizedPhone = normalizePhoneNumber(phoneNumber);

            // First check the persistent contact database
            const contact = contactDatabase.find(contact => contact.phone === normalizedPhone);
            if (contact) {
                return { name: contact.name, phone: phoneNumber };
            }

            // Fallback to CSV data if available
            if (csvData && csvData.length > 0) {
                for (const row of csvData) {
                    // Check all possible phone number columns
                    const phoneColumns = ['phone', 'Phone', 'PHONE', 'phone_number', 'PhoneNumber', 'mobile', 'Mobile', 'MOBILE', 'cell', 'Cell', 'CELL', 'number', 'Number', 'NUMBER'];

                    for (const col of phoneColumns) {
                        if (row[col] && row[col].trim()) {
                            const rowPhone = normalizePhoneNumber(row[col]);
                            if (rowPhone === normalizedPhone) {
                                // Find the name column
                                const nameColumns = ['name', 'Name', 'NAME', 'first_name', 'FirstName', 'firstname', 'full_name', 'FullName', 'fullname'];
                                let contactName = null;

                                for (const nameCol of nameColumns) {
                                    if (row[nameCol] && row[nameCol].trim()) {
                                        contactName = row[nameCol].trim();
                                        break;
                                    }
                                }

                                return { name: contactName, phone: phoneNumber };
                            }
                        }
                    }
                }
            }

            return { name: null, phone: phoneNumber };
        }

        // Normalize phone number for comparison
        function normalizePhoneNumber(phone) {
            if (!phone) return '';

            // Remove all non-digit characters
            let digits = phone.replace(/\D/g, '');

            // Handle different formats
            if (digits.length === 10) {
                return '+1' + digits; // US number
            } else if (digits.length === 11 && digits.startsWith('1')) {
                return '+' + digits;
            } else if (digits.length > 0) {
                return '+' + digits;
            }

            return phone; // Return original if no pattern matches
        }

        // API call function
        async function makeApiCall(endpoint, data = null, options = {}) {
            // Check business hours for SMS-related endpoints only
            const smsEndpoints = ['/api/send-sms', '/api/send-bulk-sms', '/api/send-mms'];
            if (smsEndpoints.includes(endpoint) && !isBusinessHours()) {
                const nextBusinessDay = getNextBusinessDay();
                throw new Error(`SMS sending is only available during business hours (9AM-5PM EST). Next business day starts: ${formatTime(nextBusinessDay)}`);
            }
            
            const baseUrl = getBackendBaseUrl();
            const url = endpoint.startsWith('http') ? endpoint : `${baseUrl}${endpoint}`;
            
            const defaultOptions = {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                }
            };
            
            const requestOptions = { ...defaultOptions, ...options };
            
            // Add body if data is provided
            if (data) {
                requestOptions.body = JSON.stringify(data);
                requestOptions.method = 'POST';
            }
            
            // For FormData, remove Content-Type to let browser set it
            if (options.body instanceof FormData) {
                delete requestOptions.headers['Content-Type'];
            }
            
            // Add API key to data if not already present and we have one (but not for Twilio endpoints)
            if (data && typeof data === 'object' && !data.apiKey && apiKey && !endpoint.includes('twilio')) {
                data.apiKey = apiKey;
                requestOptions.body = JSON.stringify(data);
            }
            
            try {
                const response = await fetch(url, requestOptions);
                return response;
            } catch (error) {
                console.error('API call failed:', error);
                throw error;
            }
        }

        // Test API connection
        async function testAPIConnection() {
            const apiKeyInput = document.getElementById('apiKey').value.trim();
            const statusDiv = document.getElementById('apiStatus');

            if (!apiKeyInput) {
                statusDiv.innerHTML = '<div class="status error">Please enter your API key</div>';
                return;
            }

            statusDiv.innerHTML = '<div class="status info">Testing API connection...</div>';

            try {
                const response = await fetch(`${getBackendBaseUrl()}/api/test-connection`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ apiKey: apiKeyInput })
                });

                const data = await response.json();

                if (data.success) {
                    statusDiv.innerHTML = '<div class="status success">✅ API connection successful! Found ' + (data.phoneNumbers?.length || 0) + ' phone numbers</div>';

                    // Save API key to localStorage
                    localStorage.setItem('telnyxApiKey', apiKeyInput);
                    apiKey = apiKeyInput;

                    // Save phone numbers to localStorage
                    phoneNumbers = data.phoneNumbers || [];
                    localStorage.setItem('telnyxPhoneNumbers', JSON.stringify(phoneNumbers));

                    updatePhoneNumberSelects();
                    updateSystemStatus();
                } else {
                    statusDiv.innerHTML = `<div class="status error">❌ API connection failed: ${data.error}</div>`;
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">❌ Error: ${error.message}</div>`;
            }
        }

        // Test webhook URL
        async function testWebhookUrl() {
            const webhookUrl = document.getElementById('webhookUrl').value.trim();
            const statusDiv = document.getElementById('apiStatus');

            if (!webhookUrl) {
                statusDiv.innerHTML = '<div class="status error">Please enter a webhook URL</div>';
                return;
            }

            statusDiv.innerHTML = '<div class="status info">Testing webhook URL...</div>';

            try {
                // Test the webhook endpoint with a simple POST request
                const response = await fetch(webhookUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        test: 'webhook',
                        timestamp: new Date().toISOString()
                    })
                });

                if (response.ok) {
                    statusDiv.innerHTML = '<div class="status success">✅ Webhook URL is accessible! Status: ' + response.status + '</div>';
                } else {
                    statusDiv.innerHTML = '<div class="status warning">⚠️ Webhook URL responded with status: ' + response.status + '</div>';
                }
            } catch (error) {
                statusDiv.innerHTML = '<div class="status error">❌ Webhook URL test failed: ' + error.message + '</div>';
            }
        }

        // Copy webhook URL to clipboard
        function copyWebhookUrl() {
            const webhookUrl = document.getElementById('webhookUrl').value.trim();
            const statusDiv = document.getElementById('apiStatus');

            if (!webhookUrl) {
                statusDiv.innerHTML = '<div class="status error">Please enter a webhook URL first</div>';
                return;
            }

            navigator.clipboard.writeText(webhookUrl).then(() => {
                statusDiv.innerHTML = '<div class="status success">✅ Webhook URL copied to clipboard!</div>';
            }).catch(err => {
                statusDiv.innerHTML = '<div class="status error">❌ Failed to copy: ' + err.message + '</div>';
            });
        }

        // Save settings
        function saveSettings() {
            const apiKeyInput = document.getElementById('apiKey').value.trim();
            const webhookUrl = document.getElementById('webhookUrl').value;

            if (apiKeyInput) {
                localStorage.setItem('telnyxApiKey', apiKeyInput);
                apiKey = apiKeyInput;
            }
            if (webhookUrl) {
                localStorage.setItem('webhookUrl', webhookUrl);
            }

            // Save current phone numbers if available
            if (phoneNumbers.length > 0) {
                localStorage.setItem('telnyxPhoneNumbers', JSON.stringify(phoneNumbers));
            }

            document.getElementById('apiStatus').innerHTML = '<div class="status success">✅ Settings saved successfully! They will persist across page reloads.</div>';
        }

        // Clear settings
        function clearSettings() {
            // Clear localStorage
            localStorage.removeItem('telnyxApiKey');
            localStorage.removeItem('telnyxPhoneNumbers');
            localStorage.removeItem('webhookUrl');

            // Clear form fields
            document.getElementById('apiKey').value = '';
            document.getElementById('webhookUrl').value = 'https://codelife-sms-app-48d5c9e059b8.herokuapp.com/webhook/sms';

            // Clear phone numbers
            phoneNumbers = [];
            updatePhoneNumberSelects();

            // Clear API key variable
            apiKey = '';

            document.getElementById('apiStatus').innerHTML = '<div class="status info">Settings cleared successfully!</div>';
        }

        // Clear contact database
        function clearContactDatabase() {
            contactDatabase = [];
            localStorage.removeItem('contactDatabase');
            console.log('Contact database cleared');
        }

        // Update phone number selects
        function updatePhoneNumberSelects() {
            const selects = ['fromNumber', 'callFromNumber'];

            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    select.innerHTML = '<option value="">Select a number...</option>';

                    phoneNumbers.forEach(phone => {
                        const option = document.createElement('option');
                        option.value = phone.phone_number;
                        option.textContent = phone.phone_number;
                        select.appendChild(option);
                    });
                }
            });

            // Update phone numbers list
            const phoneNumbersList = document.getElementById('phoneNumbersList');
            if (phoneNumbers.length > 0) {
                let html = '';
                phoneNumbers.forEach(phone => {
                    html += `<div style="padding: 10px; border: 1px solid #e5e7eb; border-radius: 5px; margin-bottom: 5px;">
                        <strong>${phone.phone_number}</strong>
                        <div style="font-size: 12px; color: #6b7280;">${phone.friendly_name || 'No description'}</div>
                    </div>`;
                });
                phoneNumbersList.innerHTML = html;
            } else {
                phoneNumbersList.innerHTML = '<div class="status info">No phone numbers found</div>';
            }
        }

        // Send single SMS
        async function sendSingleSMS() {
            const fromNumber = document.getElementById('fromNumber').value;
            const toNumber = document.getElementById('toNumber').value;
            const message = document.getElementById('message').value;
            const statusDiv = document.getElementById('sendStatus');

            if (!fromNumber || !toNumber || !message) {
                statusDiv.innerHTML = '<div class="status error">Please fill in all fields</div>';
                return;
            }

            if (!apiKey) {
                statusDiv.innerHTML = '<div class="status error">Please configure your API key first</div>';
                return;
            }

            statusDiv.innerHTML = '<div class="status info">Sending SMS...</div>';

            try {
                const response = await fetch(`${getBackendBaseUrl()}/api/send-sms`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        apiKey: apiKey,
                        to: toNumber,
                        from: fromNumber,
                        message: message
                    })
                });

                const data = await response.json();

                if (data.success) {
                    statusDiv.innerHTML = '<div class="status success">✅ SMS sent successfully!</div>';
                    document.getElementById('toNumber').value = '';
                    document.getElementById('message').value = '';
                    updateCharCount();

                    // Save sent message to localStorage for persistence
                    const sentMessage = {
                        id: Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                        to: toNumber,
                        from: fromNumber,
                        text: message,
                        timestamp: new Date().toISOString(),
                        status: 'sent'
                    };
                    addSentMessage(sentMessage);

                    // Track sent message count
                    const today = new Date().toDateString();
                    const currentSent = parseInt(localStorage.getItem(`sentMessages_${today}`) || '0');
                    localStorage.setItem(`sentMessages_${today}`, currentSent + 1);

                    updateStats();
                } else {
                    statusDiv.innerHTML = `<div class="status error">❌ SMS failed: ${data.error}</div>`;
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">❌ Error: ${error.message}</div>`;
            }
        }

        // Send MMS
        async function sendMMS() {
            const fromNumber = document.getElementById('fromNumber').value;
            const toNumber = document.getElementById('toNumber').value;
            const message = document.getElementById('message').value;
            const fileInput = document.getElementById('fileUpload');
            const statusDiv = document.getElementById('sendStatus');

            if (!fromNumber || !toNumber) {
                statusDiv.innerHTML = '<div class="status error">Please fill in From and To fields</div>';
                return;
            }

            if (!fileInput.files[0]) {
                statusDiv.innerHTML = '<div class="status error">Please select a file to send</div>';
                return;
            }

            if (!apiKey) {
                statusDiv.innerHTML = '<div class="status error">Please configure your API key first</div>';
                return;
            }

            statusDiv.innerHTML = '<div class="status info">Sending MMS...</div>';

            try {
                const formData = new FormData();
                formData.append('to', toNumber);
                formData.append('from', fromNumber);
                formData.append('message', message);
                formData.append('file', fileInput.files[0]);

                const response = await makeApiCall('/api/send-mms', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    statusDiv.innerHTML = '<div class="status success">✅ MMS sent successfully!</div>';
                    document.getElementById('toNumber').value = '';
                    document.getElementById('message').value = '';
                    fileInput.value = '';
                    updateCharCount();

                    // Track sent message
                    const today = new Date().toDateString();
                    const currentCount = parseInt(localStorage.getItem(`sentMessages_${today}`) || '0');
                    localStorage.setItem(`sentMessages_${today}`, (currentCount + 1).toString());
                    updateStats();
                } else {
                    statusDiv.innerHTML = '<div class="status error">❌ Failed to send MMS: ' + data.error + '</div>';
                }
            } catch (error) {
                console.error('Send MMS error:', error);
                statusDiv.innerHTML = '<div class="status error">❌ Error sending MMS: ' + error.message + '</div>';
            }
        }

        // Make call
        async function makeCall() {
            const fromNumber = document.getElementById('fromNumber').value;
            const toNumber = document.getElementById('toNumber').value;
            const statusDiv = document.getElementById('sendStatus');

            if (!fromNumber || !toNumber) {
                statusDiv.innerHTML = '<div class="status error">Please fill in From and To fields</div>';
                return;
            }

            if (!apiKey) {
                statusDiv.innerHTML = '<div class="status error">Please configure your API key first</div>';
                return;
            }

            statusDiv.innerHTML = '<div class="status info">Initiating call...</div>';

            try {
                // Open phone interface in new window
                const phoneUrl = `${getBackendBaseUrl()}/phone-interface-webrtc.html?to=${encodeURIComponent(toNumber)}&from=${encodeURIComponent(fromNumber)}&name=${encodeURIComponent('Call')}`;
                window.open(phoneUrl, 'phone_interface', 'width=500,height=800,scrollbars=no,resizable=yes');
                
                statusDiv.innerHTML = '<div class="status success">✅ Phone interface opened! Use it to control your call.</div>';
            } catch (error) {
                console.error('Make call error:', error);
                statusDiv.innerHTML = '<div class="status error">❌ Error opening phone interface: ' + error.message + '</div>';
            }
        }

        // File upload change handler
        document.getElementById('fileUpload').addEventListener('change', function () {
            const file = this.files[0];
            const sendMMSButton = document.getElementById('sendMMSButton');

            if (file) {
                // Check file size (5MB limit)
                if (file.size > 5 * 1024 * 1024) {
                    alert('File size must be less than 5MB');
                    this.value = '';
                    sendMMSButton.style.display = 'none';
                    return;
                }

                // Check file type
                const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp', 'application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 'text/plain'];
                if (!allowedTypes.includes(file.type)) {
                    alert('File type not supported. Please select an image, PDF, Word document, or text file.');
                    this.value = '';
                    sendMMSButton.style.display = 'none';
                    return;
                }

                sendMMSButton.style.display = 'inline-block';
            } else {
                sendMMSButton.style.display = 'none';
            }
        });

        // Handle CSV upload
        function handleCSVUpload(input) {
            const file = input.files[0];
            if (!file) return;

            // Check if file already exists
            const existingFile = csvFiles.find(f => f.name === file.name);
            if (existingFile) {
                alert(`File "${file.name}" is already uploaded. Please choose a different file.`);
                return;
            }

            const reader = new FileReader();
            reader.onload = function (e) {
                const csv = e.target.result;

                // Better CSV parsing that handles quoted fields and different delimiters
                const lines = csv.split('\n').filter(line => line.trim());
                if (lines.length === 0) return;

                // Detect delimiter (comma, semicolon, tab)
                const firstLine = lines[0];
                let delimiter = ',';
                if (firstLine.includes(';')) delimiter = ';';
                else if (firstLine.includes('\t')) delimiter = '\t';

                // Parse headers with better handling of quotes
                const parseCSVLine = (line) => {
                    const result = [];
                    let current = '';
                    let inQuotes = false;

                    for (let i = 0; i < line.length; i++) {
                        const char = line[i];
                        if (char === '"') {
                            inQuotes = !inQuotes;
                        } else if (char === delimiter && !inQuotes) {
                            result.push(current.trim());
                            current = '';
                        } else {
                            current += char;
                        }
                    }
                    result.push(current.trim());
                    return result.map(field => field.replace(/^"|"$/g, ''));
                };

                const headers = parseCSVLine(lines[0]);
                console.log('Detected headers:', headers);

                const fileData = [];
                for (let i = 1; i < lines.length; i++) {
                    if (lines[i].trim()) {
                        const values = parseCSVLine(lines[i]);
                        const row = {};
                        headers.forEach((header, index) => {
                            row[header] = values[index] || '';
                        });
                        fileData.push(row);
                    }
                }

                // Add file to csvFiles array
                const csvFile = {
                    name: file.name,
                    size: file.size,
                    data: fileData,
                    headers: headers,
                    rowCount: fileData.length
                };

                csvFiles.push(csvFile);

                // Store contacts in persistent database
                storeContactsInDatabase(fileData);

                // Combine all CSV data
                combineCSVData();

                // Update UI
                updateCSVFilesList();
                updateCSVPreview();

                // Create column buttons from combined headers
                if (csvData.length > 0) {
                    const combinedHeaders = Object.keys(csvData[0]);
                    createColumnButtons(combinedHeaders);
                    updateMessagePreview();
                    document.getElementById('sendBulkBtn').disabled = false;
                }

                // Clear the file input
                input.value = '';
            };
            reader.readAsText(file);
        }

        // Store contacts in persistent database
        function storeContactsInDatabase(fileData) {
            fileData.forEach(row => {
                // Find phone number
                const phoneColumns = ['phone', 'Phone', 'PHONE', 'phone_number', 'PhoneNumber', 'mobile', 'Mobile', 'MOBILE', 'cell', 'Cell', 'CELL', 'number', 'Number', 'NUMBER'];
                let phone = null;

                for (const col of phoneColumns) {
                    if (row[col] && row[col].trim()) {
                        phone = normalizePhoneNumber(row[col].trim());
                        break;
                    }
                }

                if (phone) {
                    // Find name
                    const nameColumns = ['name', 'Name', 'NAME', 'first_name', 'FirstName', 'firstname', 'full_name', 'FullName', 'fullname'];
                    let contactName = null;

                    for (const nameCol of nameColumns) {
                        if (row[nameCol] && row[nameCol].trim()) {
                            contactName = row[nameCol].trim();
                            break;
                        }
                    }

                    // Store in contact database (avoid duplicates)
                    const existingIndex = contactDatabase.findIndex(contact => contact.phone === phone);
                    if (existingIndex >= 0) {
                        // Update existing contact if we have a name
                        if (contactName) {
                            contactDatabase[existingIndex].name = contactName;
                        }
                    } else {
                        // Add new contact
                        contactDatabase.push({
                            phone: phone,
                            name: contactName,
                            addedAt: new Date().toISOString()
                        });
                    }
                }
            });

            // Save to localStorage
            localStorage.setItem('contactDatabase', JSON.stringify(contactDatabase));
            console.log(`Stored ${contactDatabase.length} contacts in database`);
        }

        // Combine data from all CSV files
        function combineCSVData() {
            csvData = [];
            csvFiles.forEach(file => {
                csvData = csvData.concat(file.data);
            });
            console.log(`Combined ${csvData.length} rows from ${csvFiles.length} files`);
        }

        // Update CSV files list UI
        function updateCSVFilesList() {
            const container = document.getElementById('csvFilesContainer');

            if (csvFiles.length === 0) {
                container.innerHTML = '<div class="status info">No CSV files uploaded yet</div>';
                return;
            }

            let html = '';
            csvFiles.forEach((file, index) => {
                html += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border: 1px solid #e5e7eb; border-radius: 5px; margin-bottom: 8px; background: #f9fafb;">
                        <div>
                            <div style="font-weight: 600; color: #374151;">${file.name}</div>
                            <div style="font-size: 12px; color: #6b7280;">${file.rowCount} rows, ${(file.size / 1024).toFixed(1)} KB</div>
                        </div>
                        <button class="btn btn-danger" onclick="removeCSVFile(${index})" style="padding: 5px 10px; font-size: 12px;">
                            <i class="fas fa-trash"></i> Remove
                        </button>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Remove a specific CSV file
        function removeCSVFile(index) {
            if (index >= 0 && index < csvFiles.length) {
                const removedFile = csvFiles[index];
                csvFiles.splice(index, 1);

                // Recombine data
                combineCSVData();

                // Update UI
                updateCSVFilesList();
                updateCSVPreview();

                // Update column buttons and preview
                if (csvData.length > 0) {
                    const combinedHeaders = Object.keys(csvData[0]);
                    createColumnButtons(combinedHeaders);
                    updateMessagePreview();
                    document.getElementById('sendBulkBtn').disabled = false;
                } else {
                    document.getElementById('csvColumns').style.display = 'none';
                    document.getElementById('messagePreview').style.display = 'none';
                    document.getElementById('csvPreview').style.display = 'none';
                    document.getElementById('sendBulkBtn').disabled = true;
                }

                console.log(`Removed file: ${removedFile.name}`);
            }
        }

        // Update CSV preview with combined data
        function updateCSVPreview() {
            const previewDiv = document.getElementById('csvPreview');
            const dataDiv = document.getElementById('csvData');

            if (csvData.length === 0) {
                previewDiv.style.display = 'none';
                return;
            }

            const headers = Object.keys(csvData[0]);

            let html = '<table style="width: 100%; border-collapse: collapse;">';
            html += '<tr>';
            headers.forEach(header => {
                html += `<th style="border: 1px solid #e5e7eb; padding: 5px; text-align: left;">${header}</th>`;
            });
            html += '</tr>';

            csvData.slice(0, 5).forEach(row => {
                html += '<tr>';
                headers.forEach(header => {
                    html += `<td style="border: 1px solid #e5e7eb; padding: 5px;">${row[header] || ''}</td>`;
                });
                html += '</tr>';
            });
            html += '</table>';

            if (csvData.length > 5) {
                html += `<div style="margin-top: 10px; color: #6b7280;">... and ${csvData.length - 5} more rows (from ${csvFiles.length} files)</div>`;
            }

            dataDiv.innerHTML = html;
            previewDiv.style.display = 'block';
        }

        // Create column buttons for CSV template
        function createColumnButtons(headers) {
            const csvColumnsDiv = document.getElementById('csvColumns');
            const columnButtonsDiv = document.getElementById('columnButtons');

            // Show the CSV columns section
            csvColumnsDiv.style.display = 'block';

            // Clear existing buttons
            columnButtonsDiv.innerHTML = '';

            // Create buttons for each column
            headers.forEach(header => {
                const button = document.createElement('button');
                button.type = 'button';
                button.textContent = `{${header}}`;
                button.style.cssText = `
                    padding: 5px 10px;
                    margin: 2px;
                    background: #667eea;
                    color: white;
                    border: none;
                    border-radius: 4px;
                    font-size: 12px;
                    cursor: pointer;
                    transition: background 0.3s;
                `;
                button.onmouseover = function () {
                    this.style.background = '#5a67d8';
                };
                button.onmouseout = function () {
                    this.style.background = '#667eea';
                };
                button.onclick = function () {
                    insertColumnToTemplate(header);
                };
                columnButtonsDiv.appendChild(button);
            });
        }

        // Insert column placeholder into template
        function insertColumnToTemplate(columnName) {
            const template = document.getElementById('messageTemplate');
            const placeholder = `{${columnName}}`;

            // Get cursor position
            const start = template.selectionStart;
            const end = template.selectionEnd;

            // Insert the placeholder at cursor position
            const text = template.value;
            const before = text.substring(0, start);
            const after = text.substring(end);

            template.value = before + placeholder + after;

            // Set cursor position after the inserted text
            const newCursorPos = start + placeholder.length;
            template.setSelectionRange(newCursorPos, newCursorPos);

            // Focus back on the template
            template.focus();

            // Update preview
            updateMessagePreview();
        }

        // Update message preview with first row data
        function updateMessagePreview() {
            const template = document.getElementById('messageTemplate').value;
            const previewDiv = document.getElementById('messagePreview');
            const previewText = document.getElementById('previewText');

            if (csvData.length > 0 && template.trim()) {
                const firstRow = csvData[0];
                let preview = template;

                // Replace placeholders with actual data
                Object.keys(firstRow).forEach(key => {
                    const placeholder = new RegExp(`{${key}}`, 'g');
                    preview = preview.replace(placeholder, firstRow[key] || `[${key}]`);
                });

                // Replace any remaining placeholders with [placeholder]
                preview = preview.replace(/\{[^}]+\}/g, '[placeholder]');

                previewText.textContent = preview;
                previewDiv.style.display = 'block';
            } else {
                previewDiv.style.display = 'none';
            }
        }

        // Send bulk SMS
        async function sendBulkSMS() {
            if (isSendingBulk || csvData.length === 0) {
                alert('Please upload a CSV file first');
                return;
            }

            const template = document.getElementById('messageTemplate').value;
            const delay = parseInt(document.getElementById('messageDelay').value) * 1000;

            if (!template.trim()) {
                alert('Please enter a message template');
                return;
            }

            if (!apiKey) {
                alert('Please configure your API key first');
                return;
            }

            // Validate that we have phone numbers
            let validRows = 0;
            csvData.forEach(row => {
                const phoneColumns = ['phone', 'Phone', 'PHONE', 'phone_number', 'PhoneNumber', 'mobile', 'Mobile', 'MOBILE', 'cell', 'Cell', 'CELL', 'number', 'Number', 'NUMBER'];
                for (const col of phoneColumns) {
                    if (row[col] && row[col].trim()) {
                        validRows++;
                        break;
                    }
                }
            });

            if (validRows === 0) {
                alert('No phone numbers found in CSV. Please check your CSV file has a phone number column.');
                return;
            }

            console.log(`Starting bulk SMS: ${validRows} valid rows out of ${csvData.length} total rows`);

            isSendingBulk = true;
            document.getElementById('sendBulkBtn').disabled = true;
            document.getElementById('bulkProgress').style.display = 'block';

            let sent = 0;
            let failed = 0;

            for (let i = 0; i < csvData.length; i++) {
                const row = csvData[i];

                // Better phone number detection - try multiple possible column names
                let phone = null;
                const phoneColumns = ['phone', 'Phone', 'PHONE', 'phone_number', 'PhoneNumber', 'mobile', 'Mobile', 'MOBILE', 'cell', 'Cell', 'CELL', 'number', 'Number', 'NUMBER'];

                for (const col of phoneColumns) {
                    if (row[col] && row[col].trim()) {
                        phone = row[col].trim();
                        break;
                    }
                }

                if (!phone) {
                    console.log(`No phone number found in row ${i + 1}:`, row);
                    failed++;
                    continue;
                }

                // Format phone number to E.164
                let formattedPhone = phone;
                if (!phone.startsWith('+')) {
                    // Remove all non-digits
                    const digits = phone.replace(/\D/g, '');
                    if (digits.length === 10) {
                        formattedPhone = '+1' + digits; // US number
                    } else if (digits.length === 11 && digits.startsWith('1')) {
                        formattedPhone = '+' + digits;
                    } else {
                        formattedPhone = '+' + digits;
                    }
                }

                // Personalize message
                let message = template;
                Object.keys(row).forEach(key => {
                    const placeholder = new RegExp(`{${key}}`, 'g');
                    message = message.replace(placeholder, row[key] || '');
                });

                // Update progress
                const progress = ((i + 1) / csvData.length) * 100;
                document.getElementById('progressBar').style.width = progress + '%';
                document.getElementById('progressText').textContent = `Sending ${i + 1} of ${csvData.length}... (${formattedPhone})`;

                console.log(`Sending to ${formattedPhone}: ${message}`);

                // Send SMS
                try {
                    const response = await makeApiCall('/api/send-sms', {
                        apiKey: apiKey,
                        to: formattedPhone,
                        from: phoneNumbers[0]?.phone_number || '+18137420762',
                        message: message
                    });

                    const data = await response.json();
                    if (data.success) {
                        sent++;
                        // Track sent message
                        const today = new Date().toDateString();
                        const currentSent = parseInt(localStorage.getItem(`sentMessages_${today}`) || '0');
                        localStorage.setItem(`sentMessages_${today}`, currentSent + 1);
                        console.log(`✅ SMS sent successfully to ${formattedPhone}`);
                    } else {
                        console.log(`❌ SMS failed for ${formattedPhone}:`, data.error);
                        failed++;
                    }
                } catch (error) {
                    console.error(`❌ Network error for ${formattedPhone}:`, error);
                    failed++;
                }

                // Delay between messages
                if (i < csvData.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }

            // Complete
            document.getElementById('progressText').textContent = `Complete! Sent: ${sent}, Failed: ${failed}`;
            document.getElementById('sendBulkBtn').disabled = false;
            isSendingBulk = false;

            // Update stats after bulk send
            updateStats();

            // Reset after 5 seconds
            setTimeout(() => {
                document.getElementById('bulkProgress').style.display = 'none';
                document.getElementById('progressBar').style.width = '0%';
            }, 5000);
        }

        // Load incoming messages
        async function loadIncomingMessages() {
            const messagesDiv = document.getElementById('incomingMessagesList');
            if (!messagesDiv) return;
            
            messagesDiv.innerHTML = '<div class="status info">Loading messages...</div>';

            try {
                // First, load from localStorage (persistent storage)
                let storedMessages = loadIncomingMessagesFromStorage();
                console.log('📱 Loaded from localStorage:', storedMessages.length, 'messages');

                // Then try to fetch new messages from backend
                console.log('🔄 Fetching new messages from backend...');
                const response = await fetch(`${getBackendBaseUrl()}/api/incoming-messages`);

                if (response.ok) {
                    const data = await response.json();
                    console.log('📨 Received new data from backend:', data);

                    if (data.messages && data.messages.length > 0) {
                        // Merge new messages with stored messages
                        const newMessages = data.messages.filter(newMsg => {
                            // Check if message already exists in storage
                            return !storedMessages.some(storedMsg => 
                                storedMsg.from === newMsg.from && 
                                storedMsg.text === newMsg.text && 
                                storedMsg.timestamp === newMsg.timestamp
                            );
                        });

                        if (newMessages.length > 0) {
                            console.log('🆕 Adding', newMessages.length, 'new messages to storage');
                            newMessages.forEach(msg => addIncomingMessage(msg));
                            storedMessages = loadIncomingMessagesFromStorage();
                        }
                    }
                } else {
                    console.log('⚠️ Backend not available, using stored messages only');
                }

                // Display messages (from storage)
                if (storedMessages && storedMessages.length > 0) {
                    let html = `
                        <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                            <thead>
                                <tr style="border-bottom: 2px solid #e5e7eb;">
                                    <th style="text-align: left; padding: 12px; font-weight: 600; color: #374151;">Contact</th>
                                    <th style="text-align: left; padding: 12px; font-weight: 600; color: #374151;">Message</th>
                                    <th style="text-align: left; padding: 12px; font-weight: 600; color: #374151;">Timestamp</th>
                                    <th style="text-align: center; padding: 12px; font-weight: 600; color: #374151;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;

                    storedMessages.forEach((msg, index) => {
                        const time = new Date(msg.timestamp);
                        const timeAgo = getTimeAgo(time);

                        // Try to find contact name from CSV data
                        const contactInfo = findContactByPhone(msg.from);

                        html += `
                            <tr style="border-bottom: 1px solid #f3f4f6;">
                                <td style="padding: 12px; color: #374151; font-weight: 500;">
                                    ${contactInfo.name ? `<strong style="cursor: pointer; color: #3b82f6;" onclick="openConversationModal('${msg.from}', '${contactInfo.name}')">${contactInfo.name}</strong><br><small style="color: #9ca3af;">${msg.from}</small>` : `<span style="cursor: pointer; color: #3b82f6;" onclick="openConversationModal('${msg.from}', '${msg.from}')">${msg.from}</span>`}
                                </td>
                                <td style="padding: 12px; color: #6b7280;">${msg.text}</td>
                                <td style="padding: 12px; color: #9ca3af; font-size: 14px;">${timeAgo}</td>
                                <td style="padding: 12px; text-align: center;">
                                    <button class="btn btn-sm" onclick="openConversationModal('${msg.from}', '${contactInfo.name || 'Unknown'}')" style="padding: 6px 12px; font-size: 12px; margin-right: 5px;">
                                        <i class="fas fa-reply"></i> Reply
                                    </button>
                                    <button class="btn btn-sm" onclick="deleteIncomingMessage('${msg.id}')" style="padding: 6px 12px; font-size: 12px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </td>
                            </tr>
                        `;
                    });

                    html += '</tbody></table>';
                    messagesDiv.innerHTML = html;
                    updateStats();
                } else {
                    messagesDiv.innerHTML = `
                        <div class="status info">
                            <i class="fas fa-inbox"></i> No incoming messages yet
                            <br><small>Send an SMS to +18137420762 to see it here</small>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('❌ Error loading messages:', error);

                let errorMessage = '';
                if (error.message.includes('Failed to fetch')) {
                    errorMessage = `
                        <div class="status error">
                            <i class="fas fa-server"></i> Backend Not Running
                            <br><small>Try refreshing or check the Heroku app status</small>
                        </div>
                    `;
                } else {
                    errorMessage = `
                        <div class="status error">
                            <i class="fas fa-exclamation-triangle"></i> Error: ${error.message}
                            <br><small>Check console for details</small>
                        </div>
                    `;
                }

                messagesDiv.innerHTML = errorMessage;
            }
        }

        // Persistent message storage functions
        function saveIncomingMessages(messages) {
            try {
                localStorage.setItem('incomingMessages', JSON.stringify(messages));
                console.log('💾 Saved incoming messages to localStorage:', messages.length);
            } catch (error) {
                console.error('❌ Error saving incoming messages:', error);
            }
        }

        function loadIncomingMessagesFromStorage() {
            try {
                const stored = localStorage.getItem('incomingMessages');
                console.log('📱 PWA Debug - Raw incoming messages from localStorage:', stored);
                const parsed = stored ? JSON.parse(stored) : [];
                console.log('📱 PWA Debug - Parsed incoming messages:', parsed.length, parsed);
                return parsed;
            } catch (error) {
                console.error('❌ Error loading incoming messages from storage:', error);
                return [];
            }
        }

        function saveSentMessages(messages) {
            try {
                localStorage.setItem('sentMessages', JSON.stringify(messages));
                console.log('💾 Saved sent messages to localStorage:', messages.length);
            } catch (error) {
                console.error('❌ Error saving sent messages:', error);
            }
        }

        function loadSentMessagesFromStorage() {
            try {
                const stored = localStorage.getItem('sentMessages');
                console.log('📤 PWA Debug - Raw sent messages from localStorage:', stored);
                const parsed = stored ? JSON.parse(stored) : [];
                console.log('📤 PWA Debug - Parsed sent messages:', parsed.length, parsed);
                return parsed;
            } catch (error) {
                console.error('❌ Error loading sent messages from storage:', error);
                return [];
            }
        }

        function addIncomingMessage(message) {
            const messages = loadIncomingMessagesFromStorage();
            // Add unique ID if not present
            if (!message.id) {
                message.id = Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }
            messages.unshift(message); // Add to beginning
            saveIncomingMessages(messages);
            return messages;
        }

        function addSentMessage(message) {
            const messages = loadSentMessagesFromStorage();
            // Add unique ID if not present
            if (!message.id) {
                message.id = Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }
            messages.unshift(message); // Add to beginning
            saveSentMessages(messages);
            return messages;
        }

        function deleteIncomingMessage(messageId) {
            console.log('🗑️ Attempting to delete incoming message with ID:', messageId);
            const messages = loadIncomingMessagesFromStorage();
            console.log('📱 Current messages in storage:', messages.length);
            console.log('🔍 Looking for message with ID:', messageId);
            
            const filteredMessages = messages.filter(msg => {
                const hasId = msg.id !== messageId;
                if (!hasId) {
                    console.log('❌ Found message to delete:', msg);
                }
                return hasId;
            });
            
            console.log('✅ Remaining messages after deletion:', filteredMessages.length);
            saveIncomingMessages(filteredMessages);
            console.log('💾 Saved updated messages to localStorage');
            
            // Refresh the display
            loadIncomingMessages();
            return filteredMessages;
        }

        function deleteSentMessage(messageId) {
            console.log('🗑️ Attempting to delete sent message with ID:', messageId);
            const messages = loadSentMessagesFromStorage();
            console.log('📱 Current sent messages in storage:', messages.length);
            console.log('🔍 Looking for message with ID:', messageId);
            
            const filteredMessages = messages.filter(msg => {
                const hasId = msg.id !== messageId;
                if (!hasId) {
                    console.log('❌ Found sent message to delete:', msg);
                }
                return hasId;
            });
            
            console.log('✅ Remaining sent messages after deletion:', filteredMessages.length);
            saveSentMessages(filteredMessages);
            console.log('💾 Saved updated sent messages to localStorage');
            
            // Refresh the display
            loadSentMessages();
            return filteredMessages;
        }

        function deleteAllIncomingMessages() {
            if (confirm('Are you sure you want to delete ALL incoming messages? This cannot be undone.')) {
                localStorage.removeItem('incomingMessages');
                loadIncomingMessages();
            }
        }

        function deleteAllSentMessages() {
            if (confirm('Are you sure you want to delete ALL sent messages? This cannot be undone.')) {
                localStorage.removeItem('sentMessages');
                loadSentMessages();
            }
        }

        // Phone validation functions
        async function validateSingleNumber() {
            const phoneNumber = document.getElementById('singlePhoneNumber').value.trim();
            const resultDiv = document.getElementById('singleValidationResult');
            const selectedApi = document.querySelector('input[name="validationApi"]:checked').value;

            console.log('🔍 Phone validation request:', { phoneNumber, selectedApi });

            if (!phoneNumber) {
                resultDiv.innerHTML = '<div class="status error">Please enter a phone number</div>';
                return;
            }

            resultDiv.innerHTML = '<div class="status info">Validating phone number...</div>';

            try {
                console.log('🔍 Selected API:', selectedApi);
                const endpoint = selectedApi === 'twilio' ? '/api/validate-number-twilio' : '/api/validate-number';
                console.log('🔍 Using endpoint:', endpoint);
                const requestData = {
                    phoneNumber: phoneNumber
                };
                
                // Add Twilio credentials if provided
                if (selectedApi === 'twilio') {
                    const accountSid = document.getElementById('twilioAccountSid').value.trim();
                    const authToken = document.getElementById('twilioAuthToken').value.trim();
                    if (accountSid && authToken) {
                        requestData.accountSid = accountSid;
                        requestData.authToken = authToken;
                        console.log('🔑 Using custom Twilio credentials');
                    } else {
                        console.log('🔑 Twilio credentials not provided');
                    }
                }
                
                console.log('📡 Making API call to:', endpoint, 'with data:', requestData);
                const response = await makeApiCall(endpoint, requestData);

                const data = await response.json();

                if (data.success) {
                    const result = data.result;
                    const typeColor = result.type === 'mobile' ? '#059669' : 
                                    result.type === 'landline' ? '#3b82f6' : 
                                    result.type === 'voip' ? '#f59e0b' : 
                                    result.type === 'fixed-line' ? '#3b82f6' :
                                    result.type === 'mobile-lte' ? '#059669' : '#6b7280';
                    
                    const apiBadge = selectedApi === 'twilio' ? 
                        '<span style="background: #059669; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-left: 8px;">Twilio</span>' :
                        '<span style="background: #3b82f6; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-left: 8px;">Telnyx</span>';
                    
                    resultDiv.innerHTML = `
                        <div class="status success" style="padding: 15px; border-radius: 8px; background: #f0fdf4; border: 1px solid #bbf7d0;">
                            <h4 style="margin: 0 0 10px 0; color: #166534;">✅ Validation Complete ${apiBadge}</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px;">
                                <div><strong>Phone Number:</strong> ${result.phoneNumber}</div>
                                <div><strong>Type:</strong> <span style="color: ${typeColor}; font-weight: 600;">${result.type.toUpperCase()}</span></div>
                                <div><strong>Carrier:</strong> ${result.carrier}</div>
                                <div><strong>Country:</strong> ${result.countryName || result.countryCode}</div>
                                ${result.format ? `<div><strong>Format:</strong> ${result.format}</div>` : ''}
                                ${result.location ? `<div><strong>Location:</strong> ${result.location}</div>` : ''}
                                <div><strong>Valid:</strong> ${result.valid ? 'Yes' : 'No'}</div>
                            </div>
                            <div style="margin-top: 10px; font-size: 12px; color: #6b7280;">
                                Validated at: ${new Date(result.timestamp).toLocaleString()}
                            </div>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `<div class="status error">❌ Validation failed: ${data.error}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="status error">❌ Error: ${error.message}</div>`;
            }
        }

        // Handle validation CSV upload
        function handleValidationCsvUpload(input) {
            const file = input.files[0];
            if (!file) return;

            if (!file.name.toLowerCase().endsWith('.csv')) {
                alert('Please select a CSV file');
                return;
            }

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const csv = e.target.result;
                    const lines = csv.split('\n');
                    const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                    
                    const data = [];
                    for (let i = 1; i < lines.length; i++) {
                        if (lines[i].trim()) {
                            const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                            const row = {};
                            headers.forEach((header, index) => {
                                row[header] = values[index] || '';
                            });
                            data.push(row);
                        }
                    }

                    validationCsvFiles.push({
                        name: file.name,
                        data: data,
                        headers: headers
                    });

                    updateValidationCsvFilesList();
                    document.getElementById('validateBulkBtn').disabled = false;

                } catch (error) {
                    alert('Error reading CSV file: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        // Update validation CSV files list
        function updateValidationCsvFilesList() {
            const container = document.getElementById('validationCsvFilesContainer');
            
            if (validationCsvFiles.length === 0) {
                container.innerHTML = '<div class="status info">No CSV files uploaded yet</div>';
                return;
            }

            let html = '';
            validationCsvFiles.forEach((file, index) => {
                const phoneColumn = findPhoneColumnInHeaders(file.headers);
                html += `
                    <div style="
                        padding: 10px;
                        margin: 5px 0;
                        background: #f8fafc;
                        border: 1px solid #e2e8f0;
                        border-radius: 6px;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                    ">
                        <div>
                            <strong>${file.name}</strong>
                            <br><small style="color: #6b7280;">
                                ${file.data.length} rows, Phone column: ${phoneColumn || 'Not found'}
                            </small>
                        </div>
                        <button class="btn btn-sm" onclick="removeValidationCsvFile(${index})" style="padding: 4px 8px; font-size: 12px;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        // Remove validation CSV file
        function removeValidationCsvFile(index) {
            validationCsvFiles.splice(index, 1);
            updateValidationCsvFilesList();
            document.getElementById('validateBulkBtn').disabled = validationCsvFiles.length === 0;
        }

        // Validate bulk numbers
        async function validateBulkNumbers() {
            if (validationCsvFiles.length === 0) {
                alert('Please upload CSV files first');
                return;
            }

            // Extract all phone numbers from CSV files
            const allPhoneNumbers = [];
            validationCsvFiles.forEach(file => {
                const phoneColumn = findPhoneColumnInHeaders(file.headers);
                if (phoneColumn) {
                    file.data.forEach(row => {
                        const phone = row[phoneColumn];
                        if (phone && phone.trim()) {
                            allPhoneNumbers.push(phone.trim());
                        }
                    });
                }
            });

            if (allPhoneNumbers.length === 0) {
                alert('No phone numbers found in uploaded CSV files');
                return;
            }

            if (allPhoneNumbers.length > 1000) {
                alert('Maximum 1000 phone numbers allowed per validation. Found: ' + allPhoneNumbers.length);
                return;
            }

            const progressDiv = document.getElementById('bulkValidationProgress');
            const progressBar = document.getElementById('bulkValidationProgressBar');
            const progressText = document.getElementById('bulkValidationProgressText');
            const resultDiv = document.getElementById('bulkValidationResult');

            progressDiv.style.display = 'block';
            progressBar.style.width = '0%';
            progressText.textContent = `Validating ${allPhoneNumbers.length} phone numbers...`;
            resultDiv.innerHTML = '';

            try {
                const selectedApi = document.querySelector('input[name="validationApi"]:checked').value;
                const endpoint = selectedApi === 'twilio' ? '/api/validate-numbers-bulk-twilio' : '/api/validate-numbers-bulk';
                const requestData = {
                    phoneNumbers: allPhoneNumbers
                };
                
                // Add API key based on selected service
                if (selectedApi === 'twilio') {
                    const accountSid = document.getElementById('twilioAccountSid').value.trim();
                    const authToken = document.getElementById('twilioAuthToken').value.trim();
                    if (accountSid && authToken) {
                        requestData.accountSid = accountSid;
                        requestData.authToken = authToken;
                    }
                } else {
                    // For Telnyx validation, add the stored API key
                    const telnyxApiKey = localStorage.getItem('telnyxApiKey') || localStorage.getItem('telynxAPIKey') || '';
                    if (telnyxApiKey) {
                        requestData.apiKey = telnyxApiKey;
                    }
                }
                
                const response = await makeApiCall(endpoint, requestData);

                // Check if response is ok before trying to parse JSON
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API Error Response:', errorText);
                    throw new Error(`API Error ${response.status}: ${errorText.substring(0, 200)}`);
                }

                const data = await response.json();

                if (data.success) {
                    progressBar.style.width = '100%';
                    progressText.textContent = `Complete! Validated: ${data.summary.successful}, Failed: ${data.summary.failed}`;

                    // Display results
                    let html = `
                        <div class="status success" style="padding: 15px; border-radius: 8px; background: #f0fdf4; border: 1px solid #bbf7d0;">
                            <h4 style="margin: 0 0 15px 0; color: #166534;">✅ Bulk Validation Complete ${data.api === 'twilio' ? '<span style="background: #059669; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-left: 8px;">Twilio</span>' : '<span style="background: #3b82f6; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-left: 8px;">Telnyx</span>'}</h4>
                            <div style="margin-bottom: 15px;">
                                <strong>Summary:</strong> ${data.summary.total} total, ${data.summary.successful} successful, ${data.summary.failed} failed
                            </div>
                    `;

                    if (data.results.length > 0) {
                        html += `
                            <div style="max-height: 400px; overflow-y: auto;">
                                <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                                    <thead>
                                        <tr style="border-bottom: 2px solid #e5e7eb;">
                                            <th style="text-align: left; padding: 8px; font-weight: 600;">Phone</th>
                                            <th style="text-align: left; padding: 8px; font-weight: 600;">Type</th>
                                            <th style="text-align: left; padding: 8px; font-weight: 600;">Carrier</th>
                                            <th style="text-align: left; padding: 8px; font-weight: 600;">Country</th>
                                            <th style="text-align: left; padding: 8px; font-weight: 600;">Valid</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                        `;

                        data.results.forEach(result => {
                            const typeColor = result.type === 'mobile' ? '#059669' : 
                                            result.type === 'landline' ? '#3b82f6' : 
                                            result.type === 'voip' ? '#f59e0b' : 
                                            result.type === 'fixed-line' ? '#3b82f6' :
                                            result.type === 'mobile-lte' ? '#059669' : '#6b7280';
                            
                            html += `
                                <tr style="border-bottom: 1px solid #f3f4f6;">
                                    <td style="padding: 8px;">${result.phoneNumber}</td>
                                    <td style="padding: 8px; color: ${typeColor}; font-weight: 600;">${result.type.toUpperCase()}</td>
                                    <td style="padding: 8px;">${result.carrier}</td>
                                    <td style="padding: 8px;">${result.countryName || result.countryCode}</td>
                                    <td style="padding: 8px;">${result.valid ? 'Yes' : 'No'}</td>
                                </tr>
                            `;
                        });

                        html += `
                                    </tbody>
                                </table>
                            </div>
                        `;
                    }

                    if (data.errors.length > 0) {
                        html += `
                            <div style="margin-top: 15px;">
                                <h5 style="color: #dc2626; margin-bottom: 10px;">❌ Errors:</h5>
                                <div style="max-height: 200px; overflow-y: auto;">
                        `;
                        
                        data.errors.forEach(error => {
                            html += `
                                <div style="padding: 5px; margin: 2px 0; background: #fef2f2; border-radius: 4px; font-size: 12px;">
                                    ${error.phoneNumber}: ${error.error}
                                </div>
                            `;
                        });
                        
                        html += `
                                </div>
                            </div>
                        `;
                    }

                    html += `
                            <div style="margin-top: 15px; font-size: 12px; color: #6b7280;">
                                Validated at: ${new Date(data.timestamp).toLocaleString()}
                            </div>
                        </div>
                    `;

                    resultDiv.innerHTML = html;

                    // Add CSV export functionality if grouped results are available
                    if (data.groupedResults && Object.keys(data.groupedResults).length > 0) {
                        setTimeout(() => {
                            generateCSVExport(data.groupedResults, data.api);
                        }, 1000);
                    }
                } else {
                    resultDiv.innerHTML = `<div class="status error">❌ Bulk validation failed: ${data.error}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="status error">❌ Error: ${error.message}</div>`;
            }

            // Hide progress after 5 seconds
            setTimeout(() => {
                progressDiv.style.display = 'none';
            }, 5000);
        }

        // Helper functions for phone validation
        let validationCsvFiles = [];

        // CSV Export function
        async function generateCSVExport(groupedResults, api) {
            try {
                console.log('📊 Generating CSV export for:', Object.keys(groupedResults));
                
                const response = await fetch('/api/export-csv', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        groupedResults: groupedResults,
                        api: api
                    })
                });

                const data = await response.json();
                
                if (data.success && data.csvFiles.length > 0) {
                    const resultDiv = document.getElementById('bulkValidationResult');
                    const exportHtml = `
                        <div style="margin-top: 15px; padding: 15px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px;">
                            <h5 style="margin: 0 0 10px 0; color: #1e293b;">📊 CSV Export Ready</h5>
                            <p style="margin: 0 0 15px 0; color: #64748b; font-size: 14px;">
                                Download CSV files for each phone number type:
                            </p>
                            <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                    `;
                    
                    data.csvFiles.forEach(file => {
                        const typeColor = file.type === 'mobile' ? '#059669' : 
                                        file.type === 'landline' ? '#3b82f6' : 
                                        file.type === 'voip' ? '#f59e0b' : 
                                        file.type === 'fixed-line' ? '#3b82f6' :
                                        file.type === 'mobile-lte' ? '#059669' : '#6b7280';
                        
                        exportHtml += `
                            <a href="${file.downloadUrl}" 
                               download="${file.fileName}"
                               style="display: inline-block; padding: 8px 12px; background: ${typeColor}; color: white; text-decoration: none; border-radius: 6px; font-size: 12px; font-weight: 500;">
                                📥 ${file.type.toUpperCase()} (${file.count})
                            </a>
                        `;
                    });
                    
                    exportHtml += `
                            </div>
                        </div>
                    `;
                    
                    resultDiv.innerHTML += exportHtml;
                }
            } catch (error) {
                console.error('❌ Error generating CSV export:', error);
            }
        }

        function findPhoneColumnInHeaders(headers) {
            const phoneColumns = ['phone', 'Phone', 'PHONE', 'phone_number', 'PhoneNumber', 'mobile', 'Mobile', 'MOBILE', 'cell', 'Cell', 'CELL', 'number', 'Number', 'NUMBER'];
            for (const col of phoneColumns) {
                if (headers.includes(col)) {
                    return col;
                }
            }
            return null;
        }

        // Start auto refresh
        function startAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            autoRefreshInterval = setInterval(loadIncomingMessages, 5000);
            loadIncomingMessages();
            console.log('🔄 Auto refresh started (every 5 seconds)');
        }

        // Stop auto refresh
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                console.log('⏹️ Auto refresh stopped');
            }
        }

        // Ensure conversations list is loaded when Messages section is shown
        function ensureConversationsLoaded() {
            console.log('🔍 Ensuring conversations are loaded...');
            const conversationsContainer = document.getElementById('conversationsContainer');
            if (conversationsContainer && conversationsContainer.innerHTML.trim() === '') {
                console.log('🔄 Conversations container is empty, reloading...');
                loadConversationsList();
            }
        }

        // Manual refresh conversations function
        function refreshConversations() {
            console.log('🔄 Manual refresh of conversations...');
            // Force reload from server for PWA
            forceReloadMessagesFromServer();
        }

        // Force reload all messages from server and update storage
        async function forceReloadMessagesFromServer() {
            console.log('🔄 Force reloading messages from server...');
            try {
                // Load incoming messages from server
                const incomingResponse = await fetch('/api/incoming-messages');
                if (incomingResponse.ok) {
                    const incomingData = await incomingResponse.json();
                    console.log('📱 Server incoming messages:', incomingData.messages?.length || 0);
                    if (incomingData.messages) {
                        saveIncomingMessages(incomingData.messages);
                    }
                }

                // Load sent messages from server
                const sentResponse = await fetch('/api/sent-messages');
                if (sentResponse.ok) {
                    const sentData = await sentResponse.json();
                    console.log('📤 Server sent messages:', sentData.messages?.length || 0);
                    if (sentData.messages) {
                        saveSentMessages(sentData.messages);
                    }
                }

                // Reload conversations
                loadConversationsList();
                console.log('✅ Force reload completed');
            } catch (error) {
                console.error('❌ Error force reloading messages:', error);
            }
        }

        // Load all messages (incoming and sent)
        async function loadAllMessages() {
            console.log('🔄 Loading all messages...');
            try {
                await loadIncomingMessages();
                await loadSentMessages();
                loadConversationsList();
                console.log('✅ All messages loaded successfully');
            } catch (error) {
                console.error('❌ Error loading all messages:', error);
            }
        }
        
        // Load conversations list
        function loadConversationsList() {
            console.log('🔄 Loading conversations list...');
            const conversationsContainer = document.getElementById('conversationsContainer');
            
            if (!conversationsContainer) {
                console.error('❌ conversationsContainer not found!');
                return;
            }
            
            const incomingMessages = loadIncomingMessagesFromStorage();
            const sentMessages = loadSentMessagesFromStorage();
            
            console.log('📱 Incoming messages:', incomingMessages.length);
            console.log('📤 Sent messages:', sentMessages.length);
            
            // Group messages by phone number
            // Also track lastIncomingTime per conversation for unread logic
            const conversations = {};
            
            // Add incoming messages
            incomingMessages.forEach(msg => {
                const phone = msg.from;
                if (!conversations[phone]) {
                    conversations[phone] = {
                        phone,
                        name: findContactByPhone(phone).name || phone,
                        lastMessage: msg.text,
                        lastTime: msg.timestamp,
                        lastIncomingTime: msg.timestamp
                    };
                } else {
                    // Update most recent message/time
                    if (new Date(msg.timestamp) > new Date(conversations[phone].lastTime)) {
                        conversations[phone].lastMessage = msg.text;
                        conversations[phone].lastTime = msg.timestamp;
                    }
                    // Track latest incoming time
                    if (!conversations[phone].lastIncomingTime || new Date(msg.timestamp) > new Date(conversations[phone].lastIncomingTime)) {
                        conversations[phone].lastIncomingTime = msg.timestamp;
                    }
                }
            });
            
            // Add sent messages
            sentMessages.forEach(msg => {
                const phone = msg.to;
                if (!conversations[phone]) {
                    conversations[phone] = {
                        phone,
                        name: findContactByPhone(phone).name || phone,
                        lastMessage: msg.text,
                        lastTime: msg.timestamp,
                        lastIncomingTime: conversations[phone]?.lastIncomingTime || null
                    };
                } else {
                    // Update if this message is more recent
                    if (new Date(msg.timestamp) > new Date(conversations[phone].lastTime)) {
                        conversations[phone].lastMessage = msg.text;
                        conversations[phone].lastTime = msg.timestamp;
                    }
                }
            });
            
            // Convert to array and sort by last message time
            const conversationsArray = Object.values(conversations).sort((a, b) => 
                new Date(b.lastTime) - new Date(a.lastTime)
            );
            
            console.log('💬 Total conversations:', conversationsArray.length);
            
            if (conversationsArray.length === 0) {
                conversationsContainer.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #6b7280;">
                        <i class="fas fa-comments" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                        No conversations yet
                    </div>
                `;
                return;
            }
            
            let html = '';
            conversationsArray.forEach(conversation => {
                // Determine unread: if latest incoming > last read timestamp
                const lastRead = conversationReadState[conversation.phone] || 0;
                const hasUnread = conversation.lastIncomingTime && (new Date(conversation.lastIncomingTime).getTime() > Number(lastRead));
                const time = new Date(conversation.lastTime);
                const timeAgo = getTimeAgo(time);
                const initials = conversation.name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
                
                html += `
                    <div class=\"conversation-item\" data-phone=\"${conversation.phone}\" onclick=\"selectConversation('${conversation.phone}', '${conversation.name}')\">
                        <div class="contact-avatar">${initials}</div>
                        <div class="contact-info">
                            <div class="contact-name">${conversation.name}</div>
                            <div class="contact-phone">${conversation.phone}</div>
                            <div class="last-message">${conversation.lastMessage}</div>
                        </div>
                        <div style="font-size: 11px; color: #8e8e93; margin-left: auto; text-align: right; min-width: 60px; display: flex; align-items: center; gap: 8px; justify-content: flex-end;">
                            <span>${timeAgo}</span>
                            ${hasUnread ? '<span class="unread-dot"></span>' : ''}
                        </div>
                    </div>
                `;
            });
            
            conversationsContainer.innerHTML = html;
            console.log('✅ Conversations list loaded successfully');
        }
        
        // Select conversation
        function selectConversation(phone, name) {
            currentConversation = { phone, name };
            // Mark as read when opening conversation view
            markConversationRead(phone);
            // Mark as read immediately
            markConversationRead(phone);
            
            // Update active state
            document.querySelectorAll('.conversation-item').forEach(item => {
                item.classList.remove('active');
            });
            if (event && event.target && event.target.closest) {
                event.target.closest('.conversation-item').classList.add('active');
            }
            
            if (window.innerWidth <= 768) {
                // Mobile: open inline chat view
                openConversation(phone, name);
                const iface = document.getElementById('messagesInterface');
                if (iface) iface.classList.add('show-chat');
            } else {
                // Desktop: open modal
                openConversationModal(phone, name);
            }
        }

        // Open conversation modal
        function openConversationModal(phone, name) {
            const modal = document.getElementById('conversationModal');
            // Mark as read when opening modal
            markConversationRead(phone);
            const modalContactAvatar = document.getElementById('modalContactAvatar');
            const modalContactName = document.getElementById('modalContactName');
            const modalContactPhone = document.getElementById('modalContactPhone');
            
            // Set modal header info
            const initials = name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
            modalContactAvatar.textContent = initials;
            modalContactName.textContent = name;
            modalContactPhone.textContent = phone;
            
            // Load conversation in modal
            loadModalConversation(phone);
            
            // Show modal
            modal.style.display = 'block';
            
            // Auto-detect and set the "from" number for replies
            autoDetectFromNumber(phone);
        }

        // Close conversation modal
        function closeConversationModal() {
            document.getElementById('conversationModal').style.display = 'none';
        }

        // Auto-detect from number based on conversation history
        function autoDetectFromNumber(phone) {
            const sentMessages = loadSentMessagesFromStorage();
            const outgoingMessages = sentMessages.filter(msg => msg.to === phone);
            
            if (outgoingMessages.length > 0) {
                const lastOutgoing = outgoingMessages[outgoingMessages.length - 1];
                // Set the from number in the main interface
                document.getElementById('fromNumber').value = lastOutgoing.from;
                console.log('Auto-detected from number:', lastOutgoing.from);
            }
        }

        // Load conversation in modal
        async function loadModalConversation(phone) {
            const modalChatMessages = document.getElementById('modalChatMessages');
            
            // Load messages for this conversation
            const incomingMessages = loadIncomingMessagesFromStorage();
            const sentMessages = loadSentMessagesFromStorage();
            
            // Filter messages for this phone number
            const conversationMessages = [
                ...incomingMessages.filter(msg => msg.from === phone),
                ...sentMessages.filter(msg => msg.to === phone)
            ].sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

            // Display messages with proper grouping
            if (conversationMessages.length > 0) {
                let html = '';
                let lastMessageType = null;
                let lastMessageTime = null;
                
                conversationMessages.forEach((msg, index) => {
                    const isIncoming = msg.from === phone;
                    const time = new Date(msg.timestamp);
                    const timeStr = time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    const dateStr = time.toLocaleDateString([], { month: 'short', day: 'numeric' });
                    
                    // Check if this message should be grouped with the previous one
                    const shouldGroup = lastMessageType === (isIncoming ? 'incoming' : 'outgoing') && 
                                      (time - lastMessageTime) < 60000; // Within 1 minute
                    
                    // Always show timestamp for every message
                    html += `
                        <div class="conversation-message ${isIncoming ? 'incoming' : 'outgoing'}">
                            <div class="message-content">
                                <div class="message-text">${msg.text}</div>
                                <div class="message-time">${dateStr} ${timeStr}</div>
                            </div>
                        </div>
                    `;
                    
                    lastMessageType = isIncoming ? 'incoming' : 'outgoing';
                    lastMessageTime = time;
                });

                modalChatMessages.innerHTML = html;
                modalChatMessages.scrollTop = modalChatMessages.scrollHeight;
                // Force apply iMessage styles
                setTimeout(() => forceIMessageStyles(), 100);
            } else {
                modalChatMessages.innerHTML = `
                    <div style="text-align: center; color: #8e8e93; padding: 40px;">
                        <i class="fas fa-comments" style="font-size: 48px; margin-bottom: 15px; display: block;"></i>
                        <div style="font-size: 18px; margin-bottom: 10px;">No messages yet</div>
                        <div style="font-size: 14px;">Start a conversation by sending a message</div>
                    </div>
                `;
            }
            
            // Auto-detect and set the "from" number for modal replies
            // First, try to find the "to" number from incoming messages (this is YOUR receiving number)
            const incomingMessagesForThisPhone = incomingMessages.filter(msg => msg.from === phone);
            if (incomingMessagesForThisPhone.length > 0) {
                const lastIncoming = incomingMessagesForThisPhone[incomingMessagesForThisPhone.length - 1];
                if (lastIncoming.to) {
                    document.getElementById('fromNumber').value = lastIncoming.to;
                    console.log('🎯 Modal: Auto-set FROM number from incoming message TO field:', lastIncoming.to);
                }
            } else {
                // Fallback: try to find from previous outgoing messages
                const outgoingMessages = sentMessages.filter(msg => msg.to === phone);
                if (outgoingMessages.length > 0) {
                    const lastOutgoing = outgoingMessages[outgoingMessages.length - 1];
                    document.getElementById('fromNumber').value = lastOutgoing.from;
                    console.log('🎯 Modal: Auto-set FROM number from outgoing message:', lastOutgoing.from);
                }
            }
        }

        // Send message from modal
        async function sendModalMessage() {
            const messageInput = document.getElementById('modalMessageInput');
            const message = messageInput.value.trim();
            let fromNumber = document.getElementById('fromNumber').value;

            if (!message) {
                alert('Please enter a message');
                return;
            }

            if (!fromNumber) {
                // Try to auto-detect from number one more time before failing
                if (currentConversation) {
                    const incomingMessages = loadIncomingMessagesFromStorage();
                    const incomingForThisPhone = incomingMessages.filter(msg => msg.from === currentConversation.phone);
                    if (incomingForThisPhone.length > 0) {
                        const lastIncoming = incomingForThisPhone[incomingForThisPhone.length - 1];
                        if (lastIncoming.to) {
                            fromNumber = lastIncoming.to;
                            document.getElementById('fromNumber').value = fromNumber;
                            console.log('🎯 Modal: Last chance auto-set FROM number:', fromNumber);
                        } else {
                            alert('Could not auto-detect your phone number. Please go to API Settings and ensure your phone numbers are loaded, then try again.');
                            return;
                        }
                    } else {
                        alert('Could not auto-detect your phone number. Please go to API Settings and ensure your phone numbers are loaded, then try again.');
                        return;
                    }
                } else {
                    alert('Could not auto-detect your phone number. Please go to API Settings and ensure your phone numbers are loaded, then try again.');
                    return;
                }
            }

            if (!currentConversation) {
                alert('No conversation selected');
                return;
            }

            try {
                const response = await fetch(`${getBackendBaseUrl()}/api/send-sms`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        apiKey: apiKey,
                        to: currentConversation.phone,
                        from: fromNumber,
                        message: message
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // Add to sent messages
                    const sentMessage = {
                        id: Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                        to: currentConversation.phone,
                        from: fromNumber,
                        text: message,
                        timestamp: new Date().toISOString(),
                        status: 'sent'
                    };
                    addSentMessage(sentMessage);

                    // Clear input
                    messageInput.value = '';

                    // Reload conversation
                    loadModalConversation(currentConversation.phone);

                    // Track sent message
                    const today = new Date().toDateString();
                    const currentSent = parseInt(localStorage.getItem(`sentMessages_${today}`) || '0');
                    localStorage.setItem(`sentMessages_${today}`, currentSent + 1);
                    updateStats();
                    
                    // Refresh conversations list
                    loadConversationsList();
                } else {
                    alert('Failed to send message: ' + data.error);
                }
            } catch (error) {
                alert('Error sending message: ' + error.message);
            }
        }

        // Make call from modal
        function makeCallFromModal() {
            if (currentConversation) {
                const fromNumber = document.getElementById('fromNumber').value;
                if (fromNumber) {
                    const phoneUrl = `${getBackendBaseUrl()}/phone-interface-webrtc.html?to=${encodeURIComponent(currentConversation.phone)}&from=${encodeURIComponent(fromNumber)}&name=${encodeURIComponent(currentConversation.name)}`;
                    window.open(phoneUrl, 'phone_interface', 'width=500,height=800,scrollbars=no,resizable=yes');
                } else {
                    alert('Please select a "From" phone number first');
                }
            }
        }

        // Load sent messages
        async function loadSentMessages() {
            const messagesDiv = document.getElementById('sentMessagesList');
            if (!messagesDiv) return;

            messagesDiv.innerHTML = '<div class="status info">Loading sent messages...</div>';

            try {
                // Load from localStorage (persistent storage)
                let storedMessages = loadSentMessagesFromStorage();
                console.log('📤 Loaded sent messages from localStorage:', storedMessages.length);

                // Try to fetch from backend
                console.log('🔄 Fetching sent messages from backend...');
                const response = await fetch(`${getBackendBaseUrl()}/api/sent-messages`);

                if (response.ok) {
                    const data = await response.json();
                    console.log('📨 Received sent messages from backend:', data);

                    if (data.messages && data.messages.length > 0) {
                        // Merge new messages with stored messages
                        const newMessages = data.messages.filter(newMsg => {
                            return !storedMessages.some(storedMsg => 
                                storedMsg.to === newMsg.to && 
                                storedMsg.text === newMsg.text && 
                                storedMsg.timestamp === newMsg.timestamp
                            );
                        });

                        if (newMessages.length > 0) {
                            console.log('🆕 Adding', newMessages.length, 'new sent messages to storage');
                            newMessages.forEach(msg => addSentMessage(msg));
                            storedMessages = loadSentMessagesFromStorage();
                        }
                    }
                } else {
                    console.log('⚠️ Backend not available for sent messages, using stored messages only');
                }

                // Display messages
                if (storedMessages && storedMessages.length > 0) {
                    let html = `
                        <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                            <thead>
                                <tr style="border-bottom: 2px solid #e5e7eb;">
                                    <th style="text-align: left; padding: 12px; font-weight: 600; color: #374151;">To</th>
                                    <th style="text-align: left; padding: 12px; font-weight: 600; color: #374151;">Message</th>
                                    <th style="text-align: left; padding: 12px; font-weight: 600; color: #374151;">Timestamp</th>
                                    <th style="text-align: center; padding: 12px; font-weight: 600; color: #374151;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;

                    storedMessages.forEach((msg, index) => {
                        const time = new Date(msg.timestamp);
                        const timeAgo = getTimeAgo(time);

                        // Try to find contact name
                        const contactInfo = findContactByPhone(msg.to);

                        html += `
                            <tr style="border-bottom: 1px solid #f3f4f6;">
                                <td style="padding: 12px; color: #374151; font-weight: 500;">
                                    ${contactInfo.name ? `<strong style="cursor: pointer; color: #3b82f6;" onclick="openConversation('${msg.to}', '${contactInfo.name}')">${contactInfo.name}</strong><br><small style="color: #9ca3af;">${msg.to}</small>` : `<span style="cursor: pointer; color: #3b82f6;" onclick="openConversation('${msg.to}', '${msg.to}')">${msg.to}</span>`}
                                </td>
                                <td style="padding: 12px; color: #6b7280;">${msg.text}</td>
                                <td style="padding: 12px; color: #9ca3af; font-size: 14px;">${timeAgo}</td>
                                <td style="padding: 12px; text-align: center;">
                                    <button class="btn btn-sm" onclick="deleteSentMessage('${msg.id}')" style="padding: 6px 12px; font-size: 12px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </td>
                            </tr>
                        `;
                    });

                    html += '</tbody></table>';
                    messagesDiv.innerHTML = html;
                } else {
                    messagesDiv.innerHTML = `
                        <div class="status info">
                            <i class="fas fa-paper-plane"></i> No sent messages yet
                            <br><small>Send an SMS to see it here</small>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('❌ Error loading sent messages:', error);
                messagesDiv.innerHTML = `
                    <div class="status error">
                        <i class="fas fa-exclamation-triangle"></i> Error loading sent messages: ${error.message}
                    </div>
                `;
            }
        }

        // Delete all messages
        function deleteAllMessages() {
            if (confirm('Are you sure you want to delete ALL messages (both incoming and sent)? This cannot be undone.')) {
                localStorage.removeItem('incomingMessages');
                localStorage.removeItem('sentMessages');
                loadAllMessages();
            }
        }

        // Open conversation
        function openConversation(phone, name) {
            currentConversation = { phone, name };
            showSection('incoming');
            // Switch to chat view on mobile
            if (window.innerWidth <= 768) {
                const iface = document.getElementById('messagesInterface');
                if (iface) iface.classList.add('show-chat');
            }
            
            // Load conversation history
            loadConversationHistory(phone);
        }

        // Load conversation history
        async function loadConversationHistory(phone) {
            const chatMessages = document.getElementById('chatMessages');
            const chatHeader = document.getElementById('chatHeader');
            
            if (!chatMessages || !chatHeader) return;

            // Set header
            chatHeader.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px; flex: 1;">
                    <div style="width: 32px; height: 32px; border-radius: 50%; background: #007aff; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 14px;">
                        ${currentConversation.name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2)}
                    </div>
                    <div>
                        <div style="font-weight: 600; color: #ffffff; font-size: 16px;">${currentConversation.name}</div>
                        <div style="font-size: 12px; color: #8e8e93;">${phone}</div>
                    </div>
                </div>
                <div style="display: flex; gap: 15px; align-items: center;">
                    <button style="width: 32px; height: 32px; background: transparent; border: none; color: #007aff; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-video" style="font-size: 16px;"></i>
                    </button>
                    <button style="width: 32px; height: 32px; background: transparent; border: none; color: #007aff; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-phone" style="font-size: 16px;"></i>
                    </button>
                    <button style="width: 32px; height: 32px; background: transparent; border: none; color: #007aff; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-info-circle" style="font-size: 16px;"></i>
                    </button>
                </div>
            `;

            // Load messages for this conversation
            const incomingMessages = loadIncomingMessagesFromStorage();
            const sentMessages = loadSentMessagesFromStorage();
            
            // Filter messages for this phone number
            const conversationMessages = [
                ...incomingMessages.filter(msg => msg.from === phone),
                ...sentMessages.filter(msg => msg.to === phone)
            ].sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

            // Display messages with proper grouping
            if (conversationMessages.length > 0) {
                let html = '';
                let lastMessageType = null;
                let lastMessageTime = null;
                
                conversationMessages.forEach((msg, index) => {
                    const isIncoming = msg.from === phone;
                    const time = new Date(msg.timestamp);
                    const timeStr = time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    const dateStr = time.toLocaleDateString([], { month: 'short', day: 'numeric' });
                    
                    // Check if this message should be grouped with the previous one
                    const shouldGroup = lastMessageType === (isIncoming ? 'incoming' : 'outgoing') && 
                                      (time - lastMessageTime) < 60000; // Within 1 minute
                    
                    // Always show timestamp for every message
                    html += `
                        <div class="conversation-message ${isIncoming ? 'incoming' : 'outgoing'}">
                            <div class="message-content">
                                <div class="message-text">${msg.text}</div>
                                <div class="message-time">${dateStr} ${timeStr}</div>
                            </div>
                        </div>
                    `;
                    
                    lastMessageType = isIncoming ? 'incoming' : 'outgoing';
                    lastMessageTime = time;
                });

                chatMessages.innerHTML = html;
                chatMessages.scrollTop = chatMessages.scrollHeight;
                // Force apply iMessage styles
                setTimeout(() => forceIMessageStyles(), 100);
            } else {
                chatMessages.innerHTML = `
                    <div style="text-align: center; color: #6b7280; padding: 20px;">
                        <i class="fas fa-comments" style="font-size: 48px; margin-bottom: 10px;"></i>
                        <div>No messages yet</div>
                        <div style="font-size: 12px;">Start a conversation by sending a message</div>
                    </div>
                `;
            }

            // Auto-detect and set the "from" number for replies
            // First, try to find the "to" number from incoming messages (this is YOUR receiving number)
            const incomingMessagesForThisPhone = incomingMessages.filter(msg => msg.from === phone);
            if (incomingMessagesForThisPhone.length > 0) {
                const lastIncoming = incomingMessagesForThisPhone[incomingMessagesForThisPhone.length - 1];
                if (lastIncoming.to) {
                    document.getElementById('fromNumber').value = lastIncoming.to;
                    console.log('🎯 Auto-set FROM number from incoming message TO field:', lastIncoming.to);
                }
            } else {
                // Fallback: try to find from previous outgoing messages
                const outgoingMessages = sentMessages.filter(msg => msg.to === phone);
                if (outgoingMessages.length > 0) {
                    const lastOutgoing = outgoingMessages[outgoingMessages.length - 1];
                    document.getElementById('fromNumber').value = lastOutgoing.from;
                    console.log('🎯 Auto-set FROM number from outgoing message:', lastOutgoing.from);
                }
            }
        }

        // Send quick message from conversation
        async function sendQuickMessage() {
            const messageInput = document.getElementById('quickMessageInput');
            const message = messageInput.value.trim();
            let fromNumber = document.getElementById('fromNumber').value;

            if (!message) {
                alert('Please enter a message');
                return;
            }

            if (!fromNumber) {
                // Try to auto-detect from number one more time before failing
                if (currentConversation) {
                    const incomingMessages = loadIncomingMessagesFromStorage();
                    const incomingForThisPhone = incomingMessages.filter(msg => msg.from === currentConversation.phone);
                    if (incomingForThisPhone.length > 0) {
                        const lastIncoming = incomingForThisPhone[incomingForThisPhone.length - 1];
                        if (lastIncoming.to) {
                            fromNumber = lastIncoming.to;
                            document.getElementById('fromNumber').value = fromNumber;
                            console.log('🎯 Quick: Last chance auto-set FROM number:', fromNumber);
                        } else {
                            alert('Could not auto-detect your phone number. Please go to API Settings and ensure your phone numbers are loaded, then try again.');
                            return;
                        }
                    } else {
                        alert('Could not auto-detect your phone number. Please go to API Settings and ensure your phone numbers are loaded, then try again.');
                        return;
                    }
                } else {
                    alert('Could not auto-detect your phone number. Please go to API Settings and ensure your phone numbers are loaded, then try again.');
                    return;
                }
            }

            if (!currentConversation) {
                alert('No conversation selected');
                return;
            }

            try {
                const response = await fetch(`${getBackendBaseUrl()}/api/send-sms`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        apiKey: apiKey,
                        to: currentConversation.phone,
                        from: fromNumber,
                        message: message
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // Add to sent messages
                    const sentMessage = {
                        id: Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                        to: currentConversation.phone,
                        from: fromNumber,
                        text: message,
                        timestamp: new Date().toISOString(),
                        status: 'sent'
                    };
                    addSentMessage(sentMessage);

                    // Clear input
                    messageInput.value = '';

                    // Reload conversation
                    loadConversationHistory(currentConversation.phone);

                    // Track sent message
                    const today = new Date().toDateString();
                    const currentSent = parseInt(localStorage.getItem(`sentMessages_${today}`) || '0');
                    localStorage.setItem(`sentMessages_${today}`, currentSent + 1);
                    updateStats();
                } else {
                    alert('Failed to send message: ' + data.error);
                }
            } catch (error) {
                alert('Error sending message: ' + error.message);
            }
        }

        // Show reply form
        function showReplyForm(phone, name) {
            currentConversation = { phone, name };
            openConversation(phone, name);
        }

        // Check backend connection
        async function checkBackendConnection() {
            console.log('🔍 Checking backend connection...');
            try {
                const response = await fetch(`${getBackendBaseUrl()}/api/business-hours-status`);
                console.log('📡 Backend response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('✅ Backend connected, business hours status:', data);
                    isBackendConnected = true;
                    return true;
                } else {
                    console.log('❌ Backend responded with error status:', response.status);
                    isBackendConnected = false;
                    return false;
                }
            } catch (error) {
                console.log('❌ Backend connection failed:', error.message);
                isBackendConnected = false;
                return false;
            }
        }

        // Test connection with better error handling
        async function testConnection() {
            const statusDiv = document.getElementById('systemStatus');
            statusDiv.innerHTML = '<div class="status info">🔄 Testing connection...</div>';

            try {
                const isConnected = await checkBackendConnection();
                
                if (isConnected) {
                    statusDiv.innerHTML = `
                        <div class="status success">✅ Backend Connected!</div>
                        <div style="margin-top: 10px;">
                            <button class="btn btn-sm" onclick="loadAllMessages()" style="margin-right: 5px;">
                                <i class="fas fa-sync"></i> Load Messages
                            </button>
                            <button class="btn btn-sm" onclick="window.open(getBackendBaseUrl(), '_blank')">
                                <i class="fas fa-external-link-alt"></i> Open Backend URL
                            </button>
                        </div>
                    `;
                } else {
                    statusDiv.innerHTML = `
                        <div class="status error">❌ Backend Disconnected</div>
                        <div style="margin-top: 10px; font-size: 12px; color: #6b7280;">
                            Make sure your backend is running:<br>
                            <a href="${getBackendBaseUrl()}" target="_blank" style="color: #3b82f6;" id="backendStatusUrl">
                                ${getBackendBaseUrl()}
                            </a>
                        </div>
                    `;
                }
            } catch (error) {
                statusDiv.innerHTML = `
                    <div class="status error">❌ Connection Test Failed</div>
                    <div style="margin-top: 10px; font-size: 12px; color: #6b7280;">
                        Error: ${error.message}<br>
                        Try opening the backend URL directly: <a href="${getBackendBaseUrl()}" target="_blank" style="color: #3b82f6;">${getBackendBaseUrl()}</a>
                    </div>
                `;
            }
        }

        // Update connection status
        function updateConnectionStatus() {
            const statusDiv = document.getElementById('systemStatus');
            
            if (isBackendConnected) {
                statusDiv.innerHTML = `
                    <div class="status success">✅ Backend Connected</div>
                    <div style="margin-top: 10px;">
                        <button class="btn btn-sm" onclick="testConnection()" style="margin-right: 5px;">
                            <i class="fas fa-sync"></i> Test Connection
                        </button>
                        <button class="btn btn-sm" onclick="loadAllMessages()" style="margin-right: 5px;">
                            <i class="fas fa-sync"></i> Load Messages
                        </button>
                    </div>
                `;
            } else {
                statusDiv.innerHTML = `
                    <div class="status error">❌ Backend Disconnected</div>
                    <div style="margin-top: 10px;">
                        <button class="btn btn-sm" onclick="testConnection()" style="margin-right: 5px;">
                            <i class="fas fa-sync"></i> Test Connection
                        </button>
                        <button class="btn btn-sm" onclick="window.open(getBackendBaseUrl(), '_blank')">
                            <i class="fas fa-external-link-alt"></i> Open Backend URL
                        </button>
                    </div>
                `;
            }
        }

        // Force apply iMessage styles to all message bubbles
        function forceIMessageStyles() {
            const messages = document.querySelectorAll('.conversation-message');
            messages.forEach(message => {
                const content = message.querySelector('.message-content');
                if (content) {
                    content.style.maxWidth = '70%';
                    content.style.minWidth = 'fit-content';
                    content.style.width = 'fit-content';
                    content.style.padding = '3px 7px';
                    content.style.borderRadius = '15px';
                    content.style.fontSize = '12px';
                    content.style.lineHeight = '1.3';
                    content.style.fontWeight = '400';
                    content.style.letterSpacing = '0';
                    content.style.margin = '0';
                    content.style.display = 'inline-block';
                    content.style.color = '#ffffff';
                    
                    if (message.classList.contains('incoming')) {
                        content.style.background = '#3a3a3c';
                        content.style.color = '#ffffff';
                        content.style.borderBottomLeftRadius = '3px';
                        content.style.marginLeft = '2px';
                    } else {
                        content.style.background = '#007aff';
                        content.style.color = '#ffffff';
                        content.style.borderBottomRightRadius = '3px';
                        content.style.marginRight = '2px';
                    }
                }
                
                const time = message.querySelector('.message-time');
                if (time) {
                    time.style.fontSize = '7px';
                    time.style.opacity = '0.6';
                    time.style.marginTop = '1px';
                    time.style.fontWeight = '400';
                    time.style.display = 'block';
                }
                
                // Add spacing between messages
                message.style.marginBottom = '6px';
            });
        }

        // Voice Calling Functions
        let bulkCallsCsvFiles = [];
        let callHistory = [];

        // Load call history from localStorage
        function loadCallHistory() {
            const saved = localStorage.getItem('callHistory');
            if (saved) {
                try {
                    callHistory = JSON.parse(saved);
                    displayCallHistory();
                } catch (e) {
                    console.error('Error loading call history:', e);
                    callHistory = [];
                }
            }
        }

        // Save call history to localStorage
        function saveCallHistory() {
            localStorage.setItem('callHistory', JSON.stringify(callHistory));
        }

        // Display call history
        function displayCallHistory() {
            const container = document.getElementById('callHistoryContainer');
            if (!container) return;

            if (callHistory.length === 0) {
                container.innerHTML = '<div class="status info">No calls made yet</div>';
                return;
            }

            let html = '<div style="max-height: 300px; overflow-y: auto;">';
            callHistory.forEach((call, index) => {
                const statusColor = call.status === 'completed' ? '#059669' : 
                                  call.status === 'failed' ? '#dc2626' : 
                                  call.status === 'answered' ? '#3b82f6' : '#6b7280';
                
                html += `
                    <div style="padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px; margin-bottom: 8px; background: #f9fafb;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                            <strong>${call.to}</strong>
                            <span style="color: ${statusColor}; font-weight: 600; text-transform: uppercase; font-size: 12px;">
                                ${call.status}
                            </span>
                        </div>
                        <div style="font-size: 12px; color: #6b7280;">
                            From: ${call.from} | ${new Date(call.timestamp).toLocaleString()}
                        </div>
                        ${call.error ? `<div style="font-size: 12px; color: #dc2626; margin-top: 5px;">Error: ${call.error}</div>` : ''}
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }

        // Clear call history
        function clearCallHistory() {
            if (confirm('Are you sure you want to clear all call history?')) {
                callHistory = [];
                saveCallHistory();
                displayCallHistory();
            }
        }

        // Handle bulk calls CSV upload
        function handleBulkCallsCsvUpload(input) {
            const file = input.files[0];
            if (!file) return;

            if (!file.name.toLowerCase().endsWith('.csv')) {
                alert('Please select a CSV file');
                return;
            }

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const csv = e.target.result;
                    const lines = csv.split('\n');
                    const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                    
                    const data = [];
                    for (let i = 1; i < lines.length; i++) {
                        if (lines[i].trim()) {
                            const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                            const row = {};
                            headers.forEach((header, index) => {
                                row[header] = values[index] || '';
                            });
                            data.push(row);
                        }
                    }

                    bulkCallsCsvFiles.push({
                        name: file.name,
                        data: data,
                        headers: headers
                    });

                    updateBulkCallsCsvFilesList();
                    document.getElementById('makeBulkCallsBtn').disabled = false;

                } catch (error) {
                    alert('Error reading CSV file: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        // Update bulk calls CSV files list
        function updateBulkCallsCsvFilesList() {
            const container = document.getElementById('bulkCallsCsvFilesContainer');
            if (!container) return;

            if (bulkCallsCsvFiles.length === 0) {
                container.innerHTML = '<div class="status info">No CSV files uploaded yet</div>';
                return;
            }

            let html = '';
            bulkCallsCsvFiles.forEach((file, index) => {
                html += `
                    <div style="padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px; margin-bottom: 8px; background: #f9fafb;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${file.name}</strong>
                                <div style="font-size: 12px; color: #6b7280;">${file.data.length} phone numbers</div>
                            </div>
                            <button class="btn btn-sm" onclick="removeBulkCallsCsvFile(${index})" style="background: #dc2626; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                                Remove
                            </button>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        // Remove bulk calls CSV file
        function removeBulkCallsCsvFile(index) {
            bulkCallsCsvFiles.splice(index, 1);
            updateBulkCallsCsvFilesList();
            document.getElementById('makeBulkCallsBtn').disabled = bulkCallsCsvFiles.length === 0;
        }

        // Make single call
        async function makeSingleCall() {
            const fromNumber = document.getElementById('callFromNumber').value;
            const toNumber = document.getElementById('callToNumber').value;
            const audioUrl = document.getElementById('audioMessageUrl').value;
            const resultDiv = document.getElementById('singleCallResult');

            if (!fromNumber || !toNumber) {
                resultDiv.innerHTML = '<div class="status error">Please select a from number and enter a destination number</div>';
                return;
            }

            // Validate phone number format
            if (!toNumber.startsWith('+')) {
                resultDiv.innerHTML = '<div class="status error">Phone number must start with + (e.g., +1234567890)</div>';
                return;
            }

            resultDiv.innerHTML = '<div class="status info">Making call...</div>';
            document.getElementById('makeCallBtn').disabled = true;

            try {
                const response = await fetch('/api/make-call', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        apiKey: apiKey,
                        from: fromNumber,
                        to: toNumber,
                        audioUrl: audioUrl
                    })
                });

                const data = await response.json();

                if (data.success) {
                    resultDiv.innerHTML = '<div class="status success">✅ Call initiated successfully! Call ID: ' + data.callId + '</div>';
                    
                    // Add to call history
                    callHistory.unshift({
                        from: fromNumber,
                        to: toNumber,
                        status: 'initiated',
                        timestamp: new Date().toISOString(),
                        callId: data.callId
                    });
                    saveCallHistory();
                    displayCallHistory();
                } else {
                    resultDiv.innerHTML = '<div class="status error">❌ Call failed: ' + data.error + '</div>';
                    
                    // Add to call history with error
                    callHistory.unshift({
                        from: fromNumber,
                        to: toNumber,
                        status: 'failed',
                        timestamp: new Date().toISOString(),
                        error: data.error
                    });
                    saveCallHistory();
                    displayCallHistory();
                }
            } catch (error) {
                resultDiv.innerHTML = '<div class="status error">❌ Error: ' + error.message + '</div>';
                
                // Add to call history with error
                callHistory.unshift({
                    from: fromNumber,
                    to: toNumber,
                    status: 'failed',
                    timestamp: new Date().toISOString(),
                    error: error.message
                });
                saveCallHistory();
                displayCallHistory();
            }

            document.getElementById('makeCallBtn').disabled = false;
        }

        // Make bulk calls
        async function makeBulkCalls() {
            if (bulkCallsCsvFiles.length === 0) {
                alert('Please upload a CSV file first');
                return;
            }

            const fromNumber = document.getElementById('callFromNumber').value;
            const audioUrl = document.getElementById('audioMessageUrl').value;
            const delay = parseInt(document.getElementById('callDelay').value) || 5;

            if (!fromNumber) {
                alert('Please select a from number');
                return;
            }

            const progressDiv = document.getElementById('bulkCallsProgress');
            const progressBar = document.getElementById('bulkCallsProgressBar');
            const progressText = document.getElementById('bulkCallsProgressText');
            const resultDiv = document.getElementById('bulkCallsResult');

            progressDiv.style.display = 'block';
            progressBar.style.width = '0%';
            progressText.textContent = 'Starting bulk calls...';
            resultDiv.innerHTML = '';
            document.getElementById('makeBulkCallsBtn').disabled = true;

            try {
                // Get all phone numbers from CSV files
                const allPhoneNumbers = [];
                bulkCallsCsvFiles.forEach(file => {
                    const phoneColumn = findPhoneColumnInHeaders(file.headers);
                    if (phoneColumn) {
                        file.data.forEach(row => {
                            const phone = row[phoneColumn];
                            if (phone && phone.trim()) {
                                allPhoneNumbers.push(phone.trim());
                            }
                        });
                    }
                });

                if (allPhoneNumbers.length === 0) {
                    throw new Error('No valid phone numbers found in CSV files');
                }

                console.log(`📞 Starting bulk calls to ${allPhoneNumbers.length} numbers`);

                const results = [];
                const errors = [];

                for (let i = 0; i < allPhoneNumbers.length; i++) {
                    const phoneNumber = allPhoneNumbers[i];
                    
                    // Format phone number
                    let formattedPhone = phoneNumber;
                    if (!formattedPhone.startsWith('+')) {
                        formattedPhone = '+' + formattedPhone.replace(/[^\d]/g, '');
                    }

                    try {
                        const response = await fetch('/api/make-call', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                apiKey: apiKey,
                                from: fromNumber,
                                to: formattedPhone,
                                audioUrl: audioUrl
                            })
                        });

                        const data = await response.json();

                        if (data.success) {
                            results.push({
                                phoneNumber: formattedPhone,
                                status: 'initiated',
                                callId: data.callId
                            });
                            
                            // Add to call history
                            callHistory.unshift({
                                from: fromNumber,
                                to: formattedPhone,
                                status: 'initiated',
                                timestamp: new Date().toISOString(),
                                callId: data.callId
                            });
                        } else {
                            errors.push({
                                phoneNumber: formattedPhone,
                                error: data.error
                            });
                            
                            // Add to call history with error
                            callHistory.unshift({
                                from: fromNumber,
                                to: formattedPhone,
                                status: 'failed',
                                timestamp: new Date().toISOString(),
                                error: data.error
                            });
                        }

                        // Update progress
                        const progress = ((i + 1) / allPhoneNumbers.length) * 100;
                        progressBar.style.width = progress + '%';
                        progressText.textContent = `Calling ${i + 1}/${allPhoneNumbers.length}: ${formattedPhone}`;

                        // Add delay between calls
                        if (i < allPhoneNumbers.length - 1) {
                            await new Promise(resolve => setTimeout(resolve, delay * 1000));
                        }

                    } catch (error) {
                        errors.push({
                            phoneNumber: formattedPhone,
                            error: error.message
                        });
                        
                        // Add to call history with error
                        callHistory.unshift({
                            from: fromNumber,
                            to: formattedPhone,
                            status: 'failed',
                            timestamp: new Date().toISOString(),
                            error: error.message
                        });
                    }
                }

                // Save call history
                saveCallHistory();
                displayCallHistory();

                // Display results
                let html = `
                    <div class="status success" style="padding: 15px; border-radius: 8px; background: #f0fdf4; border: 1px solid #bbf7d0;">
                        <h4 style="margin: 0 0 15px 0; color: #166534;">✅ Bulk Calls Complete</h4>
                        <div style="margin-bottom: 15px;">
                            <strong>Summary:</strong> ${allPhoneNumbers.length} total, ${results.length} successful, ${errors.length} failed
                        </div>
                `;

                if (results.length > 0) {
                    html += `
                        <div style="max-height: 200px; overflow-y: auto; margin-bottom: 15px;">
                            <h5 style="color: #059669; margin-bottom: 10px;">✅ Successful Calls:</h5>
                    `;
                    
                    results.forEach(result => {
                        html += `
                            <div style="padding: 5px; margin: 2px 0; background: #f0fdf4; border-radius: 4px; font-size: 12px;">
                                ${result.phoneNumber} - Call ID: ${result.callId}
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                }

                if (errors.length > 0) {
                    html += `
                        <div style="max-height: 200px; overflow-y: auto;">
                            <h5 style="color: #dc2626; margin-bottom: 10px;">❌ Failed Calls:</h5>
                    `;
                    
                    errors.forEach(error => {
                        html += `
                            <div style="padding: 5px; margin: 2px 0; background: #fef2f2; border-radius: 4px; font-size: 12px;">
                                ${error.phoneNumber}: ${error.error}
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                }

                html += `
                        <div style="margin-top: 15px; font-size: 12px; color: #6b7280;">
                            Completed at: ${new Date().toLocaleString()}
                        </div>
                    </div>
                `;

                resultDiv.innerHTML = html;

            } catch (error) {
                resultDiv.innerHTML = `<div class="status error">❌ Error: ${error.message}</div>`;
            }

            // Hide progress after 5 seconds
            setTimeout(() => {
                progressDiv.style.display = 'none';
            }, 5000);

            document.getElementById('makeBulkCallsBtn').disabled = false;
        }

        // PWA Installation and Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('SW registered: ', registration);
                    })
                    .catch(registrationError => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }

        // PWA Install Prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            showPWAInstallPrompt();
        });

        function showPWAInstallPrompt() {
            const installPrompt = document.createElement('div');
            installPrompt.id = 'pwaInstallPrompt';
            installPrompt.innerHTML = `
                <div style="position: fixed; top: 20px; right: 20px; background: #1e3a8a; color: white; padding: 15px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 10000; max-width: 300px;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <i class="fas fa-download" style="font-size: 18px;"></i>
                        <strong>Install CodeLife SMS</strong>
                    </div>
                    <p style="margin: 0 0 10px 0; font-size: 14px;">Add to home screen for the best experience</p>
                    <div style="display: flex; gap: 8px;">
                        <button onclick="installPWA()" style="background: #059669; color: white; border: none; padding: 8px 12px; border-radius: 4px; font-size: 12px; cursor: pointer;">Install</button>
                        <button onclick="dismissPWAInstall()" style="background: transparent; color: white; border: 1px solid white; padding: 8px 12px; border-radius: 4px; font-size: 12px; cursor: pointer;">Later</button>
                    </div>
                </div>
            `;
            document.body.appendChild(installPrompt);
        }

        function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('User accepted the install prompt');
                    } else {
                        console.log('User dismissed the install prompt');
                    }
                    deferredPrompt = null;
                });
            }
            dismissPWAInstall();
        }

        function dismissPWAInstall() {
            const prompt = document.getElementById('pwaInstallPrompt');
            if (prompt) {
                prompt.remove();
            }
        }

        // Mobile-specific function to ensure API settings load
        function forceLoadMobileSettings() {
            console.log('Force loading mobile settings...');
            
            // Load saved API key
            const savedApiKey = localStorage.getItem('telnyxApiKey');
            if (savedApiKey) {
                const apiKeyInput = document.getElementById('apiKey');
                if (apiKeyInput) {
                    apiKeyInput.value = savedApiKey;
                    apiKey = savedApiKey;
                    console.log('API key loaded:', savedApiKey.substring(0, 10) + '...');
                }
            }
            
            // Test API connection
            setTimeout(() => {
                testAPIConnection();
            }, 500);
            
            // Load phone numbers
            setTimeout(() => {
                const savedPhoneNumbers = localStorage.getItem('telnyxPhoneNumbers');
                if (savedPhoneNumbers) {
                    try {
                        phoneNumbers = JSON.parse(savedPhoneNumbers);
                        updatePhoneNumberSelects();
                        console.log('Phone numbers loaded:', phoneNumbers.length);
                    } catch (error) {
                        console.error('Error loading phone numbers:', error);
                    }
                }
            }, 1000);
        }

        // Initialize connection status on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Force load mobile settings if on mobile
            if (window.innerWidth <= 768) {
                console.log('Mobile device detected, forcing settings load...');
                setTimeout(() => {
                    forceLoadMobileSettings();
                }, 500);
            }
            
            // Test backend connection on load
            setTimeout(() => {
                checkBackendConnection().then(() => {
                    updateConnectionStatus();
                });
            }, 1000);
            
            // Load messages on page load
            setTimeout(() => {
                loadAllMessages();
                // Force apply iMessage styles after loading messages
                setTimeout(() => {
                    forceIMessageStyles();
                    // Ensure conversations are loaded for mobile
                    if (window.innerWidth <= 768) {
                        ensureConversationsLoaded();
                    }
                    // Auto-sync for PWA
                    autoSyncForPWA();
                }, 500);
            }, 2000);
            
            // Load call history
            loadCallHistory();
            
            // Initialize WebRTC
            initializeWebRTC();
        });

        // WebRTC Variables
        let telnyxClient = null;
        let currentCall = null;
        let isConnected = false;
        let isMuted = false;
        let callStartTime = null;
        let callDurationInterval = null;
        let ringingAudio = null;
        let webrtcCallLog = [];

        // Initialize WebRTC
        function initializeWebRTC() {
            // Create audio element for ringing
            ringingAudio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT');
            
            // Load call log from localStorage
            loadWebRTCCallLog();
            
            // Initialize volume controls
            initializeVolumeControls();
        }

        // Initialize volume controls
        function initializeVolumeControls() {
            const speakerVolume = document.getElementById('speakerVolume');
            const micVolume = document.getElementById('micVolume');
            const speakerVolumeValue = document.getElementById('speakerVolumeValue');
            const micVolumeValue = document.getElementById('micVolumeValue');

            speakerVolume.addEventListener('input', function() {
                speakerVolumeValue.textContent = this.value + '%';
                if (currentCall) {
                    currentCall.setVolume(this.value / 100);
                }
            });

            micVolume.addEventListener('input', function() {
                micVolumeValue.textContent = this.value + '%';
                if (currentCall) {
                    currentCall.setMicrophoneVolume(this.value / 100);
                }
            });
        }

        // Connect to Telnyx WebRTC
        async function connectWebRTC() {
            const statusDiv = document.getElementById('webrtcStatus');
            const connectBtn = document.getElementById('connectBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');

            // Check if TelnyxRTC is available
            if (typeof TelnyxRTC === 'undefined') {
                statusDiv.innerHTML = '<div class="status error"><i class="fas fa-exclamation-triangle"></i> Telnyx WebRTC SDK not loaded. Please refresh the page.</div>';
                return;
            }

            if (!apiKey) {
                statusDiv.innerHTML = '<div class="status error"><i class="fas fa-exclamation-triangle"></i> API key not configured</div>';
                return;
            }

            try {
                statusDiv.innerHTML = '<div class="status info"><i class="fas fa-spinner fa-spin"></i> Connecting...</div>';
                connectBtn.disabled = true;

                // Get Telnyx token from server
                const response = await fetch('/api/webrtc-token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        apiKey: apiKey
                    })
                });

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'Failed to get WebRTC token');
                }

                // Initialize Telnyx client
                telnyxClient = new TelnyxRTC({
                    credentials: {
                        token: data.token
                    }
                });

                // Set up event listeners
                telnyxClient.on('telnyx.socket.open', () => {
                    console.log('WebRTC connected');
                    isConnected = true;
                    statusDiv.innerHTML = '<div class="status success"><i class="fas fa-circle" style="color: #059669;"></i> Connected</div>';
                    connectBtn.disabled = true;
                    disconnectBtn.disabled = false;
                    addToCallLog('Connected to Telnyx WebRTC', 'info');
                });

                telnyxClient.on('telnyx.socket.close', () => {
                    console.log('WebRTC disconnected');
                    isConnected = false;
                    statusDiv.innerHTML = '<div class="status error"><i class="fas fa-circle" style="color: #dc2626;"></i> Disconnected</div>';
                    connectBtn.disabled = false;
                    disconnectBtn.disabled = true;
                    addToCallLog('Disconnected from Telnyx WebRTC', 'error');
                });

                telnyxClient.on('telnyx.socket.error', (error) => {
                    console.error('WebRTC error:', error);
                    statusDiv.innerHTML = '<div class="status error"><i class="fas fa-exclamation-triangle"></i> Connection error</div>';
                    addToCallLog('Connection error: ' + error.message, 'error');
                });

                // Handle incoming calls
                telnyxClient.on('telnyx.rtc.invite', (invite) => {
                    console.log('Incoming call:', invite);
                    handleIncomingCall(invite);
                });

                // Handle call events
                telnyxClient.on('telnyx.rtc.call.answered', (call) => {
                    console.log('Call answered:', call);
                    addToCallLog('Call answered', 'success');
                });

                telnyxClient.on('telnyx.rtc.call.hangup', (call) => {
                    console.log('Call ended:', call);
                    hideAllCallInterfaces();
                    stopCallTimer();
                    addToCallLog('Call ended', 'info');
                });

                telnyxClient.on('telnyx.rtc.call.failed', (call) => {
                    console.log('Call failed:', call);
                    hideAllCallInterfaces();
                    addToCallLog('Call failed', 'error');
                });

                // Connect to Telnyx
                await telnyxClient.connect();

            } catch (error) {
                console.error('WebRTC connection error:', error);
                statusDiv.innerHTML = '<div class="status error"><i class="fas fa-exclamation-triangle"></i> ' + error.message + '</div>';
                connectBtn.disabled = false;
                addToCallLog('Connection failed: ' + error.message, 'error');
            }
        }

        // Disconnect from Telnyx WebRTC
        function disconnectWebRTC() {
            if (telnyxClient) {
                telnyxClient.disconnect();
                telnyxClient = null;
            }
            
            if (currentCall) {
                currentCall.hangup();
                currentCall = null;
            }
            
            hideAllCallInterfaces();
            addToCallLog('Disconnected from Telnyx WebRTC', 'info');
        }

        // Handle incoming call
        function handleIncomingCall(invite) {
            const callerNumber = invite.from?.number || 'Unknown';
            
            // Show incoming call interface
            document.getElementById('incomingCallInterface').style.display = 'block';
            document.getElementById('callerNumber').textContent = callerNumber;
            document.getElementById('callStatus').textContent = 'Incoming call...';
            
            // Play ringing sound
            playRingingSound();
            
            // Show browser notification
            showCallNotification(callerNumber);
            
            // Store current call
            currentCall = invite;
            
            addToCallLog('Incoming call from ' + callerNumber, 'info');
        }

        // Answer call
        async function answerCall() {
            if (!currentCall) return;
            
            try {
                await currentCall.accept();
                
                // Hide incoming call interface
                document.getElementById('incomingCallInterface').style.display = 'none';
                
                // Show active call interface
                document.getElementById('activeCallInterface').style.display = 'block';
                document.getElementById('activeCallerNumber').textContent = currentCall.from?.number || 'Unknown';
                
                // Stop ringing
                stopRingingSound();
                
                // Start call timer
                startCallTimer();
                
                addToCallLog('Call answered', 'success');
                
            } catch (error) {
                console.error('Error answering call:', error);
                addToCallLog('Failed to answer call: ' + error.message, 'error');
            }
        }

        // Reject call
        async function rejectCall() {
            if (!currentCall) return;
            
            try {
                await currentCall.reject();
                hideAllCallInterfaces();
                stopRingingSound();
                addToCallLog('Call rejected', 'info');
            } catch (error) {
                console.error('Error rejecting call:', error);
                addToCallLog('Failed to reject call: ' + error.message, 'error');
            }
        }

        // End call
        async function endCall() {
            if (!currentCall) return;
            
            try {
                await currentCall.hangup();
                hideAllCallInterfaces();
                stopCallTimer();
                addToCallLog('Call ended', 'info');
            } catch (error) {
                console.error('Error ending call:', error);
                addToCallLog('Failed to end call: ' + error.message, 'error');
            }
        }

        // Toggle mute
        function toggleMute() {
            if (!currentCall) return;
            
            try {
                if (isMuted) {
                    currentCall.unmute();
                    document.getElementById('muteBtn').innerHTML = '<i class="fas fa-microphone"></i> Mute';
                    isMuted = false;
                    addToCallLog('Microphone unmuted', 'info');
                } else {
                    currentCall.mute();
                    document.getElementById('muteBtn').innerHTML = '<i class="fas fa-microphone-slash"></i> Unmute';
                    isMuted = true;
                    addToCallLog('Microphone muted', 'info');
                }
            } catch (error) {
                console.error('Error toggling mute:', error);
                addToCallLog('Failed to toggle mute: ' + error.message, 'error');
            }
        }

        // Play ringing sound
        function playRingingSound() {
            if (ringingAudio) {
                ringingAudio.loop = true;
                ringingAudio.play().catch(error => {
                    console.log('Could not play ringing sound:', error);
                });
            }
        }

        // Stop ringing sound
        function stopRingingSound() {
            if (ringingAudio) {
                ringingAudio.pause();
                ringingAudio.currentTime = 0;
            }
        }

        // Start call timer
        function startCallTimer() {
            callStartTime = Date.now();
            callDurationInterval = setInterval(updateCallDuration, 1000);
        }

        // Stop call timer
        function stopCallTimer() {
            if (callDurationInterval) {
                clearInterval(callDurationInterval);
                callDurationInterval = null;
            }
            callStartTime = null;
        }

        // Update call duration
        function updateCallDuration() {
            if (callStartTime) {
                const duration = Math.floor((Date.now() - callStartTime) / 1000);
                const minutes = Math.floor(duration / 60);
                const seconds = duration % 60;
                document.getElementById('callDuration').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        }

        // Hide all call interfaces
        function hideAllCallInterfaces() {
            document.getElementById('incomingCallInterface').style.display = 'none';
            document.getElementById('activeCallInterface').style.display = 'none';
            currentCall = null;
        }

        // Show browser notification
        function showCallNotification(callerNumber) {
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('Incoming Call', {
                    body: `Call from ${callerNumber}`,
                    icon: '/icon-192x192.png'
                });
            }
        }

        // Add to call log
        function addToCallLog(message, type = 'info') {
            const timestamp = new Date().toLocaleString();
            webrtcCallLog.unshift({
                message: message,
                type: type,
                timestamp: timestamp
            });
            
            // Keep only last 50 entries
            if (webrtcCallLog.length > 50) {
                webrtcCallLog = webrtcCallLog.slice(0, 50);
            }
            
            saveWebRTCCallLog();
            displayWebRTCCallLog();
        }

        // Display call log
        function displayWebRTCCallLog() {
            const container = document.getElementById('webrtcCallLog');
            if (!container) return;

            if (webrtcCallLog.length === 0) {
                container.innerHTML = '<div class="status info">No calls yet</div>';
                return;
            }

            let html = '<div style="max-height: 300px; overflow-y: auto;">';
            webrtcCallLog.forEach((entry) => {
                const color = entry.type === 'success' ? '#059669' : 
                            entry.type === 'error' ? '#dc2626' : '#6b7280';
                
                html += `
                    <div style="padding: 8px; border: 1px solid #e5e7eb; border-radius: 4px; margin-bottom: 4px; background: #f9fafb;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: ${color}; font-size: 12px;">${entry.message}</span>
                            <span style="color: #6b7280; font-size: 10px;">${entry.timestamp}</span>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }

        // Save call log to localStorage
        function saveWebRTCCallLog() {
            localStorage.setItem('webrtcCallLog', JSON.stringify(webrtcCallLog));
        }

        // Load call log from localStorage
        function loadWebRTCCallLog() {
            const saved = localStorage.getItem('webrtcCallLog');
            if (saved) {
                try {
                    webrtcCallLog = JSON.parse(saved);
                    displayWebRTCCallLog();
                } catch (e) {
                    console.error('Error loading WebRTC call log:', e);
                    webrtcCallLog = [];
                }
            }
        }

        // Clear call log
        function clearWebRTCCallLog() {
            if (confirm('Are you sure you want to clear the call log?')) {
                webrtcCallLog = [];
                saveWebRTCCallLog();
                displayWebRTCCallLog();
            }
        }

        // Bubble Settings Functions
        function updateBubbleSettings() {
            const maxWidth = document.getElementById('maxWidthSlider').value;
            const fontSize = document.getElementById('fontSizeSlider').value;
            const padding = document.getElementById('paddingSlider').value;
            const borderRadius = document.getElementById('borderRadiusSlider').value;
            const lineHeight = document.getElementById('lineHeightSlider').value;
            const spacing = document.getElementById('spacingSlider').value;
            
            // Update display values
            document.getElementById('maxWidthValue').textContent = maxWidth + '%';
            document.getElementById('fontSizeValue').textContent = fontSize + 'px';
            document.getElementById('paddingValue').textContent = padding + 'px';
            document.getElementById('borderRadiusValue').textContent = borderRadius + 'px';
            document.getElementById('lineHeightValue').textContent = lineHeight;
            document.getElementById('spacingValue').textContent = spacing + 'px';
            
            // Update CSS custom properties
            document.documentElement.style.setProperty('--message-max-width', maxWidth + '%');
            document.documentElement.style.setProperty('--message-font-size', fontSize + 'px');
            document.documentElement.style.setProperty('--message-padding', padding + 'px ' + (padding + 2) + 'px');
            document.documentElement.style.setProperty('--message-border-radius', borderRadius + 'px');
            document.documentElement.style.setProperty('--message-line-height', lineHeight);
            
            // Update preview
            updateBubblePreview();
            
            // Apply to existing messages
            forceIMessageStyles();
        }
        
        function updateBubblePreview() {
            const maxWidth = document.getElementById('maxWidthSlider').value;
            const fontSize = document.getElementById('fontSizeSlider').value;
            const padding = document.getElementById('paddingSlider').value;
            const borderRadius = document.getElementById('borderRadiusSlider').value;
            const lineHeight = document.getElementById('lineHeightSlider').value;
            const spacing = document.getElementById('spacingSlider').value;
            
            const preview = document.getElementById('bubblePreview');
            preview.innerHTML = `
                <div class="conversation-message incoming" style="margin-bottom: ${spacing}px;">
                    <div class="message-content" style="max-width: ${maxWidth}%; min-width: fit-content; width: fit-content; padding: ${padding}px ${parseInt(padding) + 2}px; border-radius: ${borderRadius}px; font-size: ${fontSize}px; line-height: ${lineHeight}; color: #ffffff; background: #3a3a3c;">
                        <div class="message-text">Hello! This is a preview message.</div>
                        <div class="message-time">Dec 15 2:30 PM</div>
                    </div>
                </div>
                <div class="conversation-message outgoing" style="margin-bottom: ${spacing}px; justify-content: flex-end;">
                    <div class="message-content" style="max-width: ${maxWidth}%; min-width: fit-content; width: fit-content; padding: ${padding}px ${parseInt(padding) + 2}px; border-radius: ${borderRadius}px; font-size: ${fontSize}px; line-height: ${lineHeight}; color: #ffffff; background: #007aff;">
                        <div class="message-text">Hi there! How are you?</div>
                        <div class="message-time">Dec 15 2:31 PM</div>
                    </div>
                </div>
            `;
        }
        
        function resetBubbleSettings() {
            // Reset sliders to default values
            document.getElementById('maxWidthSlider').value = 70;
            document.getElementById('fontSizeSlider').value = 12;
            document.getElementById('paddingSlider').value = 5;
            document.getElementById('borderRadiusSlider').value = 15;
            document.getElementById('lineHeightSlider').value = 1.3;
            document.getElementById('spacingSlider').value = 6;
            
            // Update the settings
            updateBubbleSettings();
            
            // Clear saved settings
            localStorage.removeItem('bubbleSettings');
            showAlert('Bubble settings reset to default', 'success');
        }
        
        function saveBubbleSettings() {
            const settings = {
                maxWidth: document.getElementById('maxWidthSlider').value,
                fontSize: document.getElementById('fontSizeSlider').value,
                padding: document.getElementById('paddingSlider').value,
                borderRadius: document.getElementById('borderRadiusSlider').value,
                lineHeight: document.getElementById('lineHeightSlider').value,
                spacing: document.getElementById('spacingSlider').value
            };
            
            localStorage.setItem('bubbleSettings', JSON.stringify(settings));
            showAlert('Bubble settings saved!', 'success');
        }
        
        function loadBubbleSettings() {
            const saved = localStorage.getItem('bubbleSettings');
            if (saved) {
                const settings = JSON.parse(saved);
                
document.getElementById('maxWidthSlider').value = settings.maxWidth || 70;
                document.getElementById('fontSizeSlider').value = settings.fontSize || 12;
                document.getElementById('paddingSlider').value = settings.padding || 5;
                document.getElementById('borderRadiusSlider').value = settings.borderRadius || 15;
                document.getElementById('lineHeightSlider').value = settings.lineHeight || 1.3;
                document.getElementById('spacingSlider').value = settings.spacing || 6;
                
                updateBubbleSettings();
            }
        }
        
        // Load bubble settings when bubble settings section is shown
        function showSection(sectionId, evt) {
            // Hide all sections and clear any inline display overrides
            document.querySelectorAll('.content-section').forEach(function(section) {
                section.classList.remove('active');
                section.style.display = '';
            });

            // Show selected section
            var sectionEl = document.getElementById(sectionId);
            if (sectionEl) sectionEl.classList.add('active');

            // Remove active class from all nav items
            document.querySelectorAll('.nav-item').forEach(function(item) {
                item.classList.remove('active');
            });

            // Add active class to clicked nav item
            var srcEl = (evt && evt.target) ? evt.target : null;
            if (srcEl && typeof srcEl.closest === 'function') {
                var clicked = srcEl.closest('.nav-item');
                if (clicked) clicked.classList.add('active');
            } else {
                var candidate = document.querySelector('.nav-item[data-section="' + sectionId + '"]');
                if (candidate) candidate.classList.add('active');
            }

            // Load settings for specific sections
            if (sectionId === 'bubble-settings') {
                loadBubbleSettings();
            } else if (sectionId === 'settings') {
                loadSettings();
            } else if (sectionId === 'incoming' || sectionId === 'messages') {
                // Ensure conversations list is loaded when Messages section is shown
                setTimeout(() => {
                    ensureConversationsLoaded();
                }, 100);
            }

            // Scroll the selected section into view on small screens
            if (sectionEl && window.innerWidth <= 768) {
                sectionEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        // Force show section with inline styles (mobile safety net)
        function forceShowSection(sectionId) {
            document.querySelectorAll('.content-section').forEach(function(section) {
                section.classList.remove('active');
                section.style.display = 'none';
            });
            var sectionEl = document.getElementById(sectionId);
            if (sectionEl) {
                sectionEl.classList.add('active');
                sectionEl.style.display = 'block';
                if (window.innerWidth <= 768) {
                    sectionEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }
            document.querySelectorAll('.nav-item').forEach(function(item) { item.classList.remove('active'); });
            var overlayItem = document.querySelector('#mobileMenu a.nav-item[data-section="' + sectionId + '"]');
            if (overlayItem) overlayItem.classList.add('active');
            var sidebarItem = Array.from(document.querySelectorAll('.sidebar .nav-item')).find(function(item){
                var h = item.getAttribute('onclick') || '';
                return h.indexOf("showSection('" + sectionId + "'") !== -1 || h.indexOf('showSection("' + sectionId + '")') !== -1;
            });
            if (sidebarItem) sidebarItem.classList.add('active');
            if (sectionId === 'settings' && typeof loadSettings === 'function') {
                setTimeout(function(){ try { loadSettings(); } catch(_) {} }, 50);
            }
        }

        // Hash-based navigation: scope to small screens only to avoid changing desktop behavior
        function navigateFromHash() {
            if (window.innerWidth > 768) return; // desktop: ignore hash routing
            var hash = location.hash ? location.hash.replace('#','') : 'dashboard';
            if (document.getElementById(hash)) {
                showSection(hash);
            } else {
                showSection('dashboard');
            }
        }
        window.addEventListener('hashchange', navigateFromHash);
        document.addEventListener('DOMContentLoaded', function(){
            // Default to messages on mobile portrait and auto-open latest chat
            if (window.innerWidth <= 768 && (!location.hash || location.hash === '#')) {
                try { 
                    showSection('incoming'); 
                    // Always start on chat list; do not auto-open any conversation
                    const iface = document.getElementById('messagesInterface');
                    if (iface) iface.classList.remove('show-chat');
                } catch(_) {}
            } else {
                navigateFromHash();
            }
        });

        // Ensure a chat is ready to go in mobile portrait
        function ensureMobileMessagingOnLoad() {
            try {
                const incoming = (typeof loadIncomingMessagesFromStorage === 'function') ? loadIncomingMessagesFromStorage() : [];
                const sent = (typeof loadSentMessagesFromStorage === 'function') ? loadSentMessagesFromStorage() : [];

                // Build a combined list with timestamps
                const combined = [];
                incoming.forEach(m => combined.push({ phone: m.from, name: m.name || m.from, timestamp: new Date(m.timestamp || Date.now()).getTime() }));
                sent.forEach(m => combined.push({ phone: m.to, name: m.name || m.to, timestamp: new Date(m.timestamp || Date.now()).getTime() }));

                combined.sort((a,b) => b.timestamp - a.timestamp);

                if (combined.length === 0) {
                    // No messages yet: show input and a friendly prompt
                    const chatHeader = document.getElementById('chatHeaderContent');
                    if (chatHeader) {
                        chatHeader.innerHTML = '<strong style="color:#fff">Start a new chat</strong><div style="font-size:12px;color:#8e8e93">Enter a number and send your first message</div>';
                    }
                    const inputArea = document.getElementById('messageInputArea');
                    if (inputArea) inputArea.style.display = 'block';
                    // Stay on list view
                    const iface = document.getElementById('messagesInterface');
                    if (iface) iface.classList.remove('show-chat');
                }
            } catch (e) {
                // Safe ignore
            }
        }

        // Back to chat list (mobile)
        function showChatListMobile() {
            const iface = document.getElementById('messagesInterface');
            if (iface) iface.classList.remove('show-chat');
        }

        // Initialize resize functionality when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            loadResizePreferences();
        });

        // Also initialize on window load as fallback
        window.addEventListener('load', function() {
            loadResizePreferences();
        });
    </script>
</body>

</html>