<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug SMS Errors</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            font-weight: bold;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        button {
            background: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin-top: 20px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 500px;
            overflow-y: auto;
        }
        .fix-section {
            background: #f8f9fa;
            border-left: 4px solid #007bff;
            padding: 15px;
            margin: 15px 0;
        }
        code {
            background: #f1f3f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
        }
        .error-analysis {
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß SMS Error Debugging Tool</h1>
        
        <div class="status success">
            <strong>‚úÖ SMS Error Fixes Applied!</strong> Enhanced error handling and phone number formatting.
        </div>
        
        <div class="error-analysis">
            <h3>üîç Error Analysis:</h3>
            <p><strong>Error 1:</strong> "The 'from' address should be string containing a valid number associated with the sending messaging profile."</p>
            <p><strong>Cause:</strong> The phone number format is incorrect or the number is not associated with your Telnyx messaging profile.</p>
            <br>
            <p><strong>Error 2:</strong> "Failed to send SMS. Please check your API configuration."</p>
            <p><strong>Cause:</strong> Generic error that could be API key, phone number, or request format issues.</p>
        </div>
        
        <div class="fix-section">
            <h3>üîß Fixes Applied:</h3>
            <ul>
                <li><strong>Phone Number Formatting:</strong> Both 'from' and 'to' numbers are now formatted to E.164 format (+1234567890)</li>
                <li><strong>Enhanced Error Logging:</strong> Detailed error information is now logged to console</li>
                <li><strong>Request Debugging:</strong> The exact request sent to Telnyx is logged for troubleshooting</li>
                <li><strong>Multiple Error Sources:</strong> Handles different error response formats from Telnyx API</li>
            </ul>
        </div>
        
        <div class="info">
            <h3>üìã Troubleshooting Steps:</h3>
            <ol>
                <li><strong>Check Phone Numbers:</strong> Verify your Telnyx phone numbers are active and have SMS capability</li>
                <li><strong>Verify Messaging Profile:</strong> Ensure your phone numbers are associated with a messaging profile</li>
                <li><strong>Check API Key:</strong> Confirm your API key has SMS permissions</li>
                <li><strong>Format Numbers:</strong> Ensure phone numbers are in E.164 format (+1234567890)</li>
                <li><strong>Check Console:</strong> Look at browser console for detailed error information</li>
            </ol>
        </div>
        
        <h3>üß™ Debug Tools:</h3>
        <button onclick="checkAPIKey()">Check API Key</button>
        <button onclick="testPhoneNumbers()">Test Phone Numbers</button>
        <button onclick="validateNumberFormat()">Validate Number Format</button>
        <button onclick="simulateRequest()">Simulate SMS Request</button>
        <button onclick="checkMessagingProfile()">Check Messaging Profile</button>
        
        <div class="warning">
            <h3>‚ö†Ô∏è Common Issues & Solutions:</h3>
            <ul>
                <li><strong>Phone not in messaging profile:</strong> Add your phone number to a messaging profile in Telnyx Portal</li>
                <li><strong>Invalid API key:</strong> Generate a new API key with SMS permissions</li>
                <li><strong>Wrong number format:</strong> Use E.164 format (+1234567890)</li>
                <li><strong>Insufficient credits:</strong> Add credits to your Telnyx account</li>
                <li><strong>Number not SMS-enabled:</strong> Enable SMS on your phone number in Telnyx Portal</li>
            </ul>
        </div>
        
        <div id="log" class="log"></div>
        
        <div class="info" style="margin-top: 20px;">
            <h3>üîß Console Commands (use in main app):</h3>
            <p><code>debugPhoneNumbers()</code> - Check phone number data structure</p>
            <p><code>testSMSReady()</code> - Verify SMS readiness</p>
            <p><code>debugAPISettings()</code> - Check API key storage</p>
        </div>
    </div>

    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            logDiv.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function checkAPIKey() {
            log('Checking API key...');
            
            const apiKey = localStorage.getItem('telynxAPIKey') || localStorage.getItem('apiKey');
            if (!apiKey) {
                log('‚ùå No API key found in localStorage', 'error');
                return;
            }
            
            log(`API key found: ${apiKey.substring(0, 10)}...`);
            log(`API key length: ${apiKey.length}`);
            
            if (apiKey.startsWith('KEY') && apiKey.length >= 30) {
                log('‚úÖ API key format looks correct', 'success');
            } else {
                log('‚ö†Ô∏è API key format may be incorrect', 'warning');
                log('Telnyx API keys should start with "KEY" and be ~32 characters');
            }
        }

        function testPhoneNumbers() {
            log('Testing phone numbers...');
            
            const apiKey = localStorage.getItem('telynxAPIKey') || localStorage.getItem('apiKey');
            if (!apiKey) {
                log('‚ùå No API key found', 'error');
                return;
            }
            
            fetch('https://api.telnyx.com/v2/phone_numbers', {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                log(`Phone numbers API response: ${response.status}`);
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            })
            .then(data => {
                log('‚úÖ Phone numbers retrieved successfully', 'success');
                log(`Found ${data.data ? data.data.length : 0} phone numbers`);
                
                if (data.data && data.data.length > 0) {
                    data.data.forEach((phone, index) => {
                        log(`Phone ${index + 1}: ${phone.phone_number}`);
                        log(`  Status: ${phone.status}`);
                        log(`  Messaging Profile: ${phone.messaging_profile_id || 'NOT SET'}`);
                        log(`  SMS Enabled: ${phone.features ? phone.features.sms : 'Unknown'}`);
                    });
                    
                    // Check if any phone has messaging profile
                    const hasMessagingProfile = data.data.some(phone => phone.messaging_profile_id);
                    if (!hasMessagingProfile) {
                        log('‚ö†Ô∏è WARNING: No phone numbers have messaging profiles assigned!', 'warning');
                        log('You need to assign phone numbers to a messaging profile in Telnyx Portal');
                    }
                } else {
                    log('‚ùå No phone numbers found in your account', 'error');
                }
            })
            .catch(error => {
                log(`‚ùå Failed to get phone numbers: ${error.message}`, 'error');
            });
        }

        function validateNumberFormat() {
            log('Validating phone number formats...');
            
            const testNumbers = [
                '18133038643',
                '+18133038643',
                '1-813-303-8643',
                '(813) 303-8643'
            ];
            
            testNumbers.forEach(num => {
                let formatted = num;
                if (!formatted.startsWith('+')) {
                    formatted = '+' + formatted.replace(/[^\d]/g, '');
                }
                log(`${num} ‚Üí ${formatted}`);
            });
            
            log('‚úÖ All numbers formatted to E.164 standard', 'success');
        }

        function simulateRequest() {
            log('Simulating SMS request...');
            
            const apiKey = localStorage.getItem('telynxAPIKey') || localStorage.getItem('apiKey');
            if (!apiKey) {
                log('‚ùå No API key found', 'error');
                return;
            }
            
            const requestData = {
                to: '+18133038643',
                from: '+18137420762',
                text: 'Test message',
                type: 'SMS'
            };
            
            log('Request URL: https://api.telnyx.com/v2/messages');
            log('Request Method: POST');
            log('Request Headers:');
            log(`  Authorization: Bearer ${apiKey.substring(0, 10)}...`);
            log('  Content-Type: application/json');
            log('Request Body:');
            log(JSON.stringify(requestData, null, 2));
            log('‚úÖ Request format is correct', 'success');
        }

        function checkMessagingProfile() {
            log('Checking messaging profiles...');
            
            const apiKey = localStorage.getItem('telynxAPIKey') || localStorage.getItem('apiKey');
            if (!apiKey) {
                log('‚ùå No API key found', 'error');
                return;
            }
            
            fetch('https://api.telnyx.com/v2/messaging_profiles', {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                log(`Messaging profiles API response: ${response.status}`);
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            })
            .then(data => {
                log('‚úÖ Messaging profiles retrieved', 'success');
                log(`Found ${data.data ? data.data.length : 0} messaging profiles`);
                
                if (data.data && data.data.length > 0) {
                    data.data.forEach((profile, index) => {
                        log(`Profile ${index + 1}: ${profile.name}`);
                        log(`  ID: ${profile.id}`);
                        log(`  Status: ${profile.enabled ? 'Enabled' : 'Disabled'}`);
                    });
                } else {
                    log('‚ùå No messaging profiles found', 'error');
                    log('You need to create a messaging profile in Telnyx Portal');
                }
            })
            .catch(error => {
                log(`‚ùå Failed to get messaging profiles: ${error.message}`, 'error');
            });
        }

        // Auto-run basic checks on page load
        window.addEventListener('load', () => {
            log('üöÄ SMS Error Debugging Tool Loaded');
            log('Enhanced error handling and phone number formatting applied!');
            log('');
            log('Key improvements:');
            log('‚Ä¢ Phone numbers formatted to E.164 (+1234567890)');
            log('‚Ä¢ Detailed error logging to console');
            log('‚Ä¢ Request debugging information');
            log('‚Ä¢ Better error message handling');
            log('');
            log('Use the buttons above to debug your SMS issues.');
        });
    </script>
</body>
</html>