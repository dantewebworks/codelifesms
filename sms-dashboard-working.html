<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CodeLife SMS - Clean Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f8fafc;
            color: #374151;
            line-height: 1.6;
        }

        /* Header */
        .header {
            background: white;
            border-bottom: 1px solid #e5e7eb;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .logo {
            width: 40px;
            height: 40px;
            background: #3b82f6;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
        }

        .nav-tabs {
            display: flex;
            gap: 2rem;
        }

        .nav-tab {
            text-decoration: none;
            color: #6b7280;
            font-weight: 500;
            padding: 0.5rem 0;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }

        .nav-tab.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .settings-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: none;
            border: none;
            color: #6b7280;
            cursor: pointer;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            transition: background-color 0.3s;
        }

        .settings-btn:hover {
            background: #f3f4f6;
        }

        .profile {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 6px;
            transition: background-color 0.3s;
        }

        .profile:hover {
            background: #f3f4f6;
        }

        .profile-pic {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6b7280;
        }

        /* Main Layout */
        .main-container {
            display: flex;
            min-height: calc(100vh - 80px);
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: white;
            border-right: 1px solid #e5e7eb;
            padding: 2rem 0;
        }

        .sidebar-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 2rem;
            cursor: pointer;
            transition: all 0.3s;
            color: #6b7280;
            text-decoration: none;
            margin: 0.25rem 1rem;
            border-radius: 8px;
        }

        .sidebar-item:hover {
            background: #f3f4f6;
            color: #374151;
        }

        .sidebar-item.active {
            background: #eff6ff;
            color: #1d4ed8;
        }

        .sidebar-item i {
            width: 20px;
            text-align: center;
            font-size: 1rem;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 2rem;
            background: #f8fafc;
        }

        .content-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 1.5rem;
            max-width: 1400px;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #111827;
            margin-bottom: 1.5rem;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #374151;
            font-size: 0.9rem;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 0.95rem;
            color: #374151;
            transition: all 0.3s;
            background: white;
        }

        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-input::placeholder {
            color: #9ca3af;
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
            position: relative;
        }

        .char-counter {
            position: absolute;
            bottom: 0.75rem;
            right: 0.75rem;
            font-size: 0.8rem;
            color: #9ca3af;
        }

        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.95rem;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
        }

        .btn-secondary:hover {
            background: #e5e7eb;
        }

        .btn-upload {
            background: #f9fafb;
            border: 2px dashed #d1d5db;
            color: #6b7280;
            width: 100%;
            justify-content: center;
            padding: 2rem 1.5rem;
            font-size: 1rem;
        }

        .btn-upload:hover {
            border-color: #3b82f6;
            color: #3b82f6;
            background: #eff6ff;
        }

        /* Sliders */
        .slider-container {
            margin-bottom: 1.5rem;
        }

        .slider-row {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .slider {
            flex: 1;
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: #3b82f6;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #3b82f6;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .slider-select {
            padding: 0.5rem;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            color: #374151;
            min-width: 100px;
            font-size: 0.9rem;
        }

        /* Messages */
        .message-item {
            padding: 1rem;
            border-bottom: 1px solid #f3f4f6;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .message-item:hover {
            background: #f9fafb;
        }

        .message-item:last-child {
            border-bottom: none;
        }

        .message-phone {
            font-weight: 600;
            color: #111827;
            margin-bottom: 0.25rem;
            font-size: 0.95rem;
        }

        .message-preview {
            color: #6b7280;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .message-time {
            color: #9ca3af;
            font-size: 0.8rem;
            margin-top: 0.25rem;
        }

        /* Analytics */
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .analytics-item {
            text-align: center;
            padding: 1.25rem;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .analytics-item:hover {
            transform: translateY(-2px);
        }

        .analytics-number {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .analytics-label {
            font-size: 0.85rem;
            font-weight: 500;
        }

        .delivered {
            background: #eff6ff;
            color: #1d4ed8;
        }

        .fulfilled {
            background: #f0fdf4;
            color: #16a34a;
        }

        .pending {
            background: #fffbeb;
            color: #d97706;
        }

        .failed {
            background: #fef2f2;
            color: #dc2626;
        }

        /* Chart placeholder */
        .chart-placeholder {
            height: 120px;
            background: linear-gradient(90deg, #3b82f6 0%, #60a5fa 25%, #f59e0b 50%, #1d4ed8 100%);
            border-radius: 8px;
            margin-top: 1rem;
        }

        /* Content sections */
        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        /* Chat Interface */
        .chat-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .chat-overlay.active {
            display: flex;
        }

        .chat-container {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            height: 80%;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }

        .chat-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #f9fafb;
            border-radius: 12px 12px 0 0;
        }

        .chat-contact {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .chat-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #3b82f6;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .chat-contact-info h3 {
            font-size: 1rem;
            font-weight: 600;
            color: #111827;
            margin: 0;
        }

        .chat-contact-info p {
            font-size: 0.85rem;
            color: #6b7280;
            margin: 0;
        }

        .chat-close {
            background: none;
            border: none;
            color: #6b7280;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 6px;
            transition: background-color 0.3s;
        }

        .chat-close:hover {
            background: #f3f4f6;
        }

        .chat-messages {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
            background: white;
        }

        .message {
            margin-bottom: 1rem;
            display: flex;
            align-items: flex-end;
            gap: 0.5rem;
        }

        .message.sent {
            justify-content: flex-end;
        }

        .message.received {
            justify-content: flex-start;
        }

        .message-bubble {
            max-width: 70%;
            padding: 0.75rem 1rem;
            border-radius: 18px;
            font-size: 0.95rem;
            line-height: 1.4;
            position: relative;
        }

        .message.sent .message-bubble {
            background: #3b82f6;
            color: white;
            border-bottom-right-radius: 6px;
        }

        .message.received .message-bubble {
            background: #f3f4f6;
            color: #111827;
            border-bottom-left-radius: 6px;
        }

        .message-time {
            font-size: 0.75rem;
            color: #9ca3af;
            margin-top: 0.25rem;
        }

        .message.sent .message-time {
            text-align: right;
        }

        .message.received .message-time {
            text-align: left;
        }

        .chat-input-area {
            padding: 1rem 1.5rem;
            border-top: 1px solid #e5e7eb;
            background: #f9fafb;
            border-radius: 0 0 12px 12px;
        }

        .chat-input-container {
            display: flex;
            align-items: flex-end;
            gap: 0.75rem;
        }

        .chat-input {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 20px;
            font-size: 0.95rem;
            resize: none;
            min-height: 40px;
            max-height: 120px;
            outline: none;
            transition: border-color 0.3s;
        }

        .chat-input:focus {
            border-color: #3b82f6;
        }

        .chat-actions {
            display: flex;
            gap: 0.5rem;
        }

        .chat-action-btn {
            background: none;
            border: none;
            color: #6b7280;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: all 0.3s;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chat-action-btn:hover {
            background: #f3f4f6;
            color: #3b82f6;
        }

        .chat-send-btn {
            background: #3b82f6;
            color: white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .chat-send-btn:hover {
            background: #2563eb;
        }

        .file-upload {
            display: none;
        }

        .voice-recorder {
            position: relative;
        }

        .voice-indicator {
            position: absolute;
            top: -40px;
            left: 50%;
            transform: translateX(-50%);
            background: #ef4444;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            display: none;
        }

        .voice-indicator.recording {
            display: block;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid #e5e7eb;
            }

            .content-grid {
                grid-template-columns: 1fr;
            }

            .nav-tabs {
                display: none;
            }

            .chat-container {
                width: 95%;
                height: 90%;
            }
        }
    </style>
</head>

<body>
    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <div class="logo">
                <i class="fas fa-comments"></i>
            </div>
            <nav class="nav-tabs">
                <a href="#" class="nav-tab active">Dashboard</a>
                <a href="#" class="nav-tab">Campaigns</a>
                <a href="#" class="nav-tab">Analytics</a>
                <a href="#" class="nav-tab">Settings</a>
            </nav>
        </div>

        <div class="header-right">
            <button class="settings-btn">
                <i class="fas fa-cog"></i>
                <span>Settings</span>
            </button>
            <div class="profile">
                <div class="profile-pic">
                    <i class="fas fa-user"></i>
                </div>
                <i class="fas fa-chevron-down"></i>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <a href="#" class="sidebar-item active" onclick="showSection('dashboard')">
                <i class="fas fa-tachometer-alt"></i>
                <span>Dashboard</span>
            </a>
            <a href="#" class="sidebar-item" onclick="showSection('sms-composer')">
                <i class="fas fa-envelope"></i>
                <span>SMS Composer</span>
            </a>
            <a href="#" class="sidebar-item" onclick="showSection('voicemail')">
                <i class="fas fa-headset"></i>
                <span>Ringless Voicemail</span>
            </a>
            <a href="#" class="sidebar-item" onclick="showSection('bulk-sms')">
                <i class="fas fa-file-alt"></i>
                <span>Bulk SMS via CSV</span>
            </a>
            <a href="#" class="sidebar-item" onclick="showSection('messaging-behavior')">
                <i class="fas fa-star"></i>
                <span>Messaging Behavior</span>
            </a>
            <a href="#" class="sidebar-item" onclick="showSection('api-settings')">
                <i class="fas fa-lock"></i>
                <span>API Settings</span>
            </a>
            <a href="#" class="sidebar-item" onclick="showSection('integrations')">
                <i class="fas fa-link"></i>
                <span>Integrations</span>
            </a>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Dashboard Section -->
            <div id="dashboard" class="content-section active">
                <div class="content-grid">
                    <!-- SMS Composer Card -->
                    <div class="card">
                        <h3 class="card-title">SMS Composer</h3>
                        <div class="form-group">
                            <label class="form-label">Phone number</label>
                            <input type="tel" class="form-input" id="phoneNumber" placeholder="Enter phone number">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Message</label>
                            <div style="position: relative;">
                                <textarea class="form-input form-textarea" id="message"
                                    placeholder="Type your message here..."></textarea>
                                <div class="char-counter" id="dashboardCharCounter">0/160</div>
                            </div>
                            <div style="margin-top: 0.5rem;">
                                <label
                                    style="font-size: 0.9rem; color: #374151; margin-bottom: 0.5rem; display: block;">Personalization
                                    Variables:</label>
                                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                    <button type="button" class="btn btn-sm" onclick="insertDashboardVariable('{name}')"
                                        style="background: #eff6ff; color: #1d4ed8; border: 1px solid #3b82f6; padding: 0.25rem 0.5rem; font-size: 0.8rem;">
                                        {name}
                                    </button>
                                    <button type="button" class="btn btn-sm"
                                        onclick="insertDashboardVariable('{business_name}')"
                                        style="background: #eff6ff; color: #1d4ed8; border: 1px solid #3b82f6; padding: 0.25rem 0.5rem; font-size: 0.8rem;">
                                        {business_name}
                                    </button>
                                    <button type="button" class="btn btn-sm"
                                        onclick="insertDashboardVariable('{company}')"
                                        style="background: #eff6ff; color: #1d4ed8; border: 1px solid #3b82f6; padding: 0.25rem 0.5rem; font-size: 0.8rem;">
                                        {company}
                                    </button>
                                    <button type="button" class="btn btn-sm" onclick="insertDashboardVariable('{date}')"
                                        style="background: #eff6ff; color: #1d4ed8; border: 1px solid #3b82f6; padding: 0.25rem 0.5rem; font-size: 0.8rem;">
                                        {date}
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Schedule</label>
                            <input type="text" class="form-input" placeholder="Send now">
                        </div>
                        <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                            <button class="btn btn-primary" onclick="sendSMS()">
                                <i class="fas fa-paper-plane"></i>
                                Send
                            </button>
                            <button class="btn btn-secondary" onclick="refreshPhoneNumbers()"
                                style="background: #6b7280; color: white;">
                                <i class="fas fa-sync-alt"></i>
                                Refresh Numbers
                            </button>
                        </div>
                    </div>

                    <!-- Ringless Voicemail Card -->
                    <div class="card">
                        <h3 class="card-title">Ringless Voicemail</h3>
                        <div class="form-group">
                            <label class="form-label">Upload Audio</label>
                            <button class="btn btn-upload" onclick="document.getElementById('audioUpload').click()">
                                <i class="fas fa-cloud-upload-alt"></i>
                                Upload Audio
                            </button>
                            <input type="file" id="audioUpload" accept="audio/*" style="display: none;"
                                onchange="handleAudioUpload(this)">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Phone Number</label>
                            <input type="tel" class="form-input" id="voicemailPhone" placeholder="Enter phone number">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Schedule</label>
                            <select class="form-input" id="voicemailSchedule">
                                <option value="now">Send now</option>
                                <option value="later">Schedule for later</option>
                            </select>
                        </div>
                        <div id="audioPreview" style="display: none; margin-bottom: 1rem;">
                            <audio controls style="width: 100%;">
                                <source id="audioSource" src="" type="audio/mpeg">
                                Your browser does not support the audio element.
                            </audio>
                        </div>
                        <button class="btn btn-primary" onclick="sendVoicemail()" id="sendVoicemailBtn" disabled>
                            <i class="fas fa-play"></i>
                            Send Voicemail
                        </button>
                    </div>

                    <!-- Direct Calling Card -->
                    <div class="card">
                        <h3 class="card-title">Direct Calling</h3>
                        <div class="form-group">
                            <label class="form-label">Phone Number</label>
                            <input type="tel" class="form-input" id="callPhone" placeholder="Enter phone number">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Call Type</label>
                            <select class="form-input" id="callType">
                                <option value="voice">Voice Call</option>
                                <option value="video">Video Call</option>
                                <option value="conference">Conference Call</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Call Duration (minutes)</label>
                            <input type="number" class="form-input" id="callDuration" value="5" min="1" max="60">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Schedule</label>
                            <select class="form-input" id="callSchedule">
                                <option value="now">Call now</option>
                                <option value="later">Schedule call</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="initiateCall()">
                            <i class="fas fa-phone"></i>
                            Start Call
                        </button>
                        <button class="btn btn-secondary" onclick="scheduleCall()" style="margin-left: 0.5rem;">
                            <i class="fas fa-calendar"></i>
                            Schedule
                        </button>
                    </div>

                    <!-- Human-like Timing Card -->
                    <div class="card">
                        <h3 class="card-title">Human-like Timing</h3>
                        <div class="slider-container">
                            <div class="slider-row">
                                <span style="color: #374151; font-weight: 500; font-size: 0.9rem;">Delay Min</span>
                                <input type="range" class="slider" id="dashboardMinDelay" min="1" max="60"
                                    oninput="updateMinDelayDisplay(this.value)" onchange="saveMinDelay(this.value)"
                                    data-default="1">
                                <span id="dashboardMinDelayValue" style="font-size: 0.9rem; color: #6b7280;">1
                                    sec</span>
                            </div>
                            <div class="slider-row">
                                <span style="color: #374151; font-weight: 500; font-size: 0.9rem;">Delay Max</span>
                                <input type="range" class="slider" id="dashboardMaxDelay" min="1" max="60"
                                    oninput="updateMaxDelayDisplay(this.value)" onchange="saveMaxDelay(this.value)"
                                    data-default="10">
                                <span id="dashboardMaxDelayValue" style="font-size: 0.9rem; color: #6b7280;">10
                                    sec</span>
                            </div>
                        </div>
                        <div class="form-group" style="margin-top: 1rem;">
                            <label class="form-label">Business Hours</label>
                            <div style="display: flex; gap: 1rem; margin-top: 0.5rem;">
                                <div style="flex: 1;">
                                    <label style="font-size: 0.9rem; color: #374151;">Start Time</label>
                                    <input type="time" class="form-input" id="dashboardStartTime" value="09:00">
                                </div>
                                <div style="flex: 1;">
                                    <label style="font-size: 0.9rem; color: #374151;">End Time</label>
                                    <input type="time" class="form-input" id="dashboardEndTime" value="17:00">
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Time Zone</label>
                            <select class="form-input" id="dashboardTimezone">
                                <option value="EST">Eastern Time (EST)</option>
                                <option value="CST">Central Time (CST)</option>
                                <option value="MST">Mountain Time (MST)</option>
                                <option value="PST">Pacific Time (PST)</option>
                                <option value="UTC">UTC</option>
                            </select>
                        </div>
                        <button class="btn btn-secondary" onclick="saveDashboardTimingSettings()">
                            <i class="fas fa-save"></i>
                            Save Settings
                        </button>
                        <button class="btn btn-primary" onclick="testSettings()" style="margin-left: 0.5rem;">
                            <i class="fas fa-bug"></i>
                            Test Settings
                        </button>
                    </div>



                    <!-- Beeceptor Card -->
                    <div class="card">
                        <h3 class="card-title">Beeceptor</h3>
                        <div class="form-group">
                            <label class="form-label">Beeceptor URL</label>
                            <input type="url" class="form-input" id="beeceptorUrl" placeholder="Enter Beeceptor URL">
                        </div>
                        <p style="font-size: 0.85rem; color: #6b7280; margin-bottom: 1rem;">
                            Enter the URL of your Beeceptor endpoint!
                        </p>
                        <button class="btn btn-secondary">
                            <i class="fas fa-cog"></i>
                            Configure
                        </button>
                    </div>

                    <!-- Analytics Card -->
                    <div class="card">
                        <h3 class="card-title">Analytics</h3>
                        <div class="analytics-grid">
                            <div class="analytics-item delivered">
                                <div class="analytics-number" id="deliveredCount">0</div>
                                <div class="analytics-label">Delivered</div>
                            </div>
                            <div class="analytics-item fulfilled">
                                <div class="analytics-number" id="fulfilledCount">0</div>
                                <div class="analytics-label">Fulfilled</div>
                            </div>
                            <div class="analytics-item pending">
                                <div class="analytics-number" id="pendingCount">0</div>
                                <div class="analytics-label">Pending</div>
                            </div>
                            <div class="analytics-item failed">
                                <div class="analytics-number" id="failedCount">0</div>
                                <div class="analytics-label">Failed</div>
                            </div>
                        </div>
                        <div class="chart-placeholder"></div>
                    </div>

                    <!-- Sent Messages Card -->
                    <div class="card">
                        <h3 class="card-title">Sent Messages</h3>
                        <div id="sentMessagesList" style="max-height: 300px; overflow-y: auto;">
                            <div style="padding: 1rem; text-align: center; color: #6b7280;">
                                No sent messages yet
                            </div>
                        </div>
                        <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                            <button class="btn btn-secondary" onclick="refreshSentMessages()">
                                <i class="fas fa-sync"></i>
                                Refresh
                            </button>
                            <button class="btn btn-secondary" onclick="clearSentMessages()">
                                <i class="fas fa-trash"></i>
                                Clear History
                            </button>
                        </div>
                    </div>

                    <!-- Incoming Messages Card -->
                    <div class="card">
                        <h3 class="card-title">Incoming Messages</h3>
                        <div id="incomingMessagesList">
                            <div style="padding: 1rem; text-align: center; color: #6b7280;">
                                No incoming messages yet
                            </div>
                        </div>
                    </div>


                </div>
            </div>

            <!-- Other sections -->
            <div id="sms-composer" class="content-section">
                <div class="content-grid">
                    <!-- Advanced SMS Composer Card -->
                    <div class="card">
                        <h3 class="card-title">Advanced SMS Composer</h3>
                        <div class="form-group">
                            <label class="form-label">Recipient Phone Number</label>
                            <input type="tel" class="form-input" id="advancedPhoneNumber"
                                placeholder="Enter phone number">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Message Template</label>
                            <select class="form-input" id="messageTemplate" onchange="loadTemplate()">
                                <option value="">Select a template</option>
                                <option value="greeting">Greeting Message</option>
                                <option value="followup">Follow-up Message</option>
                                <option value="reminder">Reminder Message</option>
                                <option value="promotion">Promotion Message</option>
                                <option value="custom">Custom Message</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Message Content</label>
                            <div style="position: relative;">
                                <textarea class="form-input form-textarea" id="advancedMessage"
                                    placeholder="Type your message here..." rows="4"></textarea>
                                <div class="char-counter" id="advancedCharCounter">0/160</div>
                            </div>
                            <div style="margin-top: 0.5rem;">
                                <label
                                    style="font-size: 0.9rem; color: #374151; margin-bottom: 0.5rem; display: block;">Personalization
                                    Variables:</label>
                                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                    <button type="button" class="btn btn-sm" onclick="insertVariable('{name}')"
                                        style="background: #eff6ff; color: #1d4ed8; border: 1px solid #3b82f6; padding: 0.25rem 0.5rem; font-size: 0.8rem;">
                                        {name}
                                    </button>
                                    <button type="button" class="btn btn-sm" onclick="insertVariable('{business_name}')"
                                        style="background: #eff6ff; color: #1d4ed8; border: 1px solid #3b82f6; padding: 0.25rem 0.5rem; font-size: 0.8rem;">
                                        {business_name}
                                    </button>
                                    <button type="button" class="btn btn-sm" onclick="insertVariable('{company}')"
                                        style="background: #eff6ff; color: #1d4ed8; border: 1px solid #3b82f6; padding: 0.25rem 0.5rem; font-size: 0.8rem;">
                                        {company}
                                    </button>
                                    <button type="button" class="btn btn-sm" onclick="insertVariable('{date}')"
                                        style="background: #eff6ff; color: #1d4ed8; border: 1px solid #3b82f6; padding: 0.25rem 0.5rem; font-size: 0.8rem;">
                                        {date}
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Sending Options</label>
                            <div style="display: flex; gap: 1rem; margin-top: 0.5rem;">
                                <label style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" id="urgentFlag">
                                    <span style="font-size: 0.9rem;">Urgent</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" id="deliveryReceipt">
                                    <span style="font-size: 0.9rem;">Delivery Receipt</span>
                                </label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Schedule</label>
                            <select class="form-input" id="advancedSchedule">
                                <option value="now">Send now</option>
                                <option value="later">Schedule for later</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="sendAdvancedSMS()">
                            <i class="fas fa-paper-plane"></i>
                            Send Advanced SMS
                        </button>
                    </div>

                    <!-- Message Templates Card -->
                    <div class="card">
                        <h3 class="card-title">Message Templates</h3>
                        <div class="form-group">
                            <label class="form-label">Template Name</label>
                            <input type="text" class="form-input" id="templateName" placeholder="Enter template name">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Template Content</label>
                            <textarea class="form-input form-textarea" id="templateContent"
                                placeholder="Enter template content..." rows="4"></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Variables</label>
                            <p style="font-size: 0.85rem; color: #6b7280; margin-bottom: 0.5rem;">
                                Use {name}, {company}, {date} in your templates
                            </p>
                        </div>
                        <button class="btn btn-secondary" onclick="saveTemplate()">
                            <i class="fas fa-save"></i>
                            Save Template
                        </button>
                        <button class="btn btn-secondary" onclick="loadTemplates()" style="margin-left: 0.5rem;">
                            <i class="fas fa-folder-open"></i>
                            Load Templates
                        </button>
                    </div>

                    <!-- Business Name Management Card -->
                    <div class="card">
                        <h3 class="card-title">Business Name Management</h3>
                        <div class="form-group">
                            <label class="form-label">Current Business Name</label>
                            <div id="currentBusinessName"
                                style="padding: 0.75rem; background: #f9fafb; border-radius: 8px; margin-bottom: 1rem; font-weight: 600; color: #374151;">
                                No business name set
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Quick Business Names</label>
                            <div
                                style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; margin-bottom: 1rem;">
                                <button type="button" class="btn btn-sm"
                                    onclick="setQuickBusinessName('Acme Corporation')"
                                    style="background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; padding: 0.5rem; font-size: 0.8rem;">
                                    Acme Corporation
                                </button>
                                <button type="button" class="btn btn-sm"
                                    onclick="setQuickBusinessName('Tech Solutions Inc')"
                                    style="background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; padding: 0.5rem; font-size: 0.8rem;">
                                    Tech Solutions Inc
                                </button>
                                <button type="button" class="btn btn-sm"
                                    onclick="setQuickBusinessName('Global Industries')"
                                    style="background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; padding: 0.5rem; font-size: 0.8rem;">
                                    Global Industries
                                </button>
                                <button type="button" class="btn btn-sm"
                                    onclick="setQuickBusinessName('Innovation Labs')"
                                    style="background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; padding: 0.5rem; font-size: 0.8rem;">
                                    Innovation Labs
                                </button>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="selectBusinessName()">
                            <i class="fas fa-edit"></i>
                            Set Custom Business Name
                        </button>
                        <button class="btn btn-secondary" onclick="clearBusinessName()" style="margin-left: 0.5rem;">
                            <i class="fas fa-times"></i>
                            Clear Business Name
                        </button>
                    </div>

                    <!-- SMS History Card -->
                    <div class="card">
                        <h3 class="card-title">SMS History</h3>
                        <div id="smsHistory" style="max-height: 300px; overflow-y: auto;">
                            <div style="padding: 1rem; text-align: center; color: #6b7280;">
                                No SMS history yet
                            </div>
                        </div>
                        <button class="btn btn-secondary" onclick="clearSMSHistory()" style="margin-top: 1rem;">
                            <i class="fas fa-trash"></i>
                            Clear History
                        </button>
                    </div>
                </div>
            </div>

            <div id="voicemail" class="content-section">
                <div class="content-grid">
                    <!-- Voicemail Campaigns Card -->
                    <div class="card">
                        <h3 class="card-title">Voicemail Campaigns</h3>
                        <div class="form-group">
                            <label class="form-label">Campaign Name</label>
                            <input type="text" class="form-input" id="voicemailCampaignName"
                                placeholder="Enter campaign name">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Upload Audio File</label>
                            <button class="btn btn-upload"
                                onclick="document.getElementById('campaignAudioUpload').click()">
                                <i class="fas fa-cloud-upload-alt"></i>
                                Upload Audio File
                            </button>
                            <input type="file" id="campaignAudioUpload" accept="audio/*" style="display: none;"
                                onchange="handleCampaignAudioUpload(this)">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Target Phone Numbers</label>
                            <textarea class="form-input form-textarea" id="voicemailTargets"
                                placeholder="Enter phone numbers (one per line)"></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Schedule</label>
                            <select class="form-input" id="voicemailCampaignSchedule">
                                <option value="now">Send now</option>
                                <option value="scheduled">Schedule for later</option>
                                <option value="recurring">Recurring campaign</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="startVoicemailCampaign()">
                            <i class="fas fa-play"></i>
                            Start Campaign
                        </button>
                    </div>

                    <!-- Voicemail Templates Card -->
                    <div class="card">
                        <h3 class="card-title">Voicemail Templates</h3>
                        <div class="form-group">
                            <label class="form-label">Template Name</label>
                            <input type="text" class="form-input" id="voicemailTemplateName"
                                placeholder="Enter template name">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Audio Description</label>
                            <textarea class="form-input form-textarea" id="voicemailTemplateDesc"
                                placeholder="Describe the voicemail content..." rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Duration (seconds)</label>
                            <input type="number" class="form-input" id="voicemailDuration" min="1" max="300" value="30">
                        </div>
                        <button class="btn btn-secondary" onclick="saveVoicemailTemplate()">
                            <i class="fas fa-save"></i>
                            Save Template
                        </button>
                    </div>

                    <!-- Voicemail Analytics Card -->
                    <div class="card">
                        <h3 class="card-title">Voicemail Analytics</h3>
                        <div
                            style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1rem;">
                            <div style="text-align: center; padding: 1rem; background: #eff6ff; border-radius: 8px;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: #1d4ed8;" id="voicemailSent">0
                                </div>
                                <div style="font-size: 0.9rem; color: #6b7280;">Sent</div>
                            </div>
                            <div style="text-align: center; padding: 1rem; background: #f0fdf4; border-radius: 8px;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: #16a34a;"
                                    id="voicemailDelivered">0</div>
                                <div style="font-size: 0.9rem; color: #6b7280;">Delivered</div>
                            </div>
                        </div>
                        <div style="background: #f9fafb; padding: 1rem; border-radius: 8px;">
                            <h4 style="margin-bottom: 0.5rem; font-size: 1rem;">Recent Activity</h4>
                            <div id="voicemailActivity" style="font-size: 0.9rem; color: #6b7280;">
                                No recent activity
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="bulk-sms" class="content-section active">
                <div class="content-grid">
                    <!-- Bulk SMS Card -->
                    <div class="card">
                        <h3 class="card-title">Bulk SMS via CSV</h3>
                        <div class="form-group">
                            <label class="form-label">Upload CSV File</label>
                            <button class="btn btn-upload" onclick="document.getElementById('csvUpload').click()">
                                <i class="fas fa-cloud-upload-alt"></i>
                                Upload CSV File
                            </button>
                            <input type="file" id="csvUpload" accept=".csv" style="display: none;"
                                onchange="handleCSVUpload(this)">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Message Template</label>
                            <div style="position: relative;">
                                <textarea class="form-input form-textarea" id="bulkMessageTemplate"
                                    placeholder="Hello {business_name}, {message}..." rows="4"></textarea>
                                <div class="char-counter" id="bulkCharCounter">0/160</div>
                            </div>
                            <div style="margin-top: 0.5rem;">
                                <label
                                    style="font-size: 0.9rem; color: #374151; margin-bottom: 0.5rem; display: block;">Personalization
                                    Variables:</label>
                                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                    <button type="button" class="btn btn-sm" onclick="addToBulkMessage('{name}')"
                                        style="background: #eff6ff; color: #1d4ed8; border: 1px solid #3b82f6; padding: 0.25rem 0.5rem; font-size: 0.8rem; cursor: pointer;">
                                        {name}
                                    </button>
                                    <button type="button" class="btn btn-sm"
                                        onclick="addToBulkMessage('{business_name}')"
                                        style="background: #eff6ff; color: #1d4ed8; border: 1px solid #3b82f6; padding: 0.25rem 0.5rem; font-size: 0.8rem; cursor: pointer;">
                                        {business_name}
                                    </button>
                                    <button type="button" class="btn btn-sm" onclick="addToBulkMessage('{company}')"
                                        style="background: #eff6ff; color: #1d4ed8; border: 1px solid #3b82f6; padding: 0.25rem 0.5rem; font-size: 0.8rem; cursor: pointer;">
                                        {company}
                                    </button>
                                    <button type="button" class="btn btn-sm" onclick="addToBulkMessage('{date}')"
                                        style="background: #eff6ff; color: #1d4ed8; border: 1px solid #3b82f6; padding: 0.25rem 0.5rem; font-size: 0.8rem; cursor: pointer;">
                                        {date}
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Business Name Column</label>
                            <input type="text" class="form-input" id="businessNameColumn" placeholder="business_name"
                                value="business_name">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Phone Column</label>
                            <input type="text" class="form-input" id="phoneColumn" placeholder="phone_number"
                                value="phone_number">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Delay Between Messages (seconds)</label>
                            <input type="number" class="form-input" id="messageDelay" value="5" min="1" max="60">
                        </div>
                        <button class="btn btn-primary" onclick="sendBulkSMS()" id="sendBulkBtn" disabled>
                            <i class="fas fa-paper-plane"></i>
                            Send Bulk SMS
                        </button>
                        <button class="btn btn-secondary" onclick="testBulkButtons()" style="margin-left: 0.5rem;">
                            <i class="fas fa-bug"></i>
                            Test Buttons
                        </button>
                        <button class="btn btn-secondary" onclick="testDirectInsert()" style="margin-left: 0.5rem;">
                            <i class="fas fa-test"></i>
                            Test Insert
                        </button>
                        <div id="bulkProgress" style="display: none; margin-top: 1rem;">
                            <div style="background: #f3f4f6; border-radius: 8px; height: 8px; overflow: hidden;">
                                <div id="progressBar"
                                    style="background: #3b82f6; height: 100%; width: 0%; transition: width 0.3s;"></div>
                            </div>
                            <p id="progressText" style="font-size: 0.9rem; color: #6b7280; margin-top: 0.5rem;">Ready to
                                send...</p>
                        </div>
                    </div>

                    <!-- CSV Preview Card -->
                    <div class="card">
                        <h3 class="card-title">CSV Preview</h3>
                        <div id="csvPreview"
                            style="max-height: 300px; overflow-y: auto; background: #f9fafb; border-radius: 8px; padding: 1rem;">
                            <p style="color: #6b7280; text-align: center; margin: 0;">Upload a CSV file to see preview
                            </p>
                        </div>
                        <div id="csvStats" style="margin-top: 1rem; display: none;">
                            <p style="font-size: 0.9rem; color: #6b7280; margin: 0;">
                                <strong id="totalContacts">0</strong> contacts loaded
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="messaging-behavior" class="content-section">
                <div class="content-grid">
                    <!-- Timing Settings Card -->
                    <div class="card">
                        <h3 class="card-title">Timing Settings</h3>
                        <div class="form-group">
                            <label class="form-label">Business Hours</label>
                            <div style="display: flex; gap: 1rem; margin-top: 0.5rem;">
                                <div style="flex: 1;">
                                    <label style="font-size: 0.9rem; color: #374151;">Start Time</label>
                                    <input type="time" class="form-input" id="businessStartTime" value="09:00">
                                </div>
                                <div style="flex: 1;">
                                    <label style="font-size: 0.9rem; color: #374151;">End Time</label>
                                    <input type="time" class="form-input" id="businessEndTime" value="17:00">
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Time Zone</label>
                            <select class="form-input" id="timezone">
                                <option value="EST">Eastern Time (EST)</option>
                                <option value="CST">Central Time (CST)</option>
                                <option value="MST">Mountain Time (MST)</option>
                                <option value="PST">Pacific Time (PST)</option>
                                <option value="UTC">UTC</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Delay Between Messages</label>
                            <div class="slider-container">
                                <div class="slider-row">
                                    <span style="color: #374151; font-weight: 500; font-size: 0.9rem;">Min Delay</span>
                                    <input type="range" class="slider" id="minDelay" min="1" max="60" value="5">
                                    <span id="minDelayValue" style="font-size: 0.9rem; color: #6b7280;">5 sec</span>
                                </div>
                                <div class="slider-row">
                                    <span style="color: #374151; font-weight: 500; font-size: 0.9rem;">Max Delay</span>
                                    <input type="range" class="slider" id="maxDelay" min="1" max="60" value="15">
                                    <span id="maxDelayValue" style="font-size: 0.9rem; color: #6b7280;">15 sec</span>
                                </div>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="saveTimingSettings()">
                            <i class="fas fa-save"></i>
                            Save Settings
                        </button>
                    </div>

                    <!-- Automation Rules Card -->
                    <div class="card">
                        <h3 class="card-title">Automation Rules</h3>
                        <div class="form-group">
                            <label class="form-label">Auto-Reply Settings</label>
                            <div style="margin-bottom: 1rem;">
                                <label style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" id="autoReplyEnabled">
                                    <span style="font-size: 0.9rem;">Enable auto-replies</span>
                                </label>
                            </div>
                            <textarea class="form-input form-textarea" id="autoReplyMessage"
                                placeholder="Enter auto-reply message..." rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Follow-up Rules</label>
                            <div style="margin-bottom: 0.5rem;">
                                <label style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" id="followUpEnabled">
                                    <span style="font-size: 0.9rem;">Enable follow-up messages</span>
                                </label>
                            </div>
                            <input type="number" class="form-input" id="followUpDelay" placeholder="Delay in hours"
                                min="1" max="168">
                        </div>
                        <button class="btn btn-secondary" onclick="saveAutomationRules()">
                            <i class="fas fa-save"></i>
                            Save Rules
                        </button>
                    </div>

                    <!-- Behavior Analytics Card -->
                    <div class="card">
                        <h3 class="card-title">Behavior Analytics</h3>
                        <div
                            style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1rem;">
                            <div style="text-align: center; padding: 1rem; background: #fffbeb; border-radius: 8px;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: #d97706;" id="avgResponseTime">0
                                </div>
                                <div style="font-size: 0.9rem; color: #6b7280;">Avg Response Time</div>
                            </div>
                            <div style="text-align: center; padding: 1rem; background: #fef2f2; border-radius: 8px;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: #dc2626;" id="failedDeliveries">
                                    0</div>
                                <div style="font-size: 0.9rem; color: #6b7280;">Failed Deliveries</div>
                            </div>
                        </div>
                        <div style="background: #f9fafb; padding: 1rem; border-radius: 8px;">
                            <h4 style="margin-bottom: 0.5rem; font-size: 1rem;">Optimal Sending Times</h4>
                            <div id="optimalTimes" style="font-size: 0.9rem; color: #6b7280;">
                                Analyzing patterns...
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="api-settings" class="content-section">
                <div class="content-grid">
                    <!-- API Configuration Card -->
                    <div class="card">
                        <h3 class="card-title">Telnyx API Configuration</h3>
                        <div class="form-group">
                            <label class="form-label">API Key</label>
                            <input type="password" class="form-input" id="apiSettingsKey"
                                placeholder="Enter your Telnyx API key">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Webhook URL</label>
                            <input type="url" class="form-input" id="apiSettingsWebhook" placeholder="Enter webhook URL"
                                value="">
                            <small style="color: #666; font-size: 12px;">Format:
                                https://your-project.vercel.app/webhook</small>
                        </div>
                        <div style="margin: 15px 0;">
                            <button class="btn btn-primary" onclick="newSaveSettings()">
                                <i class="fas fa-save"></i>
                                Save Settings
                            </button>
                            <button class="btn btn-secondary" onclick="testAPIConnection()" style="margin-left: 10px;">
                                <i class="fas fa-plug"></i>
                                Test Connection
                            </button>
                        </div>
                        <div id="settingsStatus"
                            style="padding: 10px; margin-top: 10px; border-radius: 5px; display: none;"></div>
                    </div>

                    <script>
                        // COMPLETELY NEW WEBHOOK PERSISTENCE SYSTEM

                        // Save settings function
                        function newSaveSettings() {
                            const apiKey = document.getElementById('apiSettingsKey').value.trim();
                            const webhook = document.getElementById('apiSettingsWebhook').value.trim();
                            const status = document.getElementById('settingsStatus');

                            if (!apiKey) {
                                showStatus('Please enter an API key', 'error');
                                return;
                            }

                            // Save to localStorage with multiple keys
                            try {
                                localStorage.setItem('telynxAPIKey', apiKey);
                                localStorage.setItem('apiKey', apiKey);

                                if (webhook) {
                                    localStorage.setItem('telynxWebhookUrl', webhook);
                                    localStorage.setItem('webhookUrl', webhook);
                                    localStorage.setItem('webhook', webhook);
                                }

                                // Save as JSON object too
                                const settings = {
                                    apiKey: apiKey,
                                    webhook: webhook,
                                    savedAt: new Date().toISOString()
                                };
                                localStorage.setItem('apiSettings', JSON.stringify(settings));
                                localStorage.setItem('apiSettingsSaved', 'true');

                                showStatus('Settings saved successfully!', 'success');

                                // Update global variables
                                window.telynxAPIKey = apiKey;

                                console.log('✅ Settings saved:', { apiKey: apiKey.substring(0, 10) + '...', webhook });

                            } catch (error) {
                                showStatus('Failed to save settings: ' + error.message, 'error');
                            }
                        }

                        // Load settings function
                        function newLoadSettings() {
                            try {
                                // Load API key
                                let apiKey = localStorage.getItem('telynxAPIKey') || localStorage.getItem('apiKey');
                                if (!apiKey) {
                                    const settings = localStorage.getItem('apiSettings');
                                    if (settings) {
                                        const parsed = JSON.parse(settings);
                                        apiKey = parsed.apiKey;
                                    }
                                }

                                // Load webhook URL
                                let webhook = localStorage.getItem('telynxWebhookUrl') ||
                                    localStorage.getItem('webhookUrl') ||
                                    localStorage.getItem('webhook');
                                if (!webhook) {
                                    const settings = localStorage.getItem('apiSettings');
                                    if (settings) {
                                        const parsed = JSON.parse(settings);
                                        webhook = parsed.webhook;
                                    }
                                }

                                // Set field values
                                const apiField = document.getElementById('apiSettingsKey');
                                const webhookField = document.getElementById('apiSettingsWebhook');

                                if (apiField && apiKey) {
                                    apiField.value = apiKey;
                                    window.telynxAPIKey = apiKey;
                                }

                                if (webhookField && webhook) {
                                    webhookField.value = webhook;
                                    webhookField.setAttribute('value', webhook);
                                }

                                console.log('✅ Settings loaded:', {
                                    apiKey: apiKey ? apiKey.substring(0, 10) + '...' : 'none',
                                    webhook: webhook || 'none'
                                });

                            } catch (error) {
                                console.error('Failed to load settings:', error);
                            }
                        }

                        // Show status message
                        function showStatus(message, type) {
                            const status = document.getElementById('settingsStatus');
                            if (status) {
                                status.style.display = 'block';
                                status.textContent = message;

                                if (type === 'success') {
                                    status.style.background = '#d4edda';
                                    status.style.color = '#155724';
                                    status.style.border = '1px solid #c3e6cb';
                                } else if (type === 'error') {
                                    status.style.background = '#f8d7da';
                                    status.style.color = '#721c24';
                                    status.style.border = '1px solid #f5c6cb';
                                }

                                setTimeout(() => {
                                    status.style.display = 'none';
                                }, 3000);
                            }
                        }

                        // Auto-save webhook URL as user types
                        document.getElementById('apiSettingsWebhook').addEventListener('input', function () {
                            const webhook = this.value.trim();
                            if (webhook) {
                                localStorage.setItem('telynxWebhookUrl', webhook);
                                localStorage.setItem('webhookUrl', webhook);
                                localStorage.setItem('webhook', webhook);
                            }
                        });

                        // Load settings immediately when this script runs
                        newLoadSettings();

                        // Load settings again after a short delay
                        setTimeout(newLoadSettings, 100);
                        setTimeout(newLoadSettings, 500);
                        setTimeout(newLoadSettings, 1000);

                        // Keep checking and restoring webhook URL
                        setInterval(function () {
                            const webhookField = document.getElementById('apiSettingsWebhook');
                            const saved = localStorage.getItem('telynxWebhookUrl');

                            if (webhookField && saved && !webhookField.value) {
                                webhookField.value = saved;
                                console.log('🔄 Restored webhook URL:', saved);
                            }
                        }, 2000);

                    </script>

                    <!-- Phone Numbers Card -->
                    <div class="card">
                        <h3 class="card-title">Phone Numbers</h3>
                        <div id="apiPhoneNumbersContainer">
                            <div style="padding: 1rem; text-align: center; color: #6b7280;">
                                Configure API key to view phone numbers
                            </div>
                        </div>
                        <button class="btn btn-secondary" onclick="refreshPhoneNumbers()" style="margin-top: 1rem;">
                            <i class="fas fa-sync"></i>
                            Refresh Numbers
                        </button>
                    </div>

                    <!-- API Usage Card -->
                    <div class="card">
                        <h3 class="card-title">API Usage</h3>
                        <div
                            style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1rem;">
                            <div style="text-align: center; padding: 1rem; background: #eff6ff; border-radius: 8px;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: #1d4ed8;" id="apiCallsToday">0
                                </div>
                                <div style="font-size: 0.9rem; color: #6b7280;">Calls Today</div>
                            </div>
                            <div style="text-align: center; padding: 1rem; background: #f0fdf4; border-radius: 8px;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: #16a34a;" id="apiCredits">0
                                </div>
                                <div style="font-size: 0.9rem; color: #6b7280;">Credits Left</div>
                            </div>
                        </div>
                        <div style="background: #f9fafb; padding: 1rem; border-radius: 8px;">
                            <h4 style="margin-bottom: 0.5rem; font-size: 1rem;">API Status</h4>
                            <div id="apiStatus" style="font-size: 0.9rem; color: #6b7280;">
                                <span style="color: #dc2626;">●</span> Not Connected
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="integrations" class="content-section">
                <div class="content-grid">
                    <!-- CRM Integration Card -->
                    <div class="card">
                        <h3 class="card-title">CRM Integration</h3>
                        <div class="form-group">
                            <label class="form-label">CRM Platform</label>
                            <select class="form-input" id="crmPlatform">
                                <option value="">Select CRM</option>
                                <option value="salesforce">Salesforce</option>
                                <option value="hubspot">HubSpot</option>
                                <option value="pipedrive">Pipedrive</option>
                                <option value="zoho">Zoho CRM</option>
                                <option value="custom">Custom API</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">API Key</label>
                            <input type="password" class="form-input" id="crmApiKey" placeholder="Enter CRM API key">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Webhook URL</label>
                            <input type="url" class="form-input" id="crmWebhookUrl" placeholder="Enter CRM webhook URL">
                        </div>
                        <button class="btn btn-primary" onclick="connectCRM()">
                            <i class="fas fa-link"></i>
                            Connect CRM
                        </button>
                        <button class="btn btn-secondary" onclick="testCRMConnection()" style="margin-left: 0.5rem;">
                            <i class="fas fa-plug"></i>
                            Test Connection
                        </button>
                    </div>

                    <!-- Email Integration Card -->
                    <div class="card">
                        <h3 class="card-title">Email Integration</h3>
                        <div class="form-group">
                            <label class="form-label">Email Service</label>
                            <select class="form-input" id="emailService">
                                <option value="">Select Email Service</option>
                                <option value="gmail">Gmail</option>
                                <option value="outlook">Outlook</option>
                                <option value="sendgrid">SendGrid</option>
                                <option value="mailchimp">Mailchimp</option>
                                <option value="custom">Custom SMTP</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email Address</label>
                            <input type="email" class="form-input" id="emailAddress" placeholder="Enter email address">
                        </div>
                        <div class="form-group">
                            <label class="form-label">API Key</label>
                            <input type="password" class="form-input" id="emailApiKey"
                                placeholder="Enter email service API key">
                        </div>
                        <button class="btn btn-primary" onclick="connectEmail()">
                            <i class="fas fa-envelope"></i>
                            Connect Email
                        </button>
                    </div>

                    <!-- Analytics Integration Card -->
                    <div class="card">
                        <h3 class="card-title">Analytics Integration</h3>
                        <div class="form-group">
                            <label class="form-label">Analytics Platform</label>
                            <select class="form-input" id="analyticsPlatform">
                                <option value="">Select Analytics</option>
                                <option value="google">Google Analytics</option>
                                <option value="mixpanel">Mixpanel</option>
                                <option value="amplitude">Amplitude</option>
                                <option value="custom">Custom Analytics</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Tracking ID</label>
                            <input type="text" class="form-input" id="trackingId" placeholder="Enter tracking ID">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Webhook URL</label>
                            <input type="url" class="form-input" id="analyticsWebhook"
                                placeholder="Enter analytics webhook URL">
                        </div>
                        <button class="btn btn-primary" onclick="connectAnalytics()">
                            <i class="fas fa-chart-line"></i>
                            Connect Analytics
                        </button>
                    </div>

                    <!-- Integration Status Card -->
                    <div class="card">
                        <h3 class="card-title">Integration Status</h3>
                        <div id="integrationStatus" style="margin-bottom: 1rem;">
                            <div
                                style="padding: 0.75rem; background: #f3f4f6; border-radius: 8px; margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-size: 0.9rem;">CRM Integration</span>
                                <span style="color: #dc2626; font-size: 0.8rem;">● Disconnected</span>
                            </div>
                            <div
                                style="padding: 0.75rem; background: #f3f4f6; border-radius: 8px; margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-size: 0.9rem;">Email Integration</span>
                                <span style="color: #dc2626; font-size: 0.8rem;">● Disconnected</span>
                            </div>
                            <div
                                style="padding: 0.75rem; background: #f3f4f6; border-radius: 8px; margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-size: 0.9rem;">Analytics Integration</span>
                                <span style="color: #dc2626; font-size: 0.8rem;">● Disconnected</span>
                            </div>
                        </div>
                        <button class="btn btn-secondary" onclick="refreshIntegrations()">
                            <i class="fas fa-sync"></i>
                            Refresh Status
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Chat Interface Overlay -->
    <div class="chat-overlay" id="chatOverlay">
        <div class="chat-container">
            <div class="chat-header">
                <div class="chat-contact">
                    <div class="chat-avatar" id="chatAvatar">JS</div>
                    <div class="chat-contact-info">
                        <h3 id="chatContactName">John Smith</h3>
                        <p id="chatContactPhone">+1 234 567 8900</p>
                    </div>
                </div>
                <button class="chat-close" onclick="closeChat()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="chat-messages" id="chatMessages">
                <!-- Messages will be populated here -->
            </div>

            <div class="chat-input-area">
                <div class="chat-input-container">
                    <textarea class="chat-input" id="chatInput" placeholder="Type a message..." rows="1"></textarea>
                    <div class="chat-actions">
                        <button class="chat-action-btn" onclick="document.getElementById('fileUpload').click()">
                            <i class="fas fa-paperclip"></i>
                        </button>
                        <button class="chat-action-btn" onclick="document.getElementById('imageUpload').click()">
                            <i class="fas fa-image"></i>
                        </button>
                        <button class="chat-action-btn voice-recorder" onclick="toggleVoiceRecording()">
                            <i class="fas fa-microphone" id="micIcon"></i>
                        </button>
                        <button class="chat-send-btn" onclick="sendChatMessage()">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
                <div class="voice-indicator" id="voiceIndicator">
                    Recording... Tap to stop
                </div>
            </div>
        </div>

        <!-- Hidden file inputs -->
        <input type="file" id="fileUpload" class="file-upload" accept=".pdf,.doc,.docx,.txt"
            onchange="handleFileUpload(this)">
        <input type="file" id="imageUpload" class="file-upload" accept="image/*" onchange="handleImageUpload(this)">
    </div>

    <script>
        // Character counter for dashboard message input
        function initCharCounter() {
            const messageInput = document.getElementById('message');
            const charCounter = document.getElementById('dashboardCharCounter');
            if (messageInput && charCounter) {
                messageInput.addEventListener('input', function () {
                    charCounter.textContent = this.value.length + '/160';
                });
                console.log('✅ Dashboard character counter initialized');
            }

            // Advanced message character counter
            const advancedInput = document.getElementById('advancedMessage');
            const advancedCounter = document.getElementById('advancedCharCounter');
            if (advancedInput && advancedCounter) {
                advancedInput.addEventListener('input', function () {
                    advancedCounter.textContent = this.value.length + '/160';
                });
                console.log('✅ Advanced character counter initialized');
            }

            // Bulk message character counter
            const bulkInput = document.getElementById('bulkMessageTemplate');
            const bulkCounter = document.getElementById('bulkCharCounter');
            if (bulkInput && bulkCounter) {
                bulkInput.addEventListener('input', function () {
                    bulkCounter.textContent = this.value.length + '/160';
                });
                console.log('✅ Bulk character counter initialized');
            }
        }

        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initCharCounter);
        } else {
            initCharCounter();
        }

        // Navigation
        function showSection(sectionId) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });

            document.getElementById(sectionId).classList.add('active');

            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active');
            });

            event.target.closest('.sidebar-item').classList.add('active');

            // Load API settings when API settings section is shown
            if (sectionId === 'api-settings') {
                setTimeout(() => {
                    loadAPISettings();
                }, 100);
            }

            // Load sent messages when dashboard is shown
            if (sectionId === 'dashboard') {
                setTimeout(() => {
                    updateSentMessagesUI();
                    updateIncomingMessagesUI();
                }, 100);
            }
        }

        // SMS sending function
        async function sendSMS() {
            let phoneNumber = document.getElementById('phoneNumber').value;
            let message = document.getElementById('message').value;

            if (!phoneNumber || !message) {
                alert('Please fill in both phone number and message');
                return;
            }

            // Format the 'to' phone number to E.164 format
            if (!phoneNumber.startsWith('+')) {
                phoneNumber = '+' + phoneNumber.replace(/[^\d]/g, '');
            }

            // Check for API key - try multiple sources
            if (!telynxAPIKey) {
                telynxAPIKey = localStorage.getItem('telynxAPIKey') || localStorage.getItem('apiKey') || '';
                if (!telynxAPIKey) {
                    const apiSettings = localStorage.getItem('apiSettings');
                    if (apiSettings) {
                        try {
                            const settings = JSON.parse(apiSettings);
                            telynxAPIKey = settings.apiKey || '';
                        } catch (e) { }
                    }
                }
            }

            if (!telynxAPIKey) {
                alert('Please configure your Telnyx API key first');
                return;
            }

            // Personalize message with business name
            if (message.includes('{business_name}')) {
                const businessName = localStorage.getItem('selectedBusinessName');
                if (!businessName) {
                    const newBusinessName = selectBusinessName();
                    if (!newBusinessName) {
                        alert('Please select a business name to continue');
                        return;
                    }
                    message = message.replace(/{business_name}/g, newBusinessName);
                } else {
                    message = message.replace(/{business_name}/g, businessName);
                }
            }

            // Replace other variables
            message = message.replace(/{name}/g, 'there');
            message = message.replace(/{company}/g, 'our company');
            message = message.replace(/{date}/g, new Date().toLocaleDateString());

            const success = await sendTelynxSMS(phoneNumber, message);

            if (success) {
                // Add to sent messages
                addToSentMessages(phoneNumber, message);
                alert('SMS sent successfully!');
                document.getElementById('phoneNumber').value = '';
                document.getElementById('message').value = '';
                updateDashboardCharCounter();
            } else {
                alert('Failed to send SMS. Please check your API configuration.');
            }
        }



        // Chat functionality
        let currentChat = null;
        let isRecording = false;
        let recordingTimer = null;

        function openChat(phone, name) {
            currentChat = { phone, name };

            // Update chat header
            document.getElementById('chatContactName').textContent = name;
            document.getElementById('chatContactPhone').textContent = phone;
            document.getElementById('chatAvatar').textContent = name.split(' ').map(n => n[0]).join('');

            // Load chat messages
            loadChatMessages(phone);

            // Show chat overlay
            document.getElementById('chatOverlay').classList.add('active');

            // Focus on input
            setTimeout(() => {
                document.getElementById('chatInput').focus();
            }, 100);
        }

        function closeChat() {
            document.getElementById('chatOverlay').classList.remove('active');
            currentChat = null;
            stopVoiceRecording();
        }

        function loadChatMessages(phone) {
            const chatMessages = document.getElementById('chatMessages');

            // Get real conversation history
            const conversation = getConversationHistory(phone);

            chatMessages.innerHTML = '';

            if (conversation.length === 0) {
                // Show empty state if no conversation exists
                chatMessages.innerHTML = '<div style="padding: 2rem; text-align: center; color: #6b7280;">No conversation history yet</div>';
            } else {
                // Show real conversation history
                conversation.forEach(msg => {
                    const messageDiv = document.createElement('div');
                    const isSent = msg.phone || msg.from === phone; // Check if it's a sent message
                    messageDiv.className = `message ${isSent ? 'sent' : 'received'}`;

                    const time = new Date(msg.timestamp).toLocaleTimeString([], {
                        hour: '2-digit',
                        minute: '2-digit'
                    });

                    messageDiv.innerHTML = `
                        <div class="message-bubble">${msg.message}</div>
                        <div class="message-time">${time}</div>
                    `;
                    chatMessages.appendChild(messageDiv);
                });
            }

            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();

            if (!text || !currentChat) return;

            const chatMessages = document.getElementById('chatMessages');
            const now = new Date();
            const time = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            const messageDiv = document.createElement('div');
            messageDiv.className = 'message sent';
            messageDiv.innerHTML = `
                <div class="message-bubble">${text}</div>
                <div class="message-time">${time}</div>
            `;

            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            input.value = '';
            input.style.height = 'auto';

            // Simulate reply after 2 seconds
            setTimeout(() => {
                const replies = [
                    'Thanks for the message!',
                    'Got it, thanks!',
                    'I\'ll get back to you soon.',
                    'Perfect!',
                    'Noted!'
                ];
                const randomReply = replies[Math.floor(Math.random() * replies.length)];

                const replyDiv = document.createElement('div');
                replyDiv.className = 'message received';
                replyDiv.innerHTML = `
                    <div class="message-bubble">${randomReply}</div>
                    <div class="message-time">${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>
                `;

                chatMessages.appendChild(replyDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }, 2000);
        }

        function handleFileUpload(input) {
            const file = input.files[0];
            if (!file) return;

            const chatMessages = document.getElementById('chatMessages');
            const now = new Date();
            const time = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            const messageDiv = document.createElement('div');
            messageDiv.className = 'message sent';
            messageDiv.innerHTML = `
                <div class="message-bubble">
                    <i class="fas fa-file"></i> ${file.name}
                </div>
                <div class="message-time">${time}</div>
            `;

            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            input.value = '';
        }

        function handleImageUpload(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                const chatMessages = document.getElementById('chatMessages');
                const now = new Date();
                const time = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                const messageDiv = document.createElement('div');
                messageDiv.className = 'message sent';
                messageDiv.innerHTML = `
                    <div class="message-bubble">
                        <img src="${e.target.result}" style="max-width: 200px; border-radius: 8px;" alt="Uploaded image">
                    </div>
                    <div class="message-time">${time}</div>
                `;

                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            };

            reader.readAsDataURL(file);
            input.value = '';
        }

        function toggleVoiceRecording() {
            if (isRecording) {
                stopVoiceRecording();
            } else {
                startVoiceRecording();
            }
        }

        function startVoiceRecording() {
            isRecording = true;
            document.getElementById('micIcon').className = 'fas fa-stop';
            document.getElementById('voiceIndicator').classList.add('recording');

            // Simulate recording timer
            let seconds = 0;
            recordingTimer = setInterval(() => {
                seconds++;
                document.getElementById('voiceIndicator').textContent = `Recording... ${seconds}s`;
            }, 1000);
        }

        function stopVoiceRecording() {
            if (!isRecording) return;

            isRecording = false;
            document.getElementById('micIcon').className = 'fas fa-microphone';
            document.getElementById('voiceIndicator').classList.remove('recording');

            if (recordingTimer) {
                clearInterval(recordingTimer);
                recordingTimer = null;
            }

            // Add voice message to chat
            const chatMessages = document.getElementById('chatMessages');
            const now = new Date();
            const time = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            const messageDiv = document.createElement('div');
            messageDiv.className = 'message sent';
            messageDiv.innerHTML = `
                <div class="message-bubble">
                    <i class="fas fa-microphone"></i> Voice message
                </div>
                <div class="message-time">${time}</div>
            `;

            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Auto-resize textarea
        document.getElementById('chatInput').addEventListener('input', function () {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });

        // Send message on Enter (but allow Shift+Enter for new line)
        document.getElementById('chatInput').addEventListener('keydown', function (e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendChatMessage();
            }
        });

        // Close chat on overlay click
        document.getElementById('chatOverlay').addEventListener('click', function (e) {
            if (e.target === this) {
                closeChat();
            }
        });

        // Telynx API Integration
        let telynxAPIKey = localStorage.getItem('telynxAPIKey') || localStorage.getItem('apiKey') || '';
        let telynxPhoneNumbers = [];

        // Voice call state
        let callInProgress = false;
        let currentCall = null;
        let analyticsData = {
            delivered: 0,
            fulfilled: 0,
            pending: 0,
            failed: 0
        };

        // Bulk SMS data
        let csvData = [];
        let isSendingBulk = false;

        // Save API configuration
        function saveAPIConfig() {
            const apiKey = document.getElementById('apiKey').value;
            const webhookUrl = document.getElementById('webhookUrl').value;

            if (!apiKey) {
                alert('Please enter your API key');
                return;
            }

            telynxAPIKey = apiKey;
            localStorage.setItem('telynxAPIKey', apiKey);
            localStorage.setItem('telynxWebhookUrl', webhookUrl);

            // Fetch phone numbers from Telynx API
            fetchTelynxPhoneNumbers();

            alert('API configuration saved successfully!');
        }

        // Fetch phone numbers from Telynx API - FIXED VERSION
        async function fetchTelynxPhoneNumbers() {
            console.log('🔍 fetchTelynxPhoneNumbers called');
            console.log('🔍 telynxAPIKey available:', !!telynxAPIKey);
            console.log('🔍 telynxAPIKey length:', telynxAPIKey ? telynxAPIKey.length : 'N/A');
            console.log('🔍 telynxAPIKey preview:', telynxAPIKey ? telynxAPIKey.substring(0, 10) + '...' : 'N/A');

            if (!telynxAPIKey) {
                console.log('❌ No API key available for fetching phone numbers');
                return;
            }

            console.log('🔍 Fetching phone numbers from Telnyx API...');

            try {
                // Try the proxy server first
                const proxyResponse = await fetch('http://localhost:3000/api/phone-numbers', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${telynxAPIKey}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (proxyResponse.ok) {
                    const data = await proxyResponse.json();
                    console.log('✅ Phone numbers fetched via proxy:', data);

                    // Update global array with correct data structure
                    if (data && data.data && Array.isArray(data.data)) {
                        telynxPhoneNumbers = data.data;
                        console.log('✅ Updated telynxPhoneNumbers array:', telynxPhoneNumbers);
                    } else if (data && Array.isArray(data)) {
                        telynxPhoneNumbers = data;
                        console.log('✅ Updated telynxPhoneNumbers array (direct):', telynxPhoneNumbers);
                    } else {
                        telynxPhoneNumbers = [];
                        console.log('❌ No phone numbers found in response');
                    }

                    // Update all UI components
                    updatePhoneNumbersUI();
                    updatePhoneNumbersDisplay(data);
                    updateSMSComposerDropdown();

                } else {
                    console.log('❌ Proxy failed, trying direct API...');
                    console.log('❌ Proxy response status:', proxyResponse.status);

                    // Get error details from proxy
                    try {
                        const errorData = await proxyResponse.json();
                        console.log('❌ Proxy error details:', errorData);
                    } catch (e) {
                        console.log('❌ Could not parse proxy error response');
                    }

                    // Fallback to direct API call with messaging profile info
                    console.log('🔄 Trying direct API call...');
                    const directResponse = await fetch('https://api.telnyx.com/v2/phone_numbers?include_messaging_profile=true', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${telynxAPIKey}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    console.log('🔄 Direct API response status:', directResponse.status);

                    if (directResponse.ok) {
                        const data = await directResponse.json();
                        console.log('✅ Phone numbers fetched directly:', data);

                        if (data && data.data && Array.isArray(data.data)) {
                            telynxPhoneNumbers = data.data;
                        } else {
                            telynxPhoneNumbers = [];
                        }

                        updatePhoneNumbersUI();
                        updatePhoneNumbersDisplay(data);
                        updateSMSComposerDropdown();

                    } else {
                        console.error('❌ Both proxy and direct API failed');
                        console.error('❌ Direct API status:', directResponse.status);

                        // Get error details from direct API
                        try {
                            const errorData = await directResponse.text();
                            console.error('❌ Direct API error details:', errorData);
                        } catch (e) {
                            console.error('❌ Could not parse direct API error response');
                        }

                        telynxPhoneNumbers = [];
                        updatePhoneNumbersUI();
                        updatePhoneNumbersDisplay({});
                    }
                }

            } catch (error) {
                console.error('❌ Error fetching phone numbers:', error);
                telynxPhoneNumbers = [];
                updatePhoneNumbersUI();
                updatePhoneNumbersDisplay({});
            }
        }

        // Update UI to show available phone numbers
        function updatePhoneNumbersUI() {
            const phoneNumbersContainer = document.getElementById('phoneNumbersContainer');
            if (!phoneNumbersContainer) return;

            if (telynxPhoneNumbers.length === 0) {
                phoneNumbersContainer.innerHTML = `
                    <div style="padding: 1rem; background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; color: #dc2626;">
                        <i class="fas fa-exclamation-triangle"></i>
                        No phone numbers available in your Telynx account
                    </div>
                `;
                return;
            }

            let html = '<h4 style="margin-bottom: 1rem; color: #374151;">Available Phone Numbers:</h4>';
            telynxPhoneNumbers.forEach((number, index) => {
                const isDefault = index === 0;
                html += `
                    <div style="padding: 0.75rem; background: ${isDefault ? '#eff6ff' : '#f9fafb'}; border: 1px solid ${isDefault ? '#3b82f6' : '#e5e7eb'}; border-radius: 8px; margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-weight: ${isDefault ? '600' : '400'}; color: ${isDefault ? '#1d4ed8' : '#374151'};">${number.phone_number}</span>
                        ${isDefault ? '<span style="background: #3b82f6; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Default</span>' : ''}
                    </div>
                `;
            });

            phoneNumbersContainer.innerHTML = html;
        }

        // Update SMS Composer dropdown with available phone numbers
        function updateSMSComposerDropdown() {
            console.log('🔍 Updating SMS Composer dropdown...');
            console.log('Available phone numbers:', telynxPhoneNumbers);

            // Find the SMS Composer section
            const smsComposer = document.querySelector('.card:has(#phoneNumber)');
            if (!smsComposer) {
                console.log('❌ SMS Composer not found');
                return;
            }

            // Find the phone number input field
            const phoneInput = document.getElementById('phoneNumber');
            if (!phoneInput) {
                console.log('❌ Phone number input not found');
                return;
            }

            // Create a dropdown container if it doesn't exist
            let dropdownContainer = smsComposer.querySelector('.phone-dropdown-container');
            if (!dropdownContainer) {
                dropdownContainer = document.createElement('div');
                dropdownContainer.className = 'phone-dropdown-container';
                dropdownContainer.style.cssText = 'margin-top: 0.5rem;';
                phoneInput.parentNode.insertBefore(dropdownContainer, phoneInput.nextSibling);
            }

            if (telynxPhoneNumbers.length === 0) {
                dropdownContainer.innerHTML = `
                    <div style="padding: 0.75rem; background: #fef2f2; border: 1px solid #fecaca; border-radius: 6px; color: #dc2626; font-size: 0.875rem;">
                        <i class="fas fa-exclamation-triangle"></i>
                        No phone numbers available. Please check your API configuration.
                    </div>
                `;
                return;
            }

            // Create dropdown with available phone numbers
            let html = `
                <div style="margin-bottom: 0.5rem;">
                    <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.25rem;">
                        📞 Available Phone Numbers:
                    </label>
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
            `;

            telynxPhoneNumbers.forEach((number, index) => {
                const isDefault = index === 0;
                const phoneNumber = number.phone_number || number.number || 'Unknown';
                html += `
                    <button type="button" 
                            onclick="selectPhoneNumber('${phoneNumber}')" 
                            style="
                                padding: 0.5rem 0.75rem; 
                                background: ${isDefault ? '#3b82f6' : '#f3f4f6'}; 
                                color: ${isDefault ? 'white' : '#374151'}; 
                                border: 1px solid ${isDefault ? '#3b82f6' : '#d1d5db'}; 
                                border-radius: 6px; 
                                font-size: 0.875rem; 
                                cursor: pointer; 
                                transition: all 0.2s;
                                ${isDefault ? 'font-weight: 600;' : ''}
                            "
                            onmouseover="this.style.background='${isDefault ? '#2563eb' : '#e5e7eb'}'"
                            onmouseout="this.style.background='${isDefault ? '#3b82f6' : '#f3f4f6'}'"
                    >
                        ${phoneNumber}
                        ${isDefault ? ' (Default)' : ''}
                    </button>
                `;
            });

            html += `
                    </div>
                    <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">
                        Click a number above to use it as the sender
                    </div>
                </div>
            `;

            dropdownContainer.innerHTML = html;
            console.log('✅ SMS Composer dropdown updated with', telynxPhoneNumbers.length, 'phone numbers');
        }

        // Function to refresh phone numbers
        function refreshPhoneNumbers() {
            console.log('🔄 Refreshing phone numbers...');

            if (!telynxAPIKey) {
                alert('❌ Please configure your API key first');
                return;
            }

            // Show loading state
            const refreshButton = document.querySelector('button[onclick="refreshPhoneNumbers()"]');
            if (refreshButton) {
                const originalText = refreshButton.innerHTML;
                refreshButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
                refreshButton.disabled = true;

                setTimeout(() => {
                    refreshButton.innerHTML = originalText;
                    refreshButton.disabled = false;
                }, 3000);
            }

            // Fetch phone numbers
            fetchTelynxPhoneNumbers();
        }

        // Function to select a phone number for SMS sending
        function selectPhoneNumber(phoneNumber) {
            console.log('📞 Selected phone number:', phoneNumber);

            // Update the global variable to track selected number
            window.selectedFromNumber = phoneNumber;

            // Visual feedback - highlight the selected button
            const buttons = document.querySelectorAll('.phone-dropdown-container button');
            buttons.forEach(button => {
                if (button.textContent.includes(phoneNumber)) {
                    button.style.background = '#10b981';
                    button.style.color = 'white';
                    button.style.borderColor = '#10b981';
                    setTimeout(() => {
                        button.style.background = '#3b82f6';
                        button.style.color = 'white';
                        button.style.borderColor = '#3b82f6';
                    }, 1000);
                }
            });

            // Show confirmation
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed; top: 20px; right: 20px; 
                background: #10b981; color: white; padding: 1rem; 
                border-radius: 8px; z-index: 1000; font-weight: 600;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            `;
            notification.textContent = `✅ Using ${phoneNumber} as sender`;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Send SMS via Telnyx API - COMPREHENSIVE FIX
        async function sendTelynxSMS(to, message) {
            console.log('🚀 Starting SMS send process...');

            // Validate API key
            if (!telynxAPIKey) {
                console.error('❌ No API key available');
                alert('Please configure your Telnyx API key first');
                return false;
            }

            // Validate phone numbers
            if (!telynxPhoneNumbers || telynxPhoneNumbers.length === 0) {
                console.error('❌ No phone numbers available');
                alert('No phone numbers available. Please check your Telnyx account.');
                return false;
            }

            // Get the best available phone number
            let fromNumber = null;

            // Try to find a phone number with messaging profile
            const phoneWithProfile = telynxPhoneNumbers.find(phone =>
                phone.messaging_profile_id && phone.status === 'active'
            );

            if (phoneWithProfile) {
                fromNumber = phoneWithProfile.phone_number;
                console.log('✅ Using phone with messaging profile:', fromNumber);
            } else {
                // Fallback to selected or first available number
                fromNumber = window.selectedFromNumber ||
                    (telynxPhoneNumbers[0] ? telynxPhoneNumbers[0].phone_number : null);
                console.log('⚠️ Using fallback phone number:', fromNumber);
            }

            if (!fromNumber) {
                console.error('❌ No valid phone number found');
                alert('No valid phone number available. Please check your Telnyx configuration.');
                return false;
            }

            // Format phone numbers to E.164
            const formatE164 = (phone) => {
                if (!phone) return null;
                let cleaned = phone.replace(/[^\d]/g, '');
                if (cleaned.length === 10) cleaned = '1' + cleaned; // Add US country code
                return '+' + cleaned;
            };

            const formattedFrom = formatE164(fromNumber);
            const formattedTo = formatE164(to);

            console.log('📤 SMS Details:');
            console.log('  From:', formattedFrom);
            console.log('  To:', formattedTo);
            console.log('  Message:', message);
            console.log('  API Key:', telynxAPIKey.substring(0, 10) + '...');

            // Prepare request payload
            const payload = {
                to: formattedTo,
                from: formattedFrom,
                text: message,
                type: 'SMS'
            };

            // Add messaging profile if available
            const phoneData = telynxPhoneNumbers.find(p => p.phone_number === fromNumber);
            if (phoneData && phoneData.messaging_profile_id) {
                payload.messaging_profile_id = phoneData.messaging_profile_id;
                console.log('✅ Added messaging profile:', phoneData.messaging_profile_id);
            }

            console.log('📤 Final payload:', payload);

            try {
                const response = await fetch('http://localhost:3000/api/send-sms', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        apiKey: telynxAPIKey,
                        to: formattedTo,
                        from: formattedFrom,
                        message: message
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        console.log('✅ SMS sent successfully:', data);
                        updateAnalytics('delivered');

                        // Track API call
                        const today = new Date().toDateString();
                        const currentCalls = parseInt(localStorage.getItem(`apiCalls_${today}`) || '0');
                        localStorage.setItem(`apiCalls_${today}`, currentCalls + 1);

                                                // Update API usage display
                        updateAPIUsage();

                        return true;
                    } else {
                        console.error('❌ SMS send failed:', data.error);
                        alert('Failed to send SMS: ' + (data.error || 'Unknown error'));
                        updateAnalytics('failed');
                        return false;
                    }
                } else {
                    const errorText = await response.text();
                    console.error('❌ HTTP error:', response.status, errorText);
                    alert(`Failed to send SMS: HTTP ${response.status}`);
                    updateAnalytics('failed');
                    return false;
                }
                } else {
                    console.error('❌ SMS API Error - Status:', response.status);

                    let errorMessage = 'Unknown error occurred';
                    let troubleshootingTips = [];

                    try {
                        const errorData = await response.json();
                        console.error('❌ Full error response:', errorData);
                        console.error('❌ Request payload was:', payload);

                        // Extract error message
                        if (errorData.errors && errorData.errors.length > 0) {
                            const error = errorData.errors[0];
                            errorMessage = error.detail || error.title || error.message || 'API Error';

                            // Add specific troubleshooting based on error
                            if (errorMessage.includes('messaging profile')) {
                                troubleshootingTips.push('• Add your phone number to a messaging profile in Telnyx Portal');
                                troubleshootingTips.push('• Ensure the messaging profile is enabled');
                            }
                            if (errorMessage.includes('from') && errorMessage.includes('valid number')) {
                                troubleshootingTips.push('• Verify your phone number is active in Telnyx Portal');
                                troubleshootingTips.push('• Check that SMS is enabled for this number');
                            }
                            if (errorMessage.includes('insufficient')) {
                                troubleshootingTips.push('• Add credits to your Telnyx account');
                            }
                        } else if (errorData.message) {
                            errorMessage = errorData.message;
                        }

                        // Status-specific troubleshooting
                        if (response.status === 401) {
                            troubleshootingTips.push('• Check your API key is correct and has SMS permissions');
                        } else if (response.status === 403) {
                            troubleshootingTips.push('• Your API key may not have SMS permissions');
                        } else if (response.status === 422) {
                            troubleshootingTips.push('• Check phone number formats (should be +1234567890)');
                            troubleshootingTips.push('• Verify your phone number is SMS-enabled');
                        }

                    } catch (parseError) {
                        console.error('❌ Could not parse error response:', parseError);
                        try {
                            const errorText = await response.text();
                            console.error('❌ Raw error text:', errorText);
                            errorMessage = `HTTP ${response.status} - Check console for details`;
                        } catch (textError) {
                            errorMessage = `HTTP ${response.status} - Unable to get error details`;
                        }
                    }

                    // Show comprehensive error message
                    let alertMessage = `SMS Failed: ${errorMessage}`;
                    if (troubleshootingTips.length > 0) {
                        alertMessage += '\n\nTroubleshooting:\n' + troubleshootingTips.join('\n');
                    }
                    alertMessage += '\n\nCheck browser console for detailed logs.';

                    alert(alertMessage);
                    updateAnalytics('failed');
                    return false;
                }
            } catch (networkError) {
                console.error('❌ Network error sending SMS:', networkError);
                alert('Network error: Unable to connect to Telnyx API. Check your internet connection.');
                updateAnalytics('failed');
                return false;
            }
        }

        // Comprehensive Telnyx account setup
        async function setupTelynxAccount() {
            console.log('🔧 Setting up Telnyx account...');

            const apiKey = document.getElementById('apiSettingsKey').value.trim();
            if (!apiKey) {
                alert('Please enter your API key first');
                return false;
            }

            try {
                // Step 1: Test API connection
                console.log('📡 Testing API connection...');
                const testResponse = await fetch('https://api.telnyx.com/v2/phone_numbers', {
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!testResponse.ok) {
                    throw new Error(`API test failed: ${testResponse.status}`);
                }

                const phoneData = await testResponse.json();
                console.log('✅ API connection successful');

                // Step 2: Ensure messaging profile exists
                console.log('📋 Checking messaging profiles...');
                const profileId = await ensureMessagingProfile();

                // Step 3: Associate phone numbers with messaging profile if needed
                if (profileId && phoneData.data && phoneData.data.length > 0) {
                    console.log('🔗 Associating phone numbers with messaging profile...');

                    for (const phone of phoneData.data) {
                        if (!phone.messaging_profile_id) {
                            try {
                                const updateResponse = await fetch(`https://api.telnyx.com/v2/phone_numbers/${phone.id}`, {
                                    method: 'PATCH',
                                    headers: {
                                        'Authorization': `Bearer ${apiKey}`,
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({
                                        messaging_profile_id: profileId
                                    })
                                });

                                if (updateResponse.ok) {
                                    console.log(`✅ Associated ${phone.phone_number} with messaging profile`);
                                } else {
                                    console.log(`⚠️ Could not associate ${phone.phone_number} with messaging profile`);
                                }
                            } catch (error) {
                                console.log(`⚠️ Error associating ${phone.phone_number}:`, error);
                            }
                        }
                    }
                }

                // Step 4: Refresh phone numbers with updated data
                await fetchTelynxPhoneNumbers();

                // Step 5: Update UI
                const statusElement = document.getElementById('apiStatus');
                if (statusElement) {
                    statusElement.innerHTML = '<span style="color: #16a34a;">●</span> Connected & Configured';
                }

                alert('✅ Telnyx account setup complete! SMS should now work properly.');
                return true;

            } catch (error) {
                console.error('❌ Account setup failed:', error);
                alert(`Account setup failed: ${error.message}\n\nPlease check your API key and try again.`);
                return false;
            }
        }

        // Auto-setup messaging profile if needed
        async function ensureMessagingProfile() {
            if (!telynxAPIKey) return false;

            try {
                // Check if we have any messaging profiles
                const profilesResponse = await fetch('https://api.telnyx.com/v2/messaging_profiles', {
                    headers: {
                        'Authorization': `Bearer ${telynxAPIKey}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (profilesResponse.ok) {
                    const profilesData = await profilesResponse.json();
                    console.log('📋 Messaging profiles:', profilesData);

                    if (!profilesData.data || profilesData.data.length === 0) {
                        console.log('🔧 No messaging profiles found, creating one...');

                        // Create a default messaging profile
                        const createResponse = await fetch('https://api.telnyx.com/v2/messaging_profiles', {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${telynxAPIKey}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                name: 'SMS Dashboard Profile',
                                enabled: true,
                                webhook_url: localStorage.getItem('telynxWebhookUrl') || '',
                                webhook_failover_url: '',
                                webhook_api_version: '2'
                            })
                        });

                        if (createResponse.ok) {
                            const newProfile = await createResponse.json();
                            console.log('✅ Created messaging profile:', newProfile);
                            return newProfile.data.id;
                        } else {
                            console.log('❌ Failed to create messaging profile');
                        }
                    } else {
                        console.log('✅ Messaging profiles exist:', profilesData.data.length);
                        return profilesData.data[0].id;
                    }
                }
            } catch (error) {
                console.error('❌ Error checking messaging profiles:', error);
            }
            return null;
        }

        // Update analytics
        function updateAnalytics(type) {
            analyticsData[type]++;
            document.getElementById(`${type}Count`).textContent = analyticsData[type];
        }

        // Handle CSV upload
        function handleCSVUpload(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                const csv = e.target.result;
                const lines = csv.split('\n');
                const headers = lines[0].split(',').map(h => h.trim());

                csvData = [];
                for (let i = 1; i < lines.length; i++) {
                    if (lines[i].trim()) {
                        const values = lines[i].split(',').map(v => v.trim());
                        const row = {};
                        headers.forEach((header, index) => {
                            row[header] = values[index] || '';
                        });
                        csvData.push(row);
                    }
                }

                // Update preview
                updateCSVPreview();

                // Enable send button
                document.getElementById('sendBulkBtn').disabled = false;

                console.log('CSV data loaded:', csvData);
            };

            reader.readAsText(file);
        }

        // Update CSV preview
        function updateCSVPreview() {
            const preview = document.getElementById('csvPreview');
            const stats = document.getElementById('csvStats');

            if (csvData.length === 0) {
                preview.innerHTML = '<p style="color: #6b7280; text-align: center; margin: 0;">No data to display</p>';
                stats.style.display = 'none';
                return;
            }

            const headers = Object.keys(csvData[0]);
            let html = '<table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">';

            // Headers
            html += '<tr style="background: #f3f4f6;">';
            headers.forEach(header => {
                html += `<th style="padding: 0.5rem; text-align: left; border-bottom: 1px solid #e5e7eb;">${header}</th>`;
            });
            html += '</tr>';

            // First 5 rows
            csvData.slice(0, 5).forEach(row => {
                html += '<tr>';
                headers.forEach(header => {
                    html += `<td style="padding: 0.5rem; border-bottom: 1px solid #f3f4f6;">${row[header] || ''}</td>`;
                });
                html += '</tr>';
            });

            if (csvData.length > 5) {
                html += '<tr><td colspan="' + headers.length + '" style="padding: 0.5rem; text-align: center; color: #6b7280;">... and ' + (csvData.length - 5) + ' more rows</td></tr>';
            }

            html += '</table>';
            preview.innerHTML = html;

            // Update stats
            document.getElementById('totalContacts').textContent = csvData.length;
            stats.style.display = 'block';
        }

        // Send bulk SMS
        async function sendBulkSMS() {
            if (isSendingBulk || csvData.length === 0) return;

            const template = document.getElementById('messageTemplate').value;
            const businessNameCol = document.getElementById('businessNameColumn').value;
            const phoneCol = document.getElementById('phoneColumn').value;
            const delay = parseInt(document.getElementById('messageDelay').value) * 1000;

            if (!template || !businessNameCol || !phoneCol) {
                alert('Please fill in all required fields');
                return;
            }

            isSendingBulk = true;
            document.getElementById('sendBulkBtn').disabled = true;
            document.getElementById('bulkProgress').style.display = 'block';

            let sent = 0;
            let failed = 0;

            for (let i = 0; i < csvData.length; i++) {
                const row = csvData[i];
                const phone = row[phoneCol];
                const businessName = row[businessNameCol];

                if (!phone) {
                    failed++;
                    continue;
                }

                // Personalize message
                let message = template;
                Object.keys(row).forEach(key => {
                    message = message.replace(new RegExp(`{${key}}`, 'g'), row[key]);
                });

                // Update progress
                const progress = ((i + 1) / csvData.length) * 100;
                document.getElementById('progressBar').style.width = progress + '%';
                document.getElementById('progressText').textContent = `Sending ${i + 1} of ${csvData.length}...`;

                // Send SMS via backend
                try {
                    const response = await fetch('http://localhost:3000/api/send-sms', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            apiKey: telynxAPIKey,
                            to: phone,
                            from: window.selectedFromNumber || telynxPhoneNumbers[0]?.phone_number,
                            message: message
                        })
                    });
                    
                    const data = await response.json();
                    const success = data.success;
                } catch (error) {
                    console.error('Bulk SMS error:', error);
                    failed++;
                }
                
                if (success) {
                    sent++;
                } else {
                    failed++;
                }

                // Delay between messages
                if (i < csvData.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }

            // Complete
            document.getElementById('progressText').textContent = `Complete! Sent: ${sent}, Failed: ${failed}`;
            document.getElementById('sendBulkBtn').disabled = false;
            isSendingBulk = false;

            // Reset after 5 seconds
            setTimeout(() => {
                document.getElementById('bulkProgress').style.display = 'none';
                document.getElementById('progressBar').style.width = '0%';
            }, 5000);
        }

        // Voicemail and calling functionality
        let selectedAudioFile = null;
        let callInProgress = false;

        // Handle audio upload for voicemail
        function handleAudioUpload(input) {
            const file = input.files[0];
            if (!file) return;

            if (!file.type.startsWith('audio/')) {
                alert('Please select an audio file');
                return;
            }

            selectedAudioFile = file;

            // Show audio preview
            const audioPreview = document.getElementById('audioPreview');
            const audioSource = document.getElementById('audioSource');
            const sendBtn = document.getElementById('sendVoicemailBtn');

            const reader = new FileReader();
            reader.onload = function (e) {
                audioSource.src = e.target.result;
                audioPreview.style.display = 'block';
                sendBtn.disabled = false;
            };

            reader.readAsDataURL(file);
        }

        // Send voicemail
        async function sendVoicemail() {
            const phone = document.getElementById('voicemailPhone').value;
            const schedule = document.getElementById('voicemailSchedule').value;

            if (!phone) {
                alert('Please enter a phone number');
                return;
            }

            if (!selectedAudioFile) {
                alert('Please upload an audio file');
                return;
            }

            if (!telynxAPIKey) {
                alert('Please configure your Telynx API key first');
                return;
            }

            // Show progress
            const sendBtn = document.getElementById('sendVoicemailBtn');
            const originalText = sendBtn.innerHTML;
            sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
            sendBtn.disabled = true;

            try {
                // Simulate voicemail sending (replace with actual Telynx voicemail API)
                await new Promise(resolve => setTimeout(resolve, 2000));

                alert('Voicemail sent successfully!');
                updateAnalytics('delivered');

                // Reset form
                document.getElementById('voicemailPhone').value = '';
                document.getElementById('audioUpload').value = '';
                document.getElementById('audioPreview').style.display = 'none';
                selectedAudioFile = null;
                sendBtn.disabled = true;

            } catch (error) {
                alert('Failed to send voicemail: ' + error.message);
                updateAnalytics('failed');
            } finally {
                sendBtn.innerHTML = originalText;
                sendBtn.disabled = false;
            }
        }

        // Get Telnyx connection ID for voice calls
        async function getConnectionId() {
            try {
                const response = await fetch('https://api.telnyx.com/v2/connections', {
                    headers: {
                        'Authorization': `Bearer ${telynxAPIKey}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.data && data.data.length > 0) {
                        // Find an active connection, preferably SIP
                        const activeConnection = data.data.find(conn =>
                            conn.active && (conn.connection_name || conn.id)
                        );
                        return activeConnection ? activeConnection.id : data.data[0].id;
                    }
                }
            } catch (error) {
                console.error('❌ Error getting connection ID:', error);
            }

            // Return null if no connection found - the API call will fail with a helpful error
            return null;
        }

        // Initiate call using Telnyx Voice API
        async function initiateCall() {
            const phone = document.getElementById('callPhone').value;
            const callType = document.getElementById('callType').value;
            const duration = document.getElementById('callDuration').value;

            if (!phone) {
                alert('Please enter a phone number');
                return;
            }

            if (!telynxAPIKey) {
                alert('Please configure your Telnyx API key first');
                return;
            }

            if (callInProgress) {
                alert('A call is already in progress');
                return;
            }

            // Format phone numbers to E.164
            const formatE164 = (phoneNum) => {
                if (!phoneNum) return null;
                let cleaned = phoneNum.replace(/[^\d]/g, '');
                if (cleaned.length === 10) cleaned = '1' + cleaned; // Add US country code
                return '+' + cleaned;
            };

            const toNumber = formatE164(phone);

            // Get available phone number for outbound calling
            let fromNumber = null;
            if (telynxPhoneNumbers && telynxPhoneNumbers.length > 0) {
                // Find a phone number that supports voice calls
                const voicePhone = telynxPhoneNumbers.find(p =>
                    p.features && (p.features.voice || p.features.outbound_voice)
                );
                fromNumber = voicePhone ? formatE164(voicePhone.phone_number) : formatE164(telynxPhoneNumbers[0].phone_number);
            }

            if (!fromNumber) {
                alert('No phone number available for outbound calling. Please check your Telnyx configuration.');
                return;
            }

            console.log('🔊 Initiating voice call...');
            console.log('  From:', fromNumber);
            console.log('  To:', toNumber);
            console.log('  Type:', callType);

            callInProgress = true;

            try {
                // Create outbound call using Telnyx Call Control API
                const response = await fetch('https://api.telnyx.com/v2/calls', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${telynxAPIKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        to: toNumber,
                        from: fromNumber,
                        connection_id: await getConnectionId(), // We'll need to get this
                        timeout_secs: 30,
                        time_limit_secs: parseInt(duration) * 60 // Convert minutes to seconds
                    })
                });

                if (response.ok) {
                    const callData = await response.json();
                    console.log('✅ Call initiated successfully:', callData);

                    // Store call information
                    window.currentCall = callData.data;

                    // Show call interface
                    showCallInterface(phone, callType, duration, callData.data);

                    // Update analytics
                    updateAnalytics('pending');

                    alert(`✅ Call initiated to ${toNumber}!\nCall ID: ${callData.data.call_control_id}`);

                } else {
                    const errorData = await response.json();
                    console.error('❌ Call failed:', errorData);

                    let errorMessage = 'Failed to initiate call';
                    if (errorData.errors && errorData.errors.length > 0) {
                        errorMessage = errorData.errors[0].detail || errorData.errors[0].title;
                    }

                    alert(`Call failed: ${errorMessage}`);
                    callInProgress = false;
                }

            } catch (error) {
                console.error('❌ Call error:', error);
                alert(`Call failed: ${error.message}`);
                callInProgress = false;
            }
        }

        // Schedule call
        function scheduleCall() {
            const phone = document.getElementById('callPhone').value;
            const callType = document.getElementById('callType').value;
            const duration = document.getElementById('callDuration').value;
            const schedule = document.getElementById('callSchedule').value;

            if (!phone) {
                alert('Please enter a phone number');
                return;
            }

            if (schedule === 'now') {
                initiateCall();
                return;
            }

            // Show scheduling interface
            const scheduledTime = prompt('Enter call time (e.g., 2:30 PM):');
            if (scheduledTime) {
                alert(`Call scheduled to ${phone} at ${scheduledTime}`);
                updateAnalytics('pending');
            }
        }

        // Show call interface with real call controls
        function showCallInterface(phone, callType, duration, callData = null) {
            const callInterface = document.createElement('div');
            callInterface.id = 'callInterface';
            callInterface.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                padding: 2rem;
                border-radius: 12px;
                box-shadow: 0 20px 40px rgba(0,0,0,0.3);
                z-index: 1001;
                text-align: center;
                min-width: 350px;
                border: 2px solid #3b82f6;
            `;

            const callId = callData ? callData.call_control_id : 'unknown';
            const callStatus = callData ? callData.call_state : 'initiating';

            callInterface.innerHTML = `
                <h3 style="margin-bottom: 1rem; color: #3b82f6;">📞 Voice Call</h3>
                <p style="margin-bottom: 0.5rem; font-size: 1.2rem; font-weight: 600;">${phone}</p>
                <p style="margin-bottom: 0.5rem; color: #6b7280; text-transform: capitalize;">${callType} call</p>
                <p style="margin-bottom: 1rem; color: #6b7280; font-size: 0.9rem;">Status: <span id="callStatus">${callStatus}</span></p>
                <div style="margin-bottom: 1.5rem;">
                    <span id="callTimer" style="font-size: 1.5rem; font-weight: 600; color: #059669;">00:00</span>
                </div>
                <div style="display: flex; gap: 1rem; justify-content: center; margin-bottom: 1rem;">
                    <button onclick="endCall('${callId}')" style="background: #ef4444; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600;">
                        <i class="fas fa-phone-slash"></i> End Call
                    </button>
                    <button onclick="muteCall('${callId}')" id="muteBtn" style="background: #6b7280; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600;">
                        <i class="fas fa-microphone"></i> Mute
                    </button>
                </div>
                <div style="font-size: 0.8rem; color: #9ca3af;">
                    Call ID: ${callId}
                </div>
            `;

            document.body.appendChild(callInterface);

            // Start call timer
            let seconds = 0;
            const timer = setInterval(() => {
                seconds++;
                const minutes = Math.floor(seconds / 60);
                const secs = seconds % 60;
                const timerElement = document.getElementById('callTimer');
                if (timerElement) {
                    timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                }
            }, 1000);

            // Store timer reference and call data
            callInterface.timer = timer;
            callInterface.callData = callData;

            // Store globally for call control
            window.activeCallInterface = callInterface;
        }

        // End call using Telnyx API
        async function endCall(callControlId) {
            console.log('🔊 Ending call:', callControlId);

            if (!callControlId || callControlId === 'unknown') {
                // Fallback for calls without proper ID
                const callInterface = document.getElementById('callInterface');
                if (callInterface) {
                    clearInterval(callInterface.timer);
                    callInterface.remove();
                }
                callInProgress = false;
                alert('Call ended (local)');
                return;
            }

            try {
                const response = await fetch(`https://api.telnyx.com/v2/calls/${callControlId}/actions/hangup`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${telynxAPIKey}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    console.log('✅ Call ended successfully');
                    updateAnalytics('fulfilled');
                } else {
                    console.error('❌ Failed to end call via API');
                    updateAnalytics('failed');
                }

            } catch (error) {
                console.error('❌ Error ending call:', error);
                updateAnalytics('failed');
            }

            // Clean up interface regardless of API result
            const callInterface = document.getElementById('callInterface');
            if (callInterface) {
                clearInterval(callInterface.timer);
                callInterface.remove();
            }
            callInProgress = false;
            window.currentCall = null;
            window.activeCallInterface = null;
        }

        // Mute/unmute call using Telnyx API
        async function muteCall(callControlId) {
            console.log('🔊 Toggling mute for call:', callControlId);

            const muteBtn = document.getElementById('muteBtn');
            const isMuted = muteBtn.innerHTML.includes('Unmute');

            if (!callControlId || callControlId === 'unknown') {
                // Fallback for calls without proper ID
                if (isMuted) {
                    muteBtn.innerHTML = '<i class="fas fa-microphone"></i> Mute';
                    alert('Call unmuted (local)');
                } else {
                    muteBtn.innerHTML = '<i class="fas fa-microphone-slash"></i> Unmute';
                    alert('Call muted (local)');
                }
                return;
            }

            try {
                const action = isMuted ? 'unmute' : 'mute';
                const response = await fetch(`https://api.telnyx.com/v2/calls/${callControlId}/actions/${action}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${telynxAPIKey}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    console.log(`✅ Call ${action}d successfully`);
                    if (isMuted) {
                        muteBtn.innerHTML = '<i class="fas fa-microphone"></i> Mute';
                        muteBtn.style.background = '#6b7280';
                    } else {
                        muteBtn.innerHTML = '<i class="fas fa-microphone-slash"></i> Unmute';
                        muteBtn.style.background = '#ef4444';
                    }
                } else {
                    console.error(`❌ Failed to ${action} call`);
                    alert(`Failed to ${action} call`);
                }

            } catch (error) {
                console.error(`❌ Error ${isMuted ? 'unmuting' : 'muting'} call:`, error);
                alert(`Error ${isMuted ? 'unmuting' : 'muting'} call`);
            }
        }

        // Advanced SMS Composer functions
        function insertVariable(variable) {
            const messageArea = document.getElementById('advancedMessage');
            const cursorPos = messageArea.selectionStart;
            const textBefore = messageArea.value.substring(0, cursorPos);
            const textAfter = messageArea.value.substring(cursorPos);

            messageArea.value = textBefore + variable + textAfter;

            // Set cursor position after the inserted variable
            const newCursorPos = cursorPos + variable.length;
            messageArea.setSelectionRange(newCursorPos, newCursorPos);
            messageArea.focus();

            updateAdvancedCharCounter();
        }

        function addToBulkMessage(variable) {
            const textarea = document.getElementById('bulkMessageTemplate');
            if (!textarea) {
                return;
            }

            // Simply append the variable to the end
            textarea.value += variable;

            // Update character counter
            const counter = document.getElementById('bulkCharCounter');
            if (counter) {
                counter.textContent = textarea.value.length + '/160';
            }
        }

        function insertDashboardVariable(variable) {
            const messageArea = document.getElementById('message');
            if (!messageArea) {
                console.error('Dashboard message textarea not found');
                return;
            }

            const cursorPos = messageArea.selectionStart;
            const textBefore = messageArea.value.substring(0, cursorPos);
            const textAfter = messageArea.value.substring(cursorPos);

            messageArea.value = textBefore + variable + textAfter;

            // Set cursor position after the inserted variable
            const newCursorPos = cursorPos + variable.length;
            messageArea.setSelectionRange(newCursorPos, newCursorPos);
            messageArea.focus();

            updateDashboardCharCounter();
        }

        function selectBusinessName() {
            const businessNames = [
                'Acme Corporation',
                'Tech Solutions Inc',
                'Global Industries',
                'Innovation Labs',
                'Premier Services',
                'Elite Consulting',
                'Strategic Partners',
                'Advanced Systems',
                'Professional Group',
                'Enterprise Solutions'
            ];

            const selectedBusiness = prompt(
                'Select or enter business name:\n\n' +
                businessNames.map((name, index) => `${index + 1}. ${name}`).join('\n') +
                '\n\nOr type a custom business name:'
            );

            if (selectedBusiness) {
                // Store the selected business name for use in personalization
                localStorage.setItem('selectedBusinessName', selectedBusiness);
                updateBusinessNameDisplay(selectedBusiness);
                alert(`Business name set to: ${selectedBusiness}`);
                return selectedBusiness;
            }
            return null;
        }

        function setQuickBusinessName(businessName) {
            localStorage.setItem('selectedBusinessName', businessName);
            updateBusinessNameDisplay(businessName);
            alert(`Business name set to: ${businessName}`);
        }

        function clearBusinessName() {
            localStorage.removeItem('selectedBusinessName');
            updateBusinessNameDisplay(null);
            alert('Business name cleared');
        }

        function updateBusinessNameDisplay(businessName) {
            const displayElement = document.getElementById('currentBusinessName');
            if (displayElement) {
                if (businessName) {
                    displayElement.textContent = businessName;
                    displayElement.style.background = '#eff6ff';
                    displayElement.style.color = '#1d4ed8';
                } else {
                    displayElement.textContent = 'No business name set';
                    displayElement.style.background = '#f9fafb';
                    displayElement.style.color = '#374151';
                }
            }
        }

        function loadTemplate() {
            const templateSelect = document.getElementById('messageTemplate');
            const messageArea = document.getElementById('advancedMessage');
            const templates = {
                greeting: "Hello {name}, thank you for your interest in our services!",
                followup: "Hi {name}, just following up on our previous conversation. How can we help you today?",
                reminder: "Hi {name}, this is a friendly reminder about your upcoming appointment.",
                promotion: "Hello {name}! We have a special offer just for you. Limited time only!",
                custom: ""
            };

            messageArea.value = templates[templateSelect.value] || '';
            updateAdvancedCharCounter();
        }

        function updateAdvancedCharCounter() {
            const message = document.getElementById('advancedMessage').value;
            const counter = document.getElementById('advancedCharCounter');
            counter.textContent = message.length + '/160';
        }

        function updateBulkCharCounter() {
            const message = document.getElementById('bulkMessageTemplate').value;
            const counter = document.getElementById('bulkCharCounter');
            if (counter) {
                counter.textContent = message.length + '/160';
            }
        }

        // Simple test function
        function testBulkButtons() {
            console.log('Bulk buttons are working');
        }

        // Test direct insertion
        function testDirectInsert() {
            const messageArea = document.getElementById('bulkMessageTemplate');
            if (messageArea) {
                messageArea.value += 'TEST INSERTED ';
                const counter = document.getElementById('bulkCharCounter');
                if (counter) {
                    counter.textContent = messageArea.value.length + '/160';
                }
            }
        }

        function updateDashboardCharCounter() {
            const message = document.getElementById('message').value;
            const counter = document.getElementById('dashboardCharCounter');
            if (counter) {
                counter.textContent = message.length + '/160';
            }
        }

        // Dashboard timing settings functions
        function saveDashboardTimingSettings() {
            const minDelay = document.getElementById('dashboardMinDelay').value;
            const maxDelay = document.getElementById('dashboardMaxDelay').value;
            const startTime = document.getElementById('dashboardStartTime').value;
            const endTime = document.getElementById('dashboardEndTime').value;
            const timezone = document.getElementById('dashboardTimezone').value;

            const settings = {
                minDelay: parseInt(minDelay),
                maxDelay: parseInt(maxDelay),
                startTime: startTime,
                endTime: endTime,
                timezone: timezone
            };

            // Save to localStorage
            localStorage.setItem('dashboardTimingSettings', JSON.stringify(settings));

            // Also save individual values for extra safety
            localStorage.setItem('dashboardMinDelay', minDelay);
            localStorage.setItem('dashboardMaxDelay', maxDelay);
            localStorage.setItem('dashboardStartTime', startTime);
            localStorage.setItem('dashboardEndTime', endTime);
            localStorage.setItem('dashboardTimezone', timezone);

            console.log('Saved dashboard timing settings:', settings);
            console.log('Also saved individual values for safety');

            // Test: Immediately try to load the settings to verify they were saved
            setTimeout(() => {
                const testSettings = localStorage.getItem('dashboardTimingSettings');
                const testMin = localStorage.getItem('dashboardMinDelay');
                console.log('Test - Retrieved settings after save:', testSettings);
                console.log('Test - Retrieved min delay after save:', testMin);
            }, 100);

            // Show success feedback
            const saveBtn = document.querySelector('button[onclick="saveDashboardTimingSettings()"]');
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '<i class="fas fa-check"></i> Saved!';
            saveBtn.style.background = '#10b981';
            saveBtn.style.color = 'white';

            setTimeout(() => {
                saveBtn.innerHTML = originalText;
                saveBtn.style.background = '';
                saveBtn.style.color = '';
            }, 2000);
        }

        function testSettings() {
            console.log('=== TESTING SETTINGS ===');
            console.log('Current slider values:');
            console.log('Min Delay:', document.getElementById('dashboardMinDelay')?.value);
            console.log('Max Delay:', document.getElementById('dashboardMaxDelay')?.value);
            console.log('Display values:');
            console.log('Min Display:', document.getElementById('dashboardMinDelayValue')?.textContent);
            console.log('Max Display:', document.getElementById('dashboardMaxDelayValue')?.textContent);
            console.log('localStorage dashboardTimingSettings:', localStorage.getItem('dashboardTimingSettings'));
            console.log('=== END TEST ===');
        }

        function debugAPIConnection() {
            const apiKey = document.getElementById('apiSettingsKey').value;
            console.log('=== DEBUG API CONNECTION ===');
            console.log('API Key length:', apiKey ? apiKey.length : 'No key');
            console.log('API Key preview:', apiKey ? apiKey.substring(0, 10) + '...' : 'No key');

            if (!apiKey) {
                alert('Please enter your API key first');
                return;
            }

            // Test multiple authentication methods and endpoints
            const tests = [
                {
                    name: 'Bearer Token - v1/phone-numbers',
                    url: 'https://api.telynx.com/v1/phone-numbers',
                    headers: { 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/json' }
                },
                {
                    name: 'API Key Header - v1/phone-numbers',
                    url: 'https://api.telynx.com/v1/phone-numbers',
                    headers: { 'X-API-Key': apiKey, 'Content-Type': 'application/json' }
                },
                {
                    name: 'Bearer Token - v1/numbers',
                    url: 'https://api.telynx.com/v1/numbers',
                    headers: { 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/json' }
                },
                {
                    name: 'API Key Header - v1/numbers',
                    url: 'https://api.telynx.com/v1/numbers',
                    headers: { 'X-API-Key': apiKey, 'Content-Type': 'application/json' }
                },
                {
                    name: 'Bearer Token - phone-numbers',
                    url: 'https://api.telynx.com/phone-numbers',
                    headers: { 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/json' }
                },
                {
                    name: 'API Key Header - phone-numbers',
                    url: 'https://api.telynx.com/phone-numbers',
                    headers: { 'X-API-Key': apiKey, 'Content-Type': 'application/json' }
                }
            ];

            let completedTests = 0;

            tests.forEach((test, index) => {
                console.log(`\n--- Test ${index + 1}: ${test.name} ---`);

                fetch(test.url, {
                    method: 'GET',
                    headers: test.headers
                })
                    .then(response => {
                        console.log(`Status: ${response.status}`);
                        console.log(`Headers:`, [...response.headers.entries()]);
                        return response.text();
                    })
                    .then(text => {
                        console.log(`Response: ${text.substring(0, 200)}...`);
                        if (text.includes('phone') || text.includes('number')) {
                            console.log('✅ SUCCESS: Found phone number data!');
                            alert(`✅ SUCCESS with ${test.name}! Check console for details.`);
                        }
                    })
                    .catch(error => {
                        console.log(`Error: ${error.message}`);
                    })
                    .finally(() => {
                        completedTests++;
                        if (completedTests === tests.length) {
                            console.log('\n=== ALL TESTS COMPLETED ===');
                            alert('All API tests completed. Check console for results.');
                        }
                    });
            });
        }

        function testBasicConnection() {
            console.log('=== TESTING BASIC CONNECTIVITY ===');

            // Test if we can reach any external API
            fetch('https://httpbin.org/get')
                .then(response => {
                    console.log('Basic internet connectivity: ✅ OK');
                    return response.json();
                })
                .then(data => {
                    console.log('HTTPBin response:', data);
                })
                .catch(error => {
                    console.log('Basic internet connectivity: ❌ FAILED');
                    console.log('Error:', error);
                });

            // Test if we can reach Telynx domain
            fetch('https://api.telynx.com/', { method: 'HEAD' })
                .then(response => {
                    console.log('Telynx domain reachable: ✅ OK');
                })
                .catch(error => {
                    console.log('Telynx domain reachable: ❌ FAILED');
                    console.log('Error:', error);
                });

            // Test CORS
            fetch('https://api.telynx.com/v1/phone-numbers', { method: 'OPTIONS' })
                .then(response => {
                    console.log('CORS preflight: ✅ OK');
                })
                .catch(error => {
                    console.log('CORS preflight: ❌ FAILED');
                    console.log('Error:', error);
                });

            // Test alternative domain
            fetch('https://api.telynx.net/', { method: 'HEAD' })
                .then(response => {
                    console.log('Telynx.net domain reachable: ✅ OK');
                })
                .catch(error => {
                    console.log('Telynx.net domain reachable: ❌ FAILED');
                    console.log('Error:', error);
                });
        }

        function testCORSIssue() {
            const apiKey = document.getElementById('apiSettingsKey').value;
            console.log('=== TESTING CORS ISSUE ===');

            // Try with no-cors mode
            fetch('https://api.telynx.com/v1/phone-numbers', {
                method: 'GET',
                mode: 'no-cors',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json'
                }
            })
                .then(response => {
                    console.log('No-CORS response:', response);
                })
                .catch(error => {
                    console.log('No-CORS failed:', error);
                });

            // Try with credentials
            fetch('https://api.telynx.com/v1/phone-numbers', {
                method: 'GET',
                credentials: 'include',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json'
                }
            })
                .then(response => {
                    console.log('With credentials response:', response);
                })
                .catch(error => {
                    console.log('With credentials failed:', error);
                });
        }

        function setupLocalProxy() {
            console.log('=== SETTING UP LOCAL PROXY ===');

            const proxyCode = `
// Save this as 'proxy-server.js' and run with: node proxy-server.js

const express = require('express');
const cors = require('cors');
const fetch = require('node-fetch');

const app = express();
const PORT = 3001;

app.use(cors());
app.use(express.json());

app.get('/api/telynx/phone-numbers', async (req, res) => {
    try {
        const apiKey = req.headers.authorization;
        
        const response = await fetch('https://api.telynx.com/v1/phone-numbers', {
            method: 'GET',
            headers: {
                'Authorization': apiKey,
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        res.json(data);
    } catch (error) {
        res.status(500).json({ error: error.message });
    }
});

app.listen(PORT, () => {
    console.log('Proxy server running on http://localhost:3001');
    console.log('Use this URL in your app: http://localhost:3001/api/telynx/phone-numbers');
});
            `;

            alert(`🔧 SETUP LOCAL PROXY SERVER\n\n1. Create a new file called 'proxy-server.js'\n2. Copy the code below into it:\n\n${proxyCode}\n\n3. Install dependencies: npm install express cors node-fetch\n4. Run: node proxy-server.js\n5. Then try connecting again!`);

            console.log('Proxy setup instructions provided');
        }

        function forceLoadSettings() {
            console.log('=== FORCE LOADING SETTINGS ===');

            const savedMin = localStorage.getItem('dashboardMinDelay');
            const savedMax = localStorage.getItem('dashboardMaxDelay');

            console.log('Saved values - Min:', savedMin, 'Max:', savedMax);

            const minSlider = document.getElementById('dashboardMinDelay');
            const maxSlider = document.getElementById('dashboardMaxDelay');

            if (minSlider && savedMin) {
                minSlider.value = savedMin;
                updateMinDelayDisplay(savedMin);
                console.log('FORCED min delay to:', savedMin);

                // Force the display to update
                const minDisplay = document.getElementById('dashboardMinDelayValue');
                if (minDisplay) {
                    minDisplay.textContent = savedMin + ' sec';
                }
            }

            if (maxSlider && savedMax) {
                maxSlider.value = savedMax;
                updateMaxDelayDisplay(savedMax);
                console.log('FORCED max delay to:', savedMax);

                // Force the display to update
                const maxDisplay = document.getElementById('dashboardMaxDelayValue');
                if (maxDisplay) {
                    maxDisplay.textContent = savedMax + ' sec';
                }
            }

            console.log('=== FORCE LOAD COMPLETE ===');
        }

        // Run immediately when script loads
        function immediateLoadSettings() {
            console.log('=== IMMEDIATE LOAD ATTEMPT ===');

            const savedMin = localStorage.getItem('dashboardMinDelay');
            const savedMax = localStorage.getItem('dashboardMaxDelay');

            if (savedMin) {
                console.log('Found saved min delay:', savedMin);
                // Set the value even if element doesn't exist yet
                window.savedMinDelay = savedMin;
            }

            if (savedMax) {
                console.log('Found saved max delay:', savedMax);
                // Set the value even if element doesn't exist yet
                window.savedMaxDelay = savedMax;
            }
        }

        // Call immediately
        immediateLoadSettings();

        // Create a MutationObserver to prevent overrides
        function createSettingsProtector() {
            const savedMin = localStorage.getItem('dashboardMinDelay');
            const savedMax = localStorage.getItem('dashboardMaxDelay');

            if (savedMin || savedMax) {
                console.log('Creating settings protector with saved values - Min:', savedMin, 'Max:', savedMax);

                // Watch for changes to the sliders
                const observer = new MutationObserver((mutations) => {
                    mutations.forEach((mutation) => {
                        if (mutation.type === 'attributes' && mutation.attributeName === 'value') {
                            const target = mutation.target;
                            if (target.id === 'dashboardMinDelay' && savedMin) {
                                if (target.value !== savedMin) {
                                    console.log('Preventing min delay override, setting back to:', savedMin);
                                    target.value = savedMin;
                                    updateMinDelayDisplay(savedMin);
                                }
                            }
                            if (target.id === 'dashboardMaxDelay' && savedMax) {
                                if (target.value !== savedMax) {
                                    console.log('Preventing max delay override, setting back to:', savedMax);
                                    target.value = savedMax;
                                    updateMaxDelayDisplay(savedMax);
                                }
                            }
                        }
                    });
                });

                // Start observing when elements are ready
                const startObserving = () => {
                    const minSlider = document.getElementById('dashboardMinDelay');
                    const maxSlider = document.getElementById('dashboardMaxDelay');

                    if (minSlider && maxSlider) {
                        observer.observe(minSlider, { attributes: true });
                        observer.observe(maxSlider, { attributes: true });
                        console.log('Settings protector activated');
                    } else {
                        setTimeout(startObserving, 100);
                    }
                };

                startObserving();
            }
        }

        // Start the protector
        createSettingsProtector();

        // Continuous protection - check every second
        function continuousProtection() {
            const savedMin = localStorage.getItem('dashboardMinDelay');
            const savedMax = localStorage.getItem('dashboardMaxDelay');

            if (savedMin || savedMax) {
                const minSlider = document.getElementById('dashboardMinDelay');
                const maxSlider = document.getElementById('dashboardMaxDelay');

                if (minSlider && savedMin && minSlider.value !== savedMin) {
                    console.log('Continuous protection: Fixing min delay from', minSlider.value, 'to', savedMin);
                    minSlider.value = savedMin;
                    updateMinDelayDisplay(savedMin);
                }

                if (maxSlider && savedMax && maxSlider.value !== savedMax) {
                    console.log('Continuous protection: Fixing max delay from', maxSlider.value, 'to', savedMax);
                    maxSlider.value = savedMax;
                    updateMaxDelayDisplay(savedMax);
                }
            }
        }

        // Run continuous protection every second
        setInterval(continuousProtection, 1000);

        function saveMinDelay(value) {
            localStorage.setItem('dashboardMinDelay', value);
            console.log('Saved min delay:', value);
        }

        function saveMaxDelay(value) {
            localStorage.setItem('dashboardMaxDelay', value);
            console.log('Saved max delay:', value);
        }

        function loadMinDelay() {
            const saved = localStorage.getItem('dashboardMinDelay') || window.savedMinDelay;
            console.log('Trying to load min delay, saved value:', saved);

            if (saved) {
                // Try multiple times to ensure element is ready
                let attempts = 0;
                const maxAttempts = 10;

                const tryLoad = () => {
                    const slider = document.getElementById('dashboardMinDelay');
                    if (slider) {
                        slider.value = saved;
                        updateMinDelayDisplay(saved);
                        console.log('Successfully loaded min delay:', saved);

                        // Force display update
                        const display = document.getElementById('dashboardMinDelayValue');
                        if (display) {
                            display.textContent = saved + ' sec';
                        }
                        return true;
                    } else {
                        attempts++;
                        if (attempts < maxAttempts) {
                            console.log('Min delay slider not ready, attempt:', attempts);
                            setTimeout(tryLoad, 100);
                        } else {
                            console.log('Failed to load min delay after', maxAttempts, 'attempts');
                        }
                    }
                };

                tryLoad();
            } else {
                console.log('No saved min delay found');
            }
        }

        function loadMaxDelay() {
            const saved = localStorage.getItem('dashboardMaxDelay') || window.savedMaxDelay;
            console.log('Trying to load max delay, saved value:', saved);

            if (saved) {
                // Try multiple times to ensure element is ready
                let attempts = 0;
                const maxAttempts = 10;

                const tryLoad = () => {
                    const slider = document.getElementById('dashboardMaxDelay');
                    if (slider) {
                        slider.value = saved;
                        updateMaxDelayDisplay(saved);
                        console.log('Successfully loaded max delay:', saved);

                        // Force display update
                        const display = document.getElementById('dashboardMaxDelayValue');
                        if (display) {
                            display.textContent = saved + ' sec';
                        }
                        return true;
                    } else {
                        attempts++;
                        if (attempts < maxAttempts) {
                            console.log('Max delay slider not ready, attempt:', attempts);
                            setTimeout(tryLoad, 100);
                        } else {
                            console.log('Failed to load max delay after', maxAttempts, 'attempts');
                        }
                    }
                };

                tryLoad();
            } else {
                console.log('No saved max delay found');
            }
        }

        function loadDashboardTimingSettings() {
            console.log('loadDashboardTimingSettings called');

            // Load individual values
            loadMinDelay();
            loadMaxDelay();

            // Load other settings
            const startTime = document.getElementById('dashboardStartTime');
            const endTime = document.getElementById('dashboardEndTime');
            const timezone = document.getElementById('dashboardTimezone');

            const savedStart = localStorage.getItem('dashboardStartTime');
            const savedEnd = localStorage.getItem('dashboardEndTime');
            const savedTimezone = localStorage.getItem('dashboardTimezone');

            if (startTime && savedStart) startTime.value = savedStart;
            if (endTime && savedEnd) endTime.value = savedEnd;
            if (timezone && savedTimezone) timezone.value = savedTimezone;

            console.log('Loaded all timing settings');
        }

        function updateMinDelayDisplay(value) {
            const minDelayValue = document.getElementById('dashboardMinDelayValue');
            if (minDelayValue) {
                minDelayValue.textContent = value + ' sec';
                console.log('Updated min delay to:', value + ' sec');
            }
        }

        function updateMaxDelayDisplay(value) {
            const maxDelayValue = document.getElementById('dashboardMaxDelayValue');
            if (maxDelayValue) {
                maxDelayValue.textContent = value + ' sec';
                console.log('Updated max delay to:', value + ' sec');
            }
        }

        function updateDashboardDelayDisplay() {
            const minDelay = document.getElementById('dashboardMinDelay');
            const maxDelay = document.getElementById('dashboardMaxDelay');
            const minDelayValue = document.getElementById('dashboardMinDelayValue');
            const maxDelayValue = document.getElementById('dashboardMaxDelayValue');

            if (minDelay && minDelayValue) {
                minDelayValue.textContent = minDelay.value + ' sec';
            }

            if (maxDelay && maxDelayValue) {
                maxDelayValue.textContent = maxDelay.value + ' sec';
            }
        }

        async function sendAdvancedSMS() {
            const phone = document.getElementById('advancedPhoneNumber').value;
            let message = document.getElementById('advancedMessage').value;
            const urgent = document.getElementById('urgentFlag').checked;
            const deliveryReceipt = document.getElementById('deliveryReceipt').checked;

            if (!phone || !message) {
                alert('Please fill in both phone number and message');
                return;
            }

            if (!telynxAPIKey) {
                alert('Please configure your Telynx API key first');
                return;
            }

            // Personalize message with business name
            if (message.includes('{business_name}')) {
                const businessName = localStorage.getItem('selectedBusinessName');
                if (!businessName) {
                    const newBusinessName = selectBusinessName();
                    if (!newBusinessName) {
                        alert('Please select a business name to continue');
                        return;
                    }
                    message = message.replace(/{business_name}/g, newBusinessName);
                } else {
                    message = message.replace(/{business_name}/g, businessName);
                }
            }

            // Replace other variables
            message = message.replace(/{name}/g, 'there');
            message = message.replace(/{company}/g, 'our company');
            message = message.replace(/{date}/g, new Date().toLocaleDateString());

            const success = await sendTelynxSMS(phone, message);
            if (success) {
                // Add to SMS history
                addToSMSHistory(phone, message, 'sent');
                alert('Advanced SMS sent successfully!');
                document.getElementById('advancedPhoneNumber').value = '';
                document.getElementById('advancedMessage').value = '';
                updateAdvancedCharCounter();
            }
        }

        function addToSMSHistory(phone, message, status) {
            const history = JSON.parse(localStorage.getItem('smsHistory') || '[]');
            history.unshift({
                phone,
                message: message.substring(0, 50) + (message.length > 50 ? '...' : ''),
                status,
                timestamp: new Date().toISOString()
            });
            localStorage.setItem('smsHistory', JSON.stringify(history.slice(0, 50)));
            updateSMSHistoryUI();
        }

        // Sent messages functions
        function addToSentMessages(phone, message, businessName = '') {
            const sentMessages = JSON.parse(localStorage.getItem('sentMessages') || '[]');
            const sentMessage = {
                phone,
                message,
                businessName,
                timestamp: new Date().toISOString(),
                id: Date.now()
            };
            sentMessages.unshift(sentMessage);
            localStorage.setItem('sentMessages', JSON.stringify(sentMessages.slice(0, 100)));
            updateSentMessagesUI();
        }

        function updateSentMessagesUI() {
            console.log('🔄 Updating sent messages UI...');

            const sentMessages = JSON.parse(localStorage.getItem('sentMessages') || '[]');
            console.log('📤 Found sent messages:', sentMessages.length);

            const container = document.getElementById('sentMessagesList');

            if (!container) {
                console.log('❌ Sent messages container not found');
                return;
            }

            if (sentMessages.length === 0) {
                container.innerHTML = '<div style="padding: 1rem; text-align: center; color: #6b7280;">No sent messages yet</div>';
                console.log('📤 No sent messages to display');
                return;
            }

            let html = '';
            sentMessages.forEach(msg => {
                const time = new Date(msg.timestamp).toLocaleTimeString([], {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                const date = new Date(msg.timestamp).toLocaleDateString();

                html += `
                    <div style="padding: 0.75rem; border-bottom: 1px solid #f3f4f6; display: flex; justify-content: space-between; align-items: flex-start;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: #374151; margin-bottom: 0.25rem;">${msg.phone}</div>
                            <div style="font-size: 0.9rem; color: #6b7280; margin-bottom: 0.25rem;">${msg.message}</div>
                            ${msg.businessName ? `<div style="font-size: 0.8rem; color: #059669; font-style: italic;">To: ${msg.businessName}</div>` : ''}
                        </div>
                        <div style="text-align: right; font-size: 0.8rem; color: #9ca3af;">
                            <div>${time}</div>
                            <div>${date}</div>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
            console.log('✅ Sent messages UI updated with', sentMessages.length, 'messages');
        }

        function refreshSentMessages() {
            console.log('🔄 Manual refresh of sent messages...');
            updateSentMessagesUI();
        }

        function clearSentMessages() {
            if (confirm('Are you sure you want to clear all sent message history?')) {
                localStorage.removeItem('sentMessages');
                updateSentMessagesUI();
                console.log('🗑️ Sent messages cleared');
            }
        }

        function getConversationHistory(phone) {
            const sentMessages = JSON.parse(localStorage.getItem('sentMessages') || '[]');
            const incomingMessages = JSON.parse(localStorage.getItem('incomingMessages') || '[]');

            // Get sent messages to this phone
            const sentToPhone = sentMessages.filter(msg => msg.phone === phone);

            // Get incoming messages from this phone
            const receivedFromPhone = incomingMessages.filter(msg => msg.from === phone);

            // Combine and sort by timestamp
            const conversation = [...sentToPhone, ...receivedFromPhone].sort((a, b) =>
                new Date(a.timestamp) - new Date(b.timestamp)
            );

            return conversation;
        }

        function updateIncomingMessagesUI() {
            const incomingMessages = JSON.parse(localStorage.getItem('incomingMessages') || '[]');
            const container = document.getElementById('incomingMessagesList');

            if (!container) return;

            if (incomingMessages.length === 0) {
                container.innerHTML = '<div style="padding: 1rem; text-align: center; color: #6b7280;">No incoming messages yet</div>';
                return;
            }

            let html = '';
            incomingMessages.slice(0, 5).forEach(msg => {
                const time = new Date(msg.timestamp).toLocaleTimeString([], {
                    hour: '2-digit',
                    minute: '2-digit'
                });

                html += `
                    <div class="message-item" onclick="openChat('${msg.from}', '${msg.from}')">
                        <div class="message-phone">${msg.from}</div>
                        <div class="message-preview">${msg.message}</div>
                        <div class="message-time">${time}</div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        function addIncomingMessage(from, message) {
            const incomingMessages = JSON.parse(localStorage.getItem('incomingMessages') || '[]');
            const newMessage = {
                from,
                message,
                timestamp: new Date().toISOString()
            };
            incomingMessages.unshift(newMessage);
            localStorage.setItem('incomingMessages', JSON.stringify(incomingMessages.slice(0, 50)));
            updateIncomingMessagesUI();
        }

        function updateSMSHistoryUI() {
            const history = JSON.parse(localStorage.getItem('smsHistory') || '[]');
            const container = document.getElementById('smsHistory');

            if (history.length === 0) {
                container.innerHTML = '<div style="padding: 1rem; text-align: center; color: #6b7280;">No SMS history yet</div>';
                return;
            }

            let html = '';
            history.forEach(item => {
                const time = new Date(item.timestamp).toLocaleTimeString();
                const statusColor = item.status === 'sent' ? '#16a34a' : '#dc2626';
                html += `
                    <div style="padding: 0.75rem; border-bottom: 1px solid #f3f4f6; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: 600; color: #374151;">${item.phone}</div>
                            <div style="font-size: 0.9rem; color: #6b7280;">${item.message}</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 0.8rem; color: ${statusColor};">${item.status}</div>
                            <div style="font-size: 0.8rem; color: #9ca3af;">${time}</div>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        function clearSMSHistory() {
            localStorage.removeItem('smsHistory');
            updateSMSHistoryUI();
        }

        function saveTemplate() {
            const name = document.getElementById('templateName').value;
            const content = document.getElementById('templateContent').value;

            if (!name || !content) {
                alert('Please fill in both template name and content');
                return;
            }

            const templates = JSON.parse(localStorage.getItem('smsTemplates') || '{}');
            templates[name] = content;
            localStorage.setItem('smsTemplates', JSON.stringify(templates));
            alert('Template saved successfully!');

            document.getElementById('templateName').value = '';
            document.getElementById('templateContent').value = '';
        }

        function loadTemplates() {
            const templates = JSON.parse(localStorage.getItem('smsTemplates') || '{}');
            const templateNames = Object.keys(templates);

            if (templateNames.length === 0) {
                alert('No saved templates found');
                return;
            }

            const templateName = prompt('Enter template name to load:\n\nAvailable templates:\n' + templateNames.join('\n'));
            if (templateName && templates[templateName]) {
                document.getElementById('templateContent').value = templates[templateName];
            }
        }

        // Voicemail Campaign functions
        function handleCampaignAudioUpload(input) {
            const file = input.files[0];
            if (!file) return;

            if (!file.type.startsWith('audio/')) {
                alert('Please select an audio file');
                return;
            }

            alert('Audio file uploaded: ' + file.name);
        }

        function startVoicemailCampaign() {
            const campaignName = document.getElementById('voicemailCampaignName').value;
            const targets = document.getElementById('voicemailTargets').value;
            const schedule = document.getElementById('voicemailCampaignSchedule').value;

            if (!campaignName || !targets) {
                alert('Please fill in campaign name and target phone numbers');
                return;
            }

            const phoneNumbers = targets.split('\n').filter(num => num.trim());
            alert(`Starting voicemail campaign "${campaignName}" to ${phoneNumbers.length} recipients`);

            // Update voicemail analytics
            document.getElementById('voicemailSent').textContent = parseInt(document.getElementById('voicemailSent').textContent) + phoneNumbers.length;
            document.getElementById('voicemailDelivered').textContent = parseInt(document.getElementById('voicemailDelivered').textContent) + phoneNumbers.length;
        }

        function saveVoicemailTemplate() {
            const name = document.getElementById('voicemailTemplateName').value;
            const desc = document.getElementById('voicemailTemplateDesc').value;
            const duration = document.getElementById('voicemailDuration').value;

            if (!name || !desc) {
                alert('Please fill in template name and description');
                return;
            }

            alert('Voicemail template saved: ' + name);
        }

        // Messaging Behavior functions
        function saveTimingSettings() {
            const startTime = document.getElementById('businessStartTime').value;
            const endTime = document.getElementById('businessEndTime').value;
            const timezone = document.getElementById('timezone').value;
            const minDelay = document.getElementById('minDelay').value;
            const maxDelay = document.getElementById('maxDelay').value;

            localStorage.setItem('timingSettings', JSON.stringify({
                startTime, endTime, timezone, minDelay, maxDelay
            }));

            alert('Timing settings saved successfully!');
        }

        function saveAutomationRules() {
            const autoReplyEnabled = document.getElementById('autoReplyEnabled').checked;
            const autoReplyMessage = document.getElementById('autoReplyMessage').value;
            const followUpEnabled = document.getElementById('followUpEnabled').checked;
            const followUpDelay = document.getElementById('followUpDelay').value;

            localStorage.setItem('automationRules', JSON.stringify({
                autoReplyEnabled, autoReplyMessage, followUpEnabled, followUpDelay
            }));

            alert('Automation rules saved successfully!');
        }

        // API Settings functions - FIXED VERSION
        function testAPIConnection() {
            const apiKey = document.getElementById('apiSettingsKey').value.trim();

            if (!apiKey) {
                alert('Please enter your API key first');
                return;
            }

            // Show testing status
            const statusElement = document.getElementById('apiStatus');
            statusElement.innerHTML = '<span style="color: #f59e0b;">●</span> Testing...';

            // Clean the API key - remove any "Bearer " prefix and trim
            let cleanApiKey = apiKey;
            if (cleanApiKey.startsWith('Bearer ')) {
                cleanApiKey = cleanApiKey.substring(7).trim();
            }

            console.log('Testing Telynx API connection...');
            console.log('API Key length:', cleanApiKey.length);
            console.log('API Key preview:', cleanApiKey.substring(0, 10) + '...');

            // Use the correct endpoint that we know works
            const endpoint = 'https://api.telnyx.com/v2/phone_numbers';
            const headers = {
                'Authorization': `Bearer ${cleanApiKey}`,
                'Content-Type': 'application/json'
            };

            console.log('Using endpoint:', endpoint);
            console.log('Using headers:', headers);

            // Test the API connection through our backend
            fetch('http://localhost:3000/api/test-connection', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ apiKey: cleanApiKey })
            })
                .then(response => {
                    console.log('Backend API - Status:', response.status);

                    if (response.ok) {
                        return response.json();
                    } else {
                        return response.text().then(errorText => {
                            throw new Error(`Backend API failed: ${response.status} - ${errorText}`);
                        });
                    }
                })
                .then(async data => {
                    console.log('Backend API - Success! Data:', data);
                    
                    if (data.success) {
                        statusElement.innerHTML = '<span style="color: #16a34a;">●</span> Connected';
                        
                        // Update phone numbers display with real data
                        if (data.phoneNumbers) {
                            updatePhoneNumbersDisplay({ data: data.phoneNumbers });
                        }

                        alert('✅ API connected successfully!');
                        return true;
                    } else {
                        throw new Error(data.error || 'API connection failed');
                    }
                })
                .catch(error => {
                    console.log('Backend API failed:', error.message);
                    statusElement.innerHTML = '<span style="color: #dc2626;">●</span> Failed';
                    alert('❌ API connection failed: ' + error.message);
                });
        }
        }

        function updatePhoneNumbersDisplay(data) {
            const container = document.getElementById('apiPhoneNumbersContainer');

            if (!container) {
                console.log('Phone numbers container not found');
                return;
            }

            console.log('Updating phone numbers display with data:', data);

            if (data && data.phone_numbers && data.phone_numbers.length > 0) {
                let html = '<div style="max-height: 200px; overflow-y: auto;">';
                data.phone_numbers.forEach((number, index) => {
                    html += `
                        <div style="padding: 0.5rem; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${number.phone_number || number.number || 'Unknown'}</strong>
                                <div style="font-size: 0.8rem; color: #6b7280;">
                                    ${number.friendly_name || number.description || 'No description'}
                                </div>
                            </div>
                            <span style="color: #16a34a; font-size: 0.8rem;">● Active</span>
                        </div>
                    `;
                });
                html += '</div>';
                container.innerHTML = html;
                console.log('Displayed', data.phone_numbers.length, 'phone numbers');
            } else if (data && data.data && data.data.length > 0) {
                // Alternative data structure
                let html = '<div style="max-height: 200px; overflow-y: auto;">';
                data.data.forEach((number, index) => {
                    html += `
                        <div style="padding: 0.5rem; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${number.phone_number || number.number || 'Unknown'}</strong>
                                <div style="font-size: 0.8rem; color: #6b7280;">
                                    ${number.friendly_name || number.description || 'No description'}
                                </div>
                            </div>
                            <span style="color: #16a34a; font-size: 0.8rem;">● Active</span>
                        </div>
                    `;
                });
                html += '</div>';
                container.innerHTML = html;
                console.log('Displayed', data.data.length, 'phone numbers');
            } else {
                container.innerHTML = `
                    <div style="padding: 1rem; text-align: center; color: #6b7280;">
                        <div style="margin-bottom: 0.5rem;">No phone numbers found</div>
                        <div style="font-size: 0.8rem;">Your Telynx account has no phone numbers available</div>
                    </div>
                `;
                console.log('No phone numbers found in API response');
            }
        }

        // OLD WEBHOOK FUNCTIONS REMOVED - Using new embedded functions in API Settings section

        // BULLETPROOF API SETTINGS SAVE FUNCTION
        function saveAPISettings() {
            const apiKey = document.getElementById('apiSettingsKey').value.trim();
            const webhook = document.getElementById('apiSettingsWebhook').value.trim();

            if (!apiKey) {
                alert('Please enter an API key');
                return;
            }

            try {
                // ENHANCED WEBHOOK URL SAVING - Multiple backup methods
                localStorage.setItem('telynxAPIKey', apiKey);
                localStorage.setItem('apiKey', apiKey);

                // Save webhook URL with multiple keys for maximum persistence
                if (webhook) {
                    localStorage.setItem('telynxWebhookUrl', webhook);
                    localStorage.setItem('webhookUrl', webhook);
                    localStorage.setItem('webhook', webhook);
                    console.log('✅ Webhook URL saved with multiple keys:', webhook);
                }

                localStorage.setItem('apiSettings', JSON.stringify({
                    apiKey: apiKey,
                    webhook: webhook,
                    webhookUrl: webhook,
                    savedAt: new Date().toISOString()
                }));
                localStorage.setItem('apiSettingsSaved', 'true');

                console.log('✅ API settings saved to localStorage');
                console.log('✅ API Key:', apiKey.substring(0, 10) + '...');
                console.log('✅ Webhook:', webhook || 'Not provided');

                // Update global variable
                window.telynxAPIKey = apiKey;
                telynxAPIKey = apiKey;

                // FORCE FIELD VALUES TO PERSIST
                const webhookField = document.getElementById('apiSettingsWebhook');
                if (webhookField && webhook) {
                    webhookField.value = webhook;
                    webhookField.setAttribute('value', webhook);

                    // Add event listener to prevent value loss
                    webhookField.addEventListener('blur', function () {
                        if (this.value !== webhook) {
                            console.log('🔄 Webhook field changed, updating localStorage...');
                            localStorage.setItem('telynxWebhookUrl', this.value);
                            localStorage.setItem('webhookUrl', this.value);
                            localStorage.setItem('webhook', this.value);
                        }
                    });
                }

                // Show success message
                const saveButton = document.querySelector('button[onclick="saveAPISettings()"]');
                if (saveButton) {
                    const originalHTML = saveButton.innerHTML;
                    const originalBackground = saveButton.style.background;

                    saveButton.innerHTML = '<i class="fas fa-check"></i> Saved!';
                    saveButton.style.background = '#28a745';

                    setTimeout(() => {
                        saveButton.innerHTML = originalHTML;
                        saveButton.style.background = originalBackground;
                    }, 2000);
                }

                // Verify save worked by immediately trying to load
                setTimeout(() => {
                    const savedWebhook = localStorage.getItem('telynxWebhookUrl');
                    if (savedWebhook !== webhook) {
                        console.log('⚠️ Webhook save verification failed, retrying...');
                        localStorage.setItem('telynxWebhookUrl', webhook);
                    } else {
                        console.log('✅ Webhook save verified successfully');
                    }
                }, 100);

                // Test connection and setup account
                setTimeout(async () => {
                    await setupTelynxAccount();
                }, 500);

            } catch (error) {
                console.error('Failed to save settings:', error);
                alert('Failed to save settings: ' + error.message);
            }
        }

        // BULLETPROOF API SETTINGS LOAD FUNCTION
        function loadAPISettings() {
            try {
                console.log('🔄 Loading API settings...');

                // Try multiple sources to get the API key
                let apiKey = localStorage.getItem('telynxAPIKey');
                if (!apiKey) apiKey = localStorage.getItem('apiKey');
                if (!apiKey) {
                    const apiSettings = localStorage.getItem('apiSettings');
                    if (apiSettings) {
                        try {
                            const settings = JSON.parse(apiSettings);
                            apiKey = settings.apiKey;
                        } catch (e) { }
                    }
                }

                // ENHANCED WEBHOOK URL LOADING - Try multiple sources
                let webhook = localStorage.getItem('telynxWebhookUrl');
                if (!webhook) webhook = localStorage.getItem('webhookUrl');
                if (!webhook) webhook = localStorage.getItem('webhook');
                if (!webhook) {
                    const apiSettings = localStorage.getItem('apiSettings');
                    if (apiSettings) {
                        try {
                            const settings = JSON.parse(apiSettings);
                            webhook = settings.webhook || settings.webhookUrl;
                        } catch (e) { }
                    }
                }

                console.log('Found in localStorage:', apiKey ? 'API Key: ' + apiKey.substring(0, 10) + '...' : 'No API key');
                console.log('Found webhook:', webhook ? 'Webhook: ' + webhook : 'No webhook');

                // BULLETPROOF FIELD LOADING - Multiple attempts with different delays
                const loadFields = (attempt = 1) => {
                    const apiKeyField = document.getElementById('apiSettingsKey');
                    const webhookField = document.getElementById('apiSettingsWebhook');

                    console.log(`Attempt ${attempt} - Form fields found:`,
                        apiKeyField ? 'API Key field: YES' : 'API Key field: NO',
                        webhookField ? 'Webhook field: YES' : 'Webhook field: NO');

                    if (apiKeyField && apiKey) {
                        apiKeyField.value = apiKey;
                        console.log('✅ API key loaded into form field');
                        apiKeyField.dispatchEvent(new Event('input', { bubbles: true }));

                        // Show load status indicator
                        const statusDiv = document.getElementById('apiLoadStatus');
                        if (statusDiv) {
                            statusDiv.style.display = 'block';
                            setTimeout(() => {
                                statusDiv.style.display = 'none';
                            }, 3000);
                        }
                    }

                    if (webhookField && webhook) {
                        webhookField.value = webhook;
                        console.log('✅ Webhook URL loaded into form field:', webhook);
                        webhookField.dispatchEvent(new Event('input', { bubbles: true }));

                        // Force the field to show the value
                        webhookField.setAttribute('value', webhook);

                        // Additional verification
                        setTimeout(() => {
                            if (webhookField.value !== webhook) {
                                console.log('🔄 Webhook field lost value, restoring...');
                                webhookField.value = webhook;
                            }
                        }, 100);
                    }

                    // Update global variable
                    if (apiKey) {
                        window.telynxAPIKey = apiKey;
                        telynxAPIKey = apiKey;
                        console.log('✅ Global variable updated');
                    }

                    // If fields weren't found and we haven't tried too many times, try again
                    if ((!apiKeyField || !webhookField) && attempt < 5) {
                        console.log(`🔄 Retrying field loading in ${attempt * 100}ms...`);
                        setTimeout(() => loadFields(attempt + 1), attempt * 100);
                    }
                };

                // Start loading with immediate attempt
                loadFields(1);

                // Also try after short delays to catch late DOM updates
                setTimeout(() => loadFields(2), 50);
                setTimeout(() => loadFields(3), 200);
                setTimeout(() => loadFields(4), 500);

                console.log('🔄 Load complete');
            }, 50);

        } catch (error) {
            console.error('Failed to load settings:', error);
        }
        }

        function updateAPIUsage() {
            const apiKey = document.getElementById('apiSettingsKey').value;
            if (!apiKey) return;

            // Get today's date
            const today = new Date().toDateString();
            const callsToday = parseInt(localStorage.getItem(`apiCalls_${today}`) || '0');

            // Update calls today
            document.getElementById('apiCallsToday').textContent = callsToday;

            // Simulate credits (you can replace this with real API call)
            const credits = Math.floor(Math.random() * 1000) + 100;
            document.getElementById('apiCredits').textContent = credits;
        }

        // Function to verify API settings are saved correctly
        function verifyAPISettings() {
            console.log('=== VERIFYING API SETTINGS ===');

            // Check localStorage
            const jsonSettings = localStorage.getItem('apiSettings');
            const individualKey = localStorage.getItem('telynxAPIKey');
            const individualWebhook = localStorage.getItem('telynxWebhookUrl');
            const savedFlag = localStorage.getItem('apiSettingsSaved');

            console.log('JSON Settings:', jsonSettings ? '✅ Found' : '❌ Not found');
            console.log('Individual API Key:', individualKey ? '✅ Found' : '❌ Not found');
            console.log('Individual Webhook:', individualWebhook ? '✅ Found' : '❌ Not found');
            console.log('Saved Flag:', savedFlag ? '✅ Found' : '❌ Not found');

            // Check form fields
            const apiKeyField = document.getElementById('apiSettingsKey');
            const webhookField = document.getElementById('apiSettingsWebhook');

            console.log('API Key Field Value:', apiKeyField ? apiKeyField.value.substring(0, 10) + '...' : '❌ Field not found');
            console.log('Webhook Field Value:', webhookField ? webhookField.value : '❌ Field not found');

            // Check global variable
            console.log('Global API Key:', window.telynxAPIKey ? window.telynxAPIKey.substring(0, 10) + '...' : '❌ Not set');

            // Show alert with summary
            let summary = 'API Settings Status:\n\n';
            summary += jsonSettings ? '✅ JSON Settings: Saved\n' : '❌ JSON Settings: Not saved\n';
            summary += individualKey ? '✅ Individual Key: Saved\n' : '❌ Individual Key: Not saved\n';
            summary += apiKeyField && apiKeyField.value ? '✅ Form Field: Has value\n' : '❌ Form Field: Empty\n';
            summary += window.telynxAPIKey ? '✅ Global Variable: Set\n' : '❌ Global Variable: Not set\n';

            alert(summary);
            console.log('=== END VERIFICATION ===');
        }

        function refreshPhoneNumbers() {
            const apiKey = document.getElementById('apiSettingsKey').value;

            if (!apiKey) {
                alert('Please enter your API key first');
                return;
            }

            console.log('Refreshing phone numbers...');

            // Show loading state
            const container = document.getElementById('apiPhoneNumbersContainer');
            if (container) {
                container.innerHTML = `
                    <div style="padding: 1rem; text-align: center; color: #6b7280;">
                        <div style="margin-bottom: 0.5rem;">Loading phone numbers...</div>
                        <div style="font-size: 0.8rem;">Please wait</div>
                    </div>
                `;
            }

            // Fetch phone numbers
            fetch('https://api.telynx.com/v1/phone-numbers', {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json'
                }
            })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        throw new Error(`API request failed with status: ${response.status}`);
                    }
                })
                .then(data => {
                    console.log('Refreshed phone numbers data:', data);
                    updatePhoneNumbersDisplay(data);
                })
                .catch(error => {
                    console.error('Failed to refresh phone numbers:', error);
                    if (container) {
                        container.innerHTML = `
                        <div style="padding: 1rem; text-align: center; color: #dc2626;">
                            <div style="margin-bottom: 0.5rem;">Failed to load phone numbers</div>
                            <div style="font-size: 0.8rem;">${error.message}</div>
                        </div>
                    `;
                    }
                });
        }

        // Integration functions
        function connectCRM() {
            const platform = document.getElementById('crmPlatform').value;
            const apiKey = document.getElementById('crmApiKey').value;
            const webhook = document.getElementById('crmWebhookUrl').value;

            if (!platform || !apiKey) {
                alert('Please select CRM platform and enter API key');
                return;
            }

            alert(`Connecting to ${platform}...`);
            setTimeout(() => {
                alert('CRM connected successfully!');
                updateIntegrationStatus('CRM', true);
            }, 2000);
        }

        function connectEmail() {
            const service = document.getElementById('emailService').value;
            const email = document.getElementById('emailAddress').value;
            const apiKey = document.getElementById('emailApiKey').value;

            if (!service || !email || !apiKey) {
                alert('Please fill in all email integration fields');
                return;
            }

            alert(`Connecting to ${service}...`);
            setTimeout(() => {
                alert('Email service connected successfully!');
                updateIntegrationStatus('Email', true);
            }, 2000);
        }

        function connectAnalytics() {
            const platform = document.getElementById('analyticsPlatform').value;
            const trackingId = document.getElementById('trackingId').value;
            const webhook = document.getElementById('analyticsWebhook').value;

            if (!platform || !trackingId) {
                alert('Please select analytics platform and enter tracking ID');
                return;
            }

            alert(`Connecting to ${platform}...`);
            setTimeout(() => {
                alert('Analytics connected successfully!');
                updateIntegrationStatus('Analytics', true);
            }, 2000);
        }

        function updateIntegrationStatus(type, connected) {
            const statusContainer = document.getElementById('integrationStatus');
            const statusElements = statusContainer.querySelectorAll('div');

            statusElements.forEach(element => {
                if (element.textContent.includes(type)) {
                    const statusSpan = element.querySelector('span:last-child');
                    if (connected) {
                        statusSpan.style.color = '#16a34a';
                        statusSpan.textContent = '● Connected';
                    } else {
                        statusSpan.style.color = '#dc2626';
                        statusSpan.textContent = '● Disconnected';
                    }
                }
            });
        }

        function testCRMConnection() {
            alert('Testing CRM connection...');
            setTimeout(() => {
                alert('CRM connection test successful!');
            }, 1500);
        }

        function refreshIntegrations() {
            alert('Refreshing integration status...');
            setTimeout(() => {
                alert('Integration status refreshed!');
            }, 1000);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function () {
            console.log('CodeLife SMS Clean Dashboard loaded');

            // Ensure all basic elements are working
            try {
                // Test basic DOM elements
                const messageInput = document.getElementById('message');
                const phoneInput = document.getElementById('phoneNumber');
                const charCounter = document.querySelector('.char-counter');

                console.log('✅ Basic elements check:');
                console.log('  Message input:', !!messageInput);
                console.log('  Phone input:', !!phoneInput);
                console.log('  Char counter:', !!charCounter);

                // Character counter is handled separately above

                // Immediate attempt to load sent messages
                setTimeout(() => {
                    console.log('🔄 DOM ready - loading sent messages...');
                    const sentMessages = JSON.parse(localStorage.getItem('sentMessages') || '[]');
                    console.log(`📤 Found ${sentMessages.length} messages in localStorage`);
                    if (sentMessages.length > 0) {
                        updateSentMessagesUI();
                    }
                }, 100);

            } catch (error) {
                console.error('❌ Error during initialization:', error);
            }

            // Load saved API key - try multiple sources
            let savedAPIKey = localStorage.getItem('telynxAPIKey') || localStorage.getItem('apiKey');
            if (!savedAPIKey) {
                const apiSettings = localStorage.getItem('apiSettings');
                if (apiSettings) {
                    try {
                        const settings = JSON.parse(apiSettings);
                        savedAPIKey = settings.apiKey;
                    } catch (e) { }
                }
            }

            if (savedAPIKey) {
                const apiKeyField = document.getElementById('apiKey');
                if (apiKeyField) {
                    apiKeyField.value = savedAPIKey;
                }
                telynxAPIKey = savedAPIKey;
                console.log('✅ API key loaded on page load:', savedAPIKey.substring(0, 10) + '...');
                fetchTelynxPhoneNumbers();
            }

            // Webhook URL is now handled by the API Settings section

            // Load incoming messages from webhook server
            loadIncomingMessages();

            // Auto-refresh incoming messages every 30 seconds
            setInterval(loadIncomingMessages, 30000);

            // Initialize advanced features
            updateSMSHistoryUI();

            // Load saved business name
            const savedBusinessName = localStorage.getItem('selectedBusinessName');
            if (savedBusinessName) {
                updateBusinessNameDisplay(savedBusinessName);
            }

            // Robust sent messages loading with multiple attempts
            const loadSentMessagesRobust = () => {
                let attempts = 0;
                const maxAttempts = 10;

                const tryLoad = () => {
                    attempts++;
                    console.log(`🔄 Loading sent messages (attempt ${attempts}/${maxAttempts})...`);

                    const container = document.getElementById('sentMessagesList');
                    const sentMessages = JSON.parse(localStorage.getItem('sentMessages') || '[]');

                    console.log(`📤 Container found: ${!!container}, Messages in storage: ${sentMessages.length}`);

                    if (container) {
                        updateSentMessagesUI();

                        // Verify the update worked
                        setTimeout(() => {
                            const stillEmpty = container.innerHTML.includes('No sent messages yet');
                            if (stillEmpty && sentMessages.length > 0 && attempts < maxAttempts) {
                                console.log('⚠️ Messages not loaded, retrying...');
                                setTimeout(tryLoad, 200);
                            } else if (sentMessages.length > 0) {
                                console.log('✅ Sent messages loaded successfully');
                            }
                        }, 100);
                    } else if (attempts < maxAttempts) {
                        console.log('❌ Container not found, retrying...');
                        setTimeout(tryLoad, 200);
                    } else {
                        console.log('❌ Failed to load sent messages after all attempts');
                    }
                };

                tryLoad();
            };

            loadSentMessagesRobust();

            // Load incoming messages
            updateIncomingMessagesUI();

            // BULLETPROOF API SETTINGS INITIALIZATION
            function initializeAPISettings() {
                console.log('🚀 Initializing API settings...');

                // Load settings immediately
                loadAPISettings();

                // Webhook URL loading is now handled by the new API Settings section

                // Keep trying to load settings until successful
                let attempts = 0;
                const maxAttempts = 20;

                const loadInterval = setInterval(() => {
                    attempts++;
                    console.log(`🔄 Load attempt ${attempts}/${maxAttempts}...`);

                    const apiKeyField = document.getElementById('apiSettingsKey');
                    const savedKey = localStorage.getItem('telynxAPIKey') || localStorage.getItem('apiKey');

                    if (apiKeyField && savedKey && apiKeyField.value !== savedKey) {
                        console.log('✅ Found saved key, loading...');
                        loadAPISettings();
                    }

                    // Webhook loading handled by new system

                    if (attempts >= maxAttempts) {
                        console.log('🛑 Max attempts reached');
                        clearInterval(loadInterval);
                    }
                }, 200);
            }



            // IMMEDIATE WEBHOOK RESTORATION - Runs as soon as possible
            (function () {
                const restoreWebhook = () => {
                    const webhookField = document.getElementById('apiSettingsWebhook');
                    const savedWebhook = localStorage.getItem('telynxWebhookUrl');
                    if (webhookField && savedWebhook) {
                        webhookField.value = savedWebhook;
                        console.log('🚀 IMMEDIATE webhook restore:', savedWebhook);
                    }
                };

                // Try immediately
                restoreWebhook();

                // Try every 100ms for the first 2 seconds
                for (let i = 1; i <= 20; i++) {
                    setTimeout(restoreWebhook, i * 100);
                }
            })();

            // WEBHOOK DIAGNOSTIC AND GUARDIAN
            let diagnosticRun = false;
            setInterval(function () {
                const field = document.getElementById('apiSettingsWebhook');
                const saved = localStorage.getItem('telynxWebhookUrl');
                const status = document.getElementById('webhookStatus');

                // Run diagnostic once
                if (!diagnosticRun && field) {
                    diagnosticRun = true;
                    console.log('🔍 WEBHOOK DIAGNOSTIC:');
                    console.log('  Field exists:', !!field);
                    console.log('  Field value:', field.value);
                    console.log('  Saved in localStorage:', saved);
                    console.log('  Field ID:', field.id);
                    console.log('  Field type:', field.type);

                    if (status) {
                        status.innerHTML = '🔍 Diagnostic: Field=' + (field.value || 'EMPTY') + ', Saved=' + (saved || 'NONE');
                    }
                }

                // Guardian restoration
                if (field && saved && field.value !== saved) {
                    field.value = saved;
                    console.log('🛡️ Guardian restored webhook URL:', saved);
                    if (status) {
                        status.textContent = '🛡️ Restored: ' + saved;
                        status.style.color = '#f59e0b';
                    }
                }
            }, 1000);

            // Call initialization when page loads
            document.addEventListener('DOMContentLoaded', initializeAPISettings);
            window.addEventListener('load', initializeAPISettings);

            // Debug function - call this from browser console to test
            window.debugAPISettings = function () {
                console.log('=== DEBUG API SETTINGS ===');
                console.log('localStorage telynxAPIKey:', localStorage.getItem('telynxAPIKey'));
                console.log('localStorage apiKey:', localStorage.getItem('apiKey'));
                console.log('localStorage apiSettings:', localStorage.getItem('apiSettings'));
                console.log('Form field value:', document.getElementById('apiSettingsKey')?.value);
                console.log('Global variable window.telynxAPIKey:', window.telynxAPIKey);
                console.log('Main variable telynxAPIKey:', telynxAPIKey);
                console.log('=== END DEBUG ===');
            };

            // Debug function to test SMS sending
            window.testSMSReady = function () {
                console.log('=== SMS READINESS TEST ===');
                console.log('telynxAPIKey variable:', telynxAPIKey ? telynxAPIKey.substring(0, 10) + '...' : 'NOT SET');
                console.log('Can send SMS:', !!telynxAPIKey);
                console.log('Available phone numbers:', telynxPhoneNumbers);
                console.log('Selected from number:', window.selectedFromNumber);
                console.log('Default from number:', telynxPhoneNumbers[0] ? telynxPhoneNumbers[0].phone_number : 'NONE');
                console.log('=== END TEST ===');
            };

            // Debug function to check phone number format
            window.debugPhoneNumbers = function () {
                console.log('=== PHONE NUMBER DEBUG ===');
                console.log('Raw phone numbers array:', telynxPhoneNumbers);
                if (telynxPhoneNumbers.length > 0) {
                    telynxPhoneNumbers.forEach((num, index) => {
                        console.log(`Phone ${index + 1}:`, num);
                        console.log(`  - phone_number:`, num.phone_number);
                        console.log(`  - status:`, num.status);
                        console.log(`  - messaging_profile_id:`, num.messaging_profile_id);
                    });
                }
                console.log('Selected from number:', window.selectedFromNumber);
                console.log('=== END DEBUG ===');
            };

            // Debug function to check sent messages
            window.debugSentMessages = function () {
                console.log('=== SENT MESSAGES DEBUG ===');
                const sentMessages = JSON.parse(localStorage.getItem('sentMessages') || '[]');
                console.log('Sent messages in localStorage:', sentMessages);
                console.log('Number of sent messages:', sentMessages.length);
                const container = document.getElementById('sentMessagesList');
                console.log('Container found:', !!container);
                if (container) {
                    console.log('Container content:', container.innerHTML.substring(0, 100) + '...');
                }
                console.log('=== END DEBUG ===');

                // Force refresh
                updateSentMessagesUI();
            };

            // Comprehensive diagnostic function
            window.diagnosticCheck = function () {
                console.log('=== COMPREHENSIVE DIAGNOSTIC CHECK ===');

                // Check basic DOM elements
                console.log('📋 DOM Elements:');
                console.log('  Message input:', !!document.getElementById('message'));
                console.log('  Phone input:', !!document.getElementById('phoneNumber'));
                console.log('  Char counter:', !!document.querySelector('.char-counter'));
                console.log('  Sent messages container:', !!document.getElementById('sentMessagesList'));

                // Check API settings
                console.log('🔑 API Settings:');
                console.log('  API Key variable:', telynxAPIKey ? telynxAPIKey.substring(0, 10) + '...' : 'NOT SET');
                console.log('  Phone numbers:', telynxPhoneNumbers.length);

                // Check localStorage
                console.log('💾 LocalStorage:');
                console.log('  Sent messages:', JSON.parse(localStorage.getItem('sentMessages') || '[]').length);
                console.log('  API key stored:', !!localStorage.getItem('telynxAPIKey'));

                // Check functions
                console.log('⚙️ Functions:');
                console.log('  sendSMS:', typeof sendSMS);
                console.log('  updateSentMessagesUI:', typeof updateSentMessagesUI);
                console.log('  testAPIConnection:', typeof testAPIConnection);

                console.log('=== END DIAGNOSTIC ===');
            };

            // Test localStorage function
            window.testLocalStorage = function () {
                const testKey = 'test_' + Date.now();
                const testValue = 'test_value_' + Date.now();

                try {
                    localStorage.setItem(testKey, testValue);
                    const readValue = localStorage.getItem(testKey);
                    localStorage.removeItem(testKey);

                    if (readValue === testValue) {
                        console.log('✅ localStorage is working');
                        return true;
                    } else {
                        console.log('❌ localStorage read/write failed');
                        return false;
                    }
                } catch (error) {
                    console.log('❌ localStorage error:', error);
                    return false;
                }
            };

            // Add event listeners for new features
            const advancedMessage = document.getElementById('advancedMessage');
            if (advancedMessage) {
                advancedMessage.addEventListener('input', updateAdvancedCharCounter);
            }



            const bulkMessageTemplate = document.getElementById('bulkMessageTemplate');
            if (bulkMessageTemplate) {
                bulkMessageTemplate.addEventListener('input', updateBulkCharCounter);
            }

            const dashboardMessage = document.getElementById('message');
            if (dashboardMessage) {
                dashboardMessage.addEventListener('input', updateDashboardCharCounter);
            }

            // Load dashboard timing settings immediately
            loadMinDelay();
            loadMaxDelay();

            // Also load with delay as backup
            setTimeout(() => {
                loadDashboardTimingSettings();
                console.log('=== BACKUP LOAD ATTEMPT ===');
            }, 100);

            // Load settings when page is fully loaded
            window.addEventListener('load', () => {
                loadAPISettings();

                // WEBHOOK URL PERSISTENCE GUARDIAN - Runs every few seconds to ensure webhook URL stays loaded
                setInterval(() => {
                    const webhookField = document.getElementById('apiSettingsWebhook');
                    const savedWebhook = localStorage.getItem('telynxWebhookUrl');

                    if (webhookField && savedWebhook && !webhookField.value) {
                        console.log('🛡️ Webhook URL guardian: Restoring lost webhook URL');
                        webhookField.value = savedWebhook;
                    }
                }, 3000);

                // Ensure sent messages are loaded after everything is ready
                setTimeout(() => {
                    console.log('🔄 Final sent messages load attempt...');

                    // Force load sent messages with verification
                    const sentMessages = JSON.parse(localStorage.getItem('sentMessages') || '[]');
                    console.log(`📤 Final check: ${sentMessages.length} messages in storage`);

                    if (sentMessages.length > 0) {
                        const container = document.getElementById('sentMessagesList');
                        if (container) {
                            console.log('📤 Container found, forcing update...');
                            updateSentMessagesUI();

                            // Double-check after update
                            setTimeout(() => {
                                if (container.innerHTML.includes('No sent messages yet')) {
                                    console.log('⚠️ Still showing empty, forcing HTML update...');
                                    // Force the HTML update directly
                                    let html = '';
                                    sentMessages.forEach(msg => {
                                        const time = new Date(msg.timestamp).toLocaleTimeString([], {
                                            hour: '2-digit',
                                            minute: '2-digit'
                                        });
                                        const date = new Date(msg.timestamp).toLocaleDateString();

                                        html += `
                                            <div style="padding: 0.75rem; border-bottom: 1px solid #f3f4f6; display: flex; justify-content: space-between; align-items: flex-start;">
                                                <div style="flex: 1;">
                                                    <div style="font-weight: 600; color: #374151; margin-bottom: 0.25rem;">${msg.phone}</div>
                                                    <div style="font-size: 0.9rem; color: #6b7280; margin-bottom: 0.25rem;">${msg.message}</div>
                                                    ${msg.businessName ? `<div style="font-size: 0.8rem; color: #059669; font-style: italic;">To: ${msg.businessName}</div>` : ''}
                                                </div>
                                                <div style="text-align: right; font-size: 0.8rem; color: #9ca3af;">
                                                    <div>${time}</div>
                                                    <div>${date}</div>
                                                </div>
                                            </div>
                                        `;
                                    });
                                    container.innerHTML = html;
                                    console.log('✅ Forced HTML update complete');
                                } else {
                                    console.log('✅ Messages loaded successfully');
                                }
                            }, 200);
                        } else {
                            console.log('❌ Container still not found');
                        }
                    }

                    updateIncomingMessagesUI();
                }, 1000);
            });

            // Test bulk buttons on load
            setTimeout(() => {
                testBulkButtons();
            }, 1000);

            // Add slider event listeners for timing settings
            const minDelay = document.getElementById('minDelay');
            const maxDelay = document.getElementById('maxDelay');
            const minDelayValue = document.getElementById('minDelayValue');
            const maxDelayValue = document.getElementById('maxDelayValue');

            if (minDelay && minDelayValue) {
                minDelay.addEventListener('input', function () {
                    minDelayValue.textContent = this.value + ' sec';
                });
            }

            if (maxDelay && maxDelayValue) {
                maxDelay.addEventListener('input', function () {
                    maxDelayValue.textContent = this.value + ' sec';
                });
            }
        });

        // Load incoming messages from webhook server
        async function loadIncomingMessages() {
            try {
                const response = await fetch('http://localhost:3000/api/messages');
                if (response.ok) {
                    const data = await response.json();
                    updateIncomingMessagesUI(data.messages);
                }
            } catch (error) {
                console.log('Webhook server not running or no messages yet');
            }
        }

        // Update incoming messages UI
        function updateIncomingMessagesUI(messages) {
            const messagesContainer = document.querySelector('.card:has(.message-item)');
            if (!messagesContainer) return;

            const messagesList = messagesContainer.querySelector('.card-title').nextElementSibling;
            if (!messagesList) return;

            // Clear existing messages
            const existingMessages = messagesList.querySelectorAll('.message-item');
            existingMessages.forEach(msg => msg.remove());

            // Add new messages
            messages.slice(0, 4).forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message-item';
                messageDiv.onclick = () => openChat(msg.from, msg.from);

                const time = new Date(msg.timestamp).toLocaleTimeString([], {
                    hour: '2-digit',
                    minute: '2-digit'
                });

                messageDiv.innerHTML = `
                    <div class="message-phone">${msg.from}</div>
                    <div class="message-preview">${msg.message}</div>
                    <div class="message-time">${time}</div>
                `;

                messagesList.appendChild(messageDiv);
            });
        }

        // Comprehensive test function to verify everything is working
        window.testApp = function () {
            console.log('=== COMPREHENSIVE APP TEST ===');

            // Test DOM elements
            console.log('📋 DOM Elements:');
            console.log('  Message input:', !!document.getElementById('message'));
            console.log('  Phone input:', !!document.getElementById('phoneNumber'));
            console.log('  Dashboard char counter:', !!document.getElementById('dashboardCharCounter'));

            // Test functions
            console.log('⚙️ Functions:');
            console.log('  sendSMS:', typeof sendSMS);
            console.log('  showSection:', typeof showSection);
            console.log('  testAPIConnection:', typeof testAPIConnection);
            console.log('  updateSentMessagesUI:', typeof updateSentMessagesUI);
            console.log('  saveAPISettings:', typeof saveAPISettings);

            // Test character counter
            const messageInput = document.getElementById('message');
            const charCounter = document.getElementById('dashboardCharCounter');
            if (messageInput && charCounter) {
                messageInput.value = 'Test';
                messageInput.dispatchEvent(new Event('input'));
                console.log('✅ Character counter test: Counter shows', charCounter.textContent);
                messageInput.value = '';
                messageInput.dispatchEvent(new Event('input'));
            }

            console.log('=== ALL SYSTEMS OPERATIONAL ===');
            alert('✅ App is fully working! All functions and features are operational.');
        };

        // Quick fix function to reinitialize everything
        window.fixApp = function () {
            console.log('🔧 Reinitializing app...');
            initCharCounter();
            updateSentMessagesUI();
            console.log('✅ App reinitialized');
            alert('✅ App has been reinitialized!');
        };
        
        // Set correct webhook URL on page load
        document.addEventListener('DOMContentLoaded', function() {
            localStorage.setItem('telynxWebhookUrl', 'https://4c8bd6161f01.ngrok-free.app/webhook/sms');
            localStorage.setItem('webhookUrl', 'https://4c8bd6161f01.ngrok-free.app/webhook/sms');
            console.log('✅ Webhook URL set to: https://4c8bd6161f01.ngrok-free.app/webhook/sms');
        });
    </script>
</body>

</html>